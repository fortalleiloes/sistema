<!-- ============================================
     ðŸŽ macOS Toolbar (Barra Superior)
     ============================================ -->
<div class="macos-toolbar">
    <div class="macos-toolbar-left">
        <!-- Traffic Lights (BotÃµes de Controle) -->
        <% if (typeof showTrafficLights==='undefined' || showTrafficLights===true) { %>
            <div class="macos-traffic-lights">
                <div class="macos-traffic-light close"></div>
                <div class="macos-traffic-light minimize"></div>
                <div class="macos-traffic-light maximize"></div>
            </div>
            <% } %>

                <!-- TÃ­tulo da PÃ¡gina -->
                <!-- TÃ­tulo e SubtÃ­tulo -->
                <div
                    style="display: flex; flex-direction: column; justify-content: center; margin-left: <%= (typeof showTrafficLights === 'undefined' || showTrafficLights === true) ? '12px' : '0' %>;">
                    <h1 id="macosPageTitle" class="macos-window-title"
                        style="text-align: left; flex: none; margin: 0; <%= (typeof titleStyle !== 'undefined') ? titleStyle : '' %>">
                        <%= (typeof title !=='undefined' ) ? title : 'Fortal' %>
                    </h1>
                    <% if (typeof subtitle !=='undefined' && subtitle) { %>
                        <span
                            style="font-size: 11px; color: var(--macos-text-secondary); font-weight: 400; margin-top: 2px;">
                            <%= subtitle %>
                        </span>
                        <% } %>
                </div>

                <!-- ConteÃºdo Personalizado (ex: Agente IA Header) -->
                <% if (typeof customContent !=='undefined' && customContent) { %>
                    <%- customContent %>
                        <% } %>
    </div>

    <div class="macos-toolbar-center">
        <!-- Pode adicionar breadcrumbs ou navegaÃ§Ã£o aqui -->
    </div>

    <div class="macos-toolbar-right">
        <!-- BotÃ£o de Busca -->
        <button class="macos-btn macos-btn-secondary" style="padding: 6px 12px;">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
        </button>

        <!-- Apple-style Theme Toggle (iOS Switch) -->
        <label class="theme-toggle-ios" for="theme-toggle-checkbox">
            <input type="checkbox" id="theme-toggle-checkbox">
            <div class="toggle-track">
                <span class="toggle-icon sun"><i class="fa-solid fa-sun"></i></span>
                <span class="toggle-icon moon"><i class="fa-solid fa-moon"></i></span>
                <div class="toggle-thumb"></div>
            </div>
        </label>

        <!-- Profile Dropdown -->
        <div class="relative">
            <button id="macosProfileBtn" class="macos-btn macos-btn-secondary" style="padding: 6px 12px;">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
            </button>

            <!-- Profile Popup -->
            <div id="macosProfilePopup" class="macos-window"
                style="display: none; position: absolute; right: 0; top: calc(100% + 8px); width: 280px; z-index: 9999;">
                <div style="padding: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <% if (profile_pic_url) { %>
                            <img src="<%= profile_pic_url %>" alt="Foto de Perfil"
                                style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">
                            <% } else { %>
                                <div
                                    style="width: 48px; height: 48px; border-radius: 50%; background: var(--macos-bg-tertiary); display: flex; align-items: center; justify-content: center;">
                                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z">
                                        </path>
                                    </svg>
                                </div>
                                <% } %>
                                    <div>
                                        <p style="font-weight: 600; color: var(--macos-text-primary); font-size: 14px;">
                                            <%= username %>
                                        </p>
                                        <p style="font-size: 12px; color: var(--macos-text-secondary);">
                                            <%= email %>
                                        </p>
                                    </div>
                    </div>

                    <div class="macos-divider"></div>

                    <nav style="display: flex; flex-direction: column; gap: 4px;">
                        <a href="/perfil" class="macos-sidebar-item">
                            <span class="macos-sidebar-item-icon">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                            </span>
                            <span class="macos-sidebar-item-text">Meu Perfil</span>
                        </a>

                        <form id="macosLogoutForm" action="/logout" method="POST" style="width: 100%;">
                            <button type="submit" class="macos-sidebar-item"
                                style="width: 100%; border: none; background: none; cursor: pointer; color: var(--macos-red); text-align: left;">
                                <span class="macos-sidebar-item-icon">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                                        </path>
                                    </svg>
                                </span>
                                <span class="macos-sidebar-item-text">Sair</span>
                            </button>
                        </form>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>



<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm';
    const SUPABASE_URL = <%= JSON.stringify(supabaseUrl || '') %>;
    const SUPABASE_ANON_KEY = <%= JSON.stringify(supabaseAnonKey || '') %>;

    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. MACOS TOOLBAR PROFILE BUTTON ---
        const macosProfileBtn = document.getElementById('macosProfileBtn');
        const macosProfilePopup = document.getElementById('macosProfilePopup');

        if (macosProfileBtn && macosProfilePopup) {
            macosProfileBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                // Toggle display logic
                const isHidden = macosProfilePopup.style.display === 'none' || macosProfilePopup.style.display === '';
                macosProfilePopup.style.display = isHidden ? 'block' : 'none';
            });

            // Click outside to close
            document.addEventListener('click', (e) => {
                if (macosProfilePopup.style.display === 'block' &&
                    !macosProfilePopup.contains(e.target) &&
                    !macosProfileBtn.contains(e.target)) {
                    macosProfilePopup.style.display = 'none';
                }
            });
        }



        // --- 3. LOGOUT LOGIC (SHARED) ---
        if (SUPABASE_URL && SUPABASE_ANON_KEY) {
            const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            const handleLogout = async (e) => {
                e.preventDefault();
                try {
                    await supabase.auth.signOut();
                } catch (err) {
                    console.error('Erro logout Supabase:', err);
                } finally {
                    // Always try to hit the server logout
                    await fetch('/logout', { method: 'POST' });
                    window.location.href = '/login';
                }
            };

            const logoutForm = document.getElementById('logoutForm');
            if (logoutForm) logoutForm.addEventListener('submit', handleLogout);

            const macosLogoutForm = document.getElementById('macosLogoutForm');
            if (macosLogoutForm) macosLogoutForm.addEventListener('submit', handleLogout);
        }
    });
</script>