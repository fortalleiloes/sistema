<!DOCTYPE html>
<html lang="pt-BR" class="light">

<head>
  <%- include('partials/head') %>
    <title>Gerenciar Convites | Arremata!</title>
</head>

<body class="macos-bg-primary">

  <!-- Sidebar -->
  <%- include('partials/macos-sidebar') %>

    <!-- Toolbar -->
    <%- include('partials/macos-toolbar', { title: 'Gerenciar Convites' }) %>

      <!-- Main Content -->
      <main class="macos-main-content">
        <div class="container mx-auto max-w-6xl">

          <!-- Header da Página -->
          <div class="flex items-center justify-between mb-8">
            <div>
              <h1 class="text-3xl font-bold mb-2 text-[var(--macos-text-primary)]">Convites do Sistema</h1>
              <p class="text-[var(--macos-text-secondary)]">Gerencie o acesso de novos usuários ao sistema.</p>
            </div>
            <!-- Botão que abre o Modal -->
            <button onclick="document.getElementById('modalNovoConvite').style.display = 'flex'"
              class="macos-btn macos-btn-primary">
              <i class="fa-solid fa-plus mr-2"></i> Novo Convite
            </button>
          </div>

          <!-- Tabela de Convites -->
          <div class="macos-card overflow-hidden p-0">
            <div class="overflow-x-auto">
              <table class="w-full text-left border-collapse">
                <thead>
                  <tr class="border-b border-[var(--macos-divider)] bg-[var(--macos-bg-tertiary)]">
                    <th class="p-4 text-xs font-semibold uppercase text-[var(--macos-text-secondary)]">Email</th>
                    <th class="p-4 text-xs font-semibold uppercase text-[var(--macos-text-secondary)]">Link de Convite
                    </th>
                    <th class="p-4 text-xs font-semibold uppercase text-[var(--macos-text-secondary)]">Status</th>
                    <th class="p-4 text-xs font-semibold uppercase text-[var(--macos-text-secondary)]">Expira em</th>
                    <th class="p-4 text-xs font-semibold uppercase text-[var(--macos-text-secondary)]">Criado em</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-[var(--macos-divider)]">
                  <% if (invites && invites.length> 0) { %>
                    <% invites.forEach(inv=> { %>
                      <tr class="hover:bg-[var(--macos-bg-tertiary)] transition-colors">
                        <td class="p-4 font-medium text-[var(--macos-text-primary)]">
                          <%= inv.email %>
                        </td>
                        <td class="p-4">
                          <div class="flex items-center gap-2">
                            <%= `${baseUrl}/invite/accept?token=${inv.token}` %>
                              </code>
                              <button
                                onclick="navigator.clipboard.writeText(this.previousElementSibling.innerText); alert('Link copiado!')"
                                class="text-[var(--macos-text-secondary)] hover:text-[var(--macos-accent)] transition-colors"
                                title="Copiar Link">
                                <i class="fa-regular fa-copy"></i>
                              </button>
                          </div>
                        </td>
                        <td class="p-4">
                          <% if (inv.used) { %>
                            <span class="macos-badge macos-badge-success">Utilizado</span>
                            <% } else { %>
                              <span class="macos-badge macos-badge-warning">Pendente</span>
                              <% } %>
                        </td>
                        <td class="p-4 text-sm text-[var(--macos-text-secondary)]">
                          <%= inv.expires_at ? new Date(inv.expires_at).toLocaleDateString() : '-' %>
                        </td>
                        <td class="p-4 text-sm text-[var(--macos-text-secondary)]">
                          <%= new Date(inv.created_at).toLocaleDateString() %>
                        </td>
                      </tr>
                      <% }) %>
                        <% } else { %>
                          <tr>
                            <td colspan="5" class="p-12 text-center text-[var(--macos-text-secondary)]">
                              <div class="flex flex-col items-center justify-center">
                                <div
                                  class="w-16 h-16 bg-[var(--macos-bg-tertiary)] rounded-full flex items-center justify-center mb-4">
                                  <i class="fa-regular fa-paper-plane text-2xl opacity-50"></i>
                                </div>
                                <p class="font-medium">Nenhum convite encontrado</p>
                                <p class="text-sm opacity-70 mt-1">Clique em "Novo Convite" para começar.</p>
                              </div>
                            </td>
                          </tr>
                          <% } %>
                </tbody>
              </table>
            </div>
          </div>

        </div>
      </main>

      <!-- Modal Novo Convite -->
      <div id="modalNovoConvite" class="macos-modal-overlay" style="display: none;">
        <div class="macos-modal w-[400px]">
          <div class="macos-modal-header">
            <h3 class="macos-modal-title">Novo Convite</h3>
            <button onclick="document.getElementById('modalNovoConvite').style.display = 'none'"
              class="macos-modal-close">
              <i class="fa-solid fa-times text-sm text-[var(--macos-text-secondary)]"></i>
            </button>
          </div>

          <form action="/admin/invites" method="POST" class="p-0">
            <div class="macos-modal-body">
              <p class="text-sm text-[var(--macos-text-secondary)] mb-4">
                Gere um link de convite para enviar manualmente ao assessor. O link expira em 7 dias.
              </p>

              <div class="macos-form-group">
                <label class="macos-form-label">Nome ou E-mail (Identificação)</label>
                <input type="text" name="email" required placeholder="Ex: Assessor João" class="macos-input" autofocus>
              </div>
            </div>

            <div class="macos-modal-footer bg-[var(--macos-bg-tertiary)] bg-opacity-30">
              <button type="button" onclick="document.getElementById('modalNovoConvite').style.display = 'none'"
                class="macos-btn macos-btn-secondary">Cancelar</button>
              <button type="submit" class="macos-btn macos-btn-primary">
                <i class="fa-solid fa-link mr-2"></i> Gerar Link
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Script para fechar modal com ESC -->
      <script>
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            document.getElementById('modalNovoConvite').style.display = 'none';
          }
        });
      </script>

      <%- include('partials/theme-script') %>
</body>

</html>