<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <title>Fortal - Dashboard</title>
    <%- include('partials/head') %>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <style>
            /* Classes utilitárias baseadas nas variáveis CSS do tema para garantir consistência */
            .color-primary {
                color: var(--macos-text-primary);
            }

            .color-secondary {
                color: var(--macos-text-secondary);
            }

            .bg-card {
                background-color: var(--macos-glass-bg);
                border: 1px solid var(--macos-glass-border);
            }

            .bg-sidebar {
                background-color: var(--macos-bg-sidebar);
            }

            /* Ajustes específicos para cartões de KPI */
            .kpi-card {
                background-color: var(--macos-glass-bg);
                border: 1px solid var(--macos-glass-border);
                border-radius: var(--macos-radius-lg);
                padding: 20px;
                transition: all 0.2s ease;
            }

            .kpi-card:hover {
                background-color: var(--macos-bg-secondary);
                border-color: var(--macos-border);
                transform: translateY(-2px);
            }
        </style>
</head>

<body class="min-h-screen page-home">

    <%- include('partials/macos-toolbar', { title: 'Dashboard' , username: username, profile_pic_url: profile_pic_url })
        %>
        <%- include('partials/macos-sidebar', { user: user }) %>

            <main class="macos-main-content">
                <div class="animate-fade-in" style="padding-bottom: 40px; max-width: 1400px; margin: 0 auto;">

                    <!-- Header Section -->
                    <div class="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-4">
                        <div>
                            <h1 class="text-3xl font-bold mb-2" style="color: var(--macos-text-primary);">
                                Visão Geral
                            </h1>
                            <p style="color: var(--macos-text-secondary);">
                                Acompanhe o desempenho da sua carteira e novas oportunidades.
                            </p>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-sm font-medium px-3 py-1 rounded-full"
                                style="background-color: var(--macos-bg-tertiary); color: var(--macos-text-secondary);">
                                <%= new Date().toLocaleDateString('pt-BR', { month: 'long' , year: 'numeric' }) %>
                            </span>
                            <a href="/calculadora"
                                class="macos-btn-primary text-sm px-4 py-2 hover:opacity-90 border-none shadow-lg text-white"
                                style="background-color: var(--macos-accent); color: white;">
                                <i class="fa-solid fa-plus mr-2"></i> Nova Simulação
                            </a>
                        </div>
                    </div>

                    <% if (stats) { %>
                        <!-- KPI Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-6 mb-8">

                            <!-- KPI 1: VGV -->
                            <div class="kpi-card group relative overflow-hidden">
                                <div class="absolute right-0 top-0 p-4 opacity-10 transition-opacity">
                                    <i class="fa-solid fa-briefcase text-6xl text-yellow-500"></i>
                                </div>
                                <div class="relative z-10">
                                    <p class="text-xs font-bold uppercase tracking-wider mb-2"
                                        style="color: var(--macos-text-secondary);">VGV sob Gestão</p>
                                    <h3 class="text-2xl font-bold mb-1" style="color: var(--macos-text-primary);">
                                        <%= Number(stats.vgv_gestao || 0).toLocaleString('pt-BR', { style: 'currency' ,
                                            currency: 'BRL' }) %>
                                    </h3>
                                    <div class="flex items-center text-xs font-medium text-green-500">
                                        <i class="fa-solid fa-arrow-up mr-1"></i>
                                        <span>Ativo na Carteira</span>
                                    </div>
                                </div>
                            </div>

                            <!-- KPI 2: Comissão -->
                            <div class="kpi-card group relative overflow-hidden">
                                <div class="absolute right-0 top-0 p-4 opacity-10 transition-opacity">
                                    <i class="fa-solid fa-sack-dollar text-6xl text-green-500"></i>
                                </div>
                                <div class="relative z-10">
                                    <p class="text-xs font-bold uppercase tracking-wider mb-2"
                                        style="color: var(--macos-text-secondary);">Comissão Estimada</p>
                                    <h3 class="text-2xl font-bold mb-1" style="color: var(--macos-text-primary);">
                                        <%= Number(stats.comissao_prevista || 0).toLocaleString('pt-BR', {
                                            style: 'currency' , currency: 'BRL' }) %>
                                    </h3>
                                    <div class="flex items-center text-xs text-gray-400">
                                        <span>Projeção atual</span>
                                    </div>
                                </div>
                            </div>

                            <!-- KPI 3: Leads -->
                            <div class="kpi-card group relative overflow-hidden cursor-pointer"
                                onclick="window.location.href='/leads'">
                                <div class="absolute right-0 top-0 p-4 opacity-10 transition-opacity">
                                    <i class="fa-solid fa-fire text-6xl text-orange-500"></i>
                                </div>
                                <div class="relative z-10">
                                    <p class="text-xs font-bold uppercase tracking-wider mb-2"
                                        style="color: var(--macos-text-secondary);">Novos Leads</p>
                                    <h3 class="text-2xl font-bold mb-1" style="color: var(--macos-text-primary);">
                                        <%= stats.leads_waiting %>
                                    </h3>
                                    <% if (stats.leads_waiting> 0) { %>
                                        <div class="flex items-center text-xs text-orange-500 font-bold animate-pulse">
                                            <i class="fa-solid fa-circle-exclamation mr-1"></i>
                                            <span>Aguardando Ação</span>
                                        </div>
                                        <% } else { %>
                                            <div class="flex items-center text-xs text-green-500">
                                                <i class="fa-solid fa-check mr-1"></i>
                                                <span>Tudo em dia</span>
                                            </div>
                                            <% } %>
                                </div>
                            </div>

                            <!-- KPI 4: Imóveis -->
                            <div class="kpi-card group relative overflow-hidden">
                                <div class="absolute right-0 top-0 p-4 opacity-10 transition-opacity">
                                    <i class="fa-solid fa-building text-6xl text-blue-500"></i>
                                </div>
                                <div class="relative z-10">
                                    <p class="text-xs font-bold uppercase tracking-wider mb-2"
                                        style="color: var(--macos-text-secondary);">Total Imóveis</p>
                                    <h3 class="text-2xl font-bold mb-1" style="color: var(--macos-text-primary);">
                                        <%= stats.total_imoveis || 0 %>
                                    </h3>
                                    <div class="flex items-center text-xs text-blue-500">
                                        <span>Gestão Ativa</span>
                                    </div>
                                </div>
                            </div>

                            <!-- KPI 5: Blacklist (Novo) -->
                            <div class="kpi-card group relative overflow-hidden"
                                title="Leads duplicados (mesmo telefone) filtrados automaticamente da contagem principal.">
                                <div class="absolute right-0 top-0 p-4 opacity-10 transition-opacity">
                                    <i class="fa-solid fa-user-shield text-6xl text-red-500"></i>
                                </div>
                                <div class="relative z-10">
                                    <p class="text-xs font-bold uppercase tracking-wider mb-2"
                                        style="color: var(--macos-text-secondary);">Blacklist / Duplicados</p>
                                    <h3 class="text-2xl font-bold mb-1" style="color: var(--macos-text-primary);">
                                        <%= stats.blacklist_count || 0 %>
                                    </h3>
                                    <div class="flex items-center text-xs text-red-500 font-medium whitespace-nowrap">
                                        <i class="fa-solid fa-filter mr-1"></i>
                                        <span>Retido: <%= Number(stats.blacklist_value || 0).toLocaleString('pt-BR', {
                                                style: 'currency' , currency: 'BRL' }) %></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <% } %>

                            <!-- Middle Section: Chart & Actions -->
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                                <!-- Evolution Chart -->
                                <div class="lg:col-span-2 kpi-card">
                                    <div class="flex items-center justify-between mb-6">
                                        <h2 class="text-lg font-bold" style="color: var(--macos-text-primary);">Evolução
                                            do VGV</h2>
                                        <span class="text-xs" style="color: var(--macos-text-secondary);">Últimos 6
                                            meses</span>
                                    </div>
                                    <div class="w-full h-[300px]">
                                        <canvas id="performanceChart"></canvas>
                                    </div>
                                </div>

                                <!-- Quick Actions / Mini Feed -->
                                <div class="lg:col-span-1 flex flex-col gap-6">
                                    <!-- Quick Actions -->
                                    <div class="kpi-card">
                                        <h3 class="text-lg font-bold mb-4" style="color: var(--macos-text-primary);">
                                            Ações Rápidas</h3>
                                        <div class="space-y-3">
                                            <a href="/calculadora"
                                                class="flex items-center p-3 rounded-lg transition-colors cursor-pointer group hover:bg-opacity-50"
                                                style="background-color: var(--macos-bg-tertiary); border: 1px solid var(--macos-border);">
                                                <div
                                                    class="w-8 h-8 rounded bg-yellow-500 flex items-center justify-center text-gray-900 mr-3 group-hover:scale-110 transition-transform">
                                                    <i class="fa-solid fa-calculator"></i>
                                                </div>
                                                <span class="font-medium text-sm"
                                                    style="color: var(--macos-text-primary);">Simular Arremate</span>
                                            </a>
                                            <a href="/leads"
                                                class="flex items-center p-3 rounded-lg transition-colors cursor-pointer group hover:bg-opacity-50"
                                                style="background-color: var(--macos-bg-tertiary); border: 1px solid var(--macos-border);">
                                                <div
                                                    class="w-8 h-8 rounded bg-blue-500 flex items-center justify-center text-white mr-3 group-hover:scale-110 transition-transform">
                                                    <i class="fa-solid fa-users"></i>
                                                </div>
                                                <span class="font-medium text-sm"
                                                    style="color: var(--macos-text-primary);">Ver Oportunidades</span>
                                            </a>
                                            <a href="/carteira"
                                                class="flex items-center p-3 rounded-lg transition-colors cursor-pointer group hover:bg-opacity-50"
                                                style="background-color: var(--macos-bg-tertiary); border: 1px solid var(--macos-border);">
                                                <div
                                                    class="w-8 h-8 rounded bg-green-500 flex items-center justify-center text-white mr-3 group-hover:scale-110 transition-transform">
                                                    <i class="fa-solid fa-file-contract"></i>
                                                </div>
                                                <span class="font-medium text-sm"
                                                    style="color: var(--macos-text-primary);">Gerar Proposta</span>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Properties List -->
                            <div class="kpi-card p-0 overflow-hidden">
                                <div class="p-6 border-b flex justify-between items-center"
                                    style="border-color: var(--macos-divider);">
                                    <h2 class="text-lg font-bold" style="color: var(--macos-text-primary);">Últimos
                                        Imóveis Adicionados</h2>
                                    <a href="/carteira" class="text-sm font-medium hover:underline"
                                        style="color: var(--macos-accent);">Ver todos</a>
                                </div>

                                <% if (recentProperties && recentProperties.length> 0) { %>
                                    <div class="divide-y" style="border-color: var(--macos-divider);">
                                        <% recentProperties.forEach(imovel=> { %>
                                            <div class="p-4 transition-colors flex items-center justify-between group cursor-pointer hover:bg-white/5"
                                                onclick="window.location.href='/carteira/<%= imovel.id %>'">
                                                <div class="flex items-center gap-4">
                                                    <div class="w-10 h-10 rounded-lg flex items-center justify-center"
                                                        style="background-color: var(--macos-bg-tertiary); color: var(--macos-text-secondary);">
                                                        <i class="fa-solid fa-house"></i>
                                                    </div>
                                                    <div>
                                                        <h4 class="text-sm font-bold transition-colors group-hover:text-blue-500"
                                                            style="color: var(--macos-text-primary);">
                                                            <%= imovel.descricao %>
                                                        </h4>
                                                        <p class="text-xs" style="color: var(--macos-text-secondary);">
                                                            <i class="fa-solid fa-location-dot mr-1"></i>
                                                            <%= imovel.endereco %>
                                                        </p>
                                                    </div>
                                                </div>
                                                <div class="text-right">
                                                    <p class="text-sm font-bold"
                                                        style="color: var(--macos-text-primary);">
                                                        <%= Number(imovel.total_investido || imovel.valor_compra ||
                                                            0).toLocaleString('pt-BR', { style: 'currency' ,
                                                            currency: 'BRL' }) %>
                                                    </p>
                                                    <span
                                                        class="inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase"
                                                        style="background-color: rgba(34, 197, 94, 0.2); color: #22c55e;">
                                                        <%= imovel.status || 'Ativo' %>
                                                    </span>
                                                </div>
                                            </div>
                                            <% }); %>
                                    </div>
                                    <% } else { %>
                                        <div class="p-8 text-center" style="color: var(--macos-text-secondary);">
                                            <i class="fa-solid fa-folder-open text-3xl mb-3"></i>
                                            <p class="text-sm">Nenhum imóvel recente encontrado.</p>
                                        </div>
                                        <% } %>
                            </div>

                </div>
            </main>

            <script src="/js/app.js"></script>

            <!-- Chart Script for Performance -->
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    const ctx = document.getElementById('performanceChart');
                    if (ctx) {
                        // Get colors from CSS variables
                        const style = getComputedStyle(document.body);
                        const colorPrimary = style.getPropertyValue('--macos-text-primary').trim();
                        const colorSecondary = style.getPropertyValue('--macos-text-secondary').trim();
                        const colorDivider = style.getPropertyValue('--macos-divider').trim();
                        const colorAccent = style.getPropertyValue('--macos-accent').trim();

                        const labels = ['Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                        const data = [0, 50000, 120000, 180000, 250000, <%= Number(stats ? (stats.vgv_gestao || 0) : 0) %>];

                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'VGV Acumulado',
                                    data: data,
                                    borderColor: colorAccent,
                                    backgroundColor: 'rgba(234, 179, 8, 0.1)',
                                    borderWidth: 3,
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 4,
                                    pointBackgroundColor: colorPrimary
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        grid: { color: colorDivider },
                                        ticks: {
                                            color: colorSecondary,
                                            callback: function (value) {
                                                return 'R$ ' + (value / 1000).toFixed(0) + 'k';
                                            }
                                        }
                                    },
                                    x: {
                                        grid: { display: false },
                                        ticks: { color: colorSecondary }
                                    }
                                }
                            }
                        });
                    }
                });
            </script>
</body>

</html>