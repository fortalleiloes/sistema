<!-- ============================================
     ðŸŽ macOS Toolbar (Barra Superior)
     ============================================ -->
<div class="macos-toolbar">
    <div class="macos-toolbar-left">
        <!-- Traffic Lights (BotÃµes de Controle) -->
        <div class="macos-traffic-lights">
            <div class="macos-traffic-light close"></div>
            <div class="macos-traffic-light minimize"></div>
            <div class="macos-traffic-light maximize"></div>
        </div>

        <!-- TÃ­tulo da PÃ¡gina -->
        <div style="display: flex; align-items: center; gap: 8px; margin-left: 12px;">
            <img src="/images/logo-fortal.png" alt="Logo" style="height: 24px; width: auto;">
            <h1 id="macosPageTitle" class="macos-window-title" style="text-align: left; flex: none; margin: 0;">
                <%= typeof title !=='undefined' ? title : 'Fortal' %>
            </h1>
        </div>
    </div>

    <div class="macos-toolbar-center">
        <!-- Barra de Busca (Opcional) -->
    </div>

    <div class="macos-toolbar-right">
        <!-- BotÃ£o de Busca -->
        <button class="macos-btn macos-btn-secondary" style="padding: 6px 12px;">
            <i class="fa-solid fa-search"></i>
        </button>

        <!-- Toggle Tema (Light/Dark) -->
        <label for="macos-theme-toggle" class="macos-btn macos-btn-secondary"
            style="padding: 6px 12px; cursor: pointer;">
            <input type="checkbox" id="macos-theme-toggle" style="display: none;">
            <i id="macos-theme-icon-dark" class="fa-solid fa-moon"></i>
            <i id="macos-theme-icon-light" class="fa-solid fa-sun" style="display: none;"></i>
        </label>

        <!-- Profile Dropdown -->
        <div class="relative">
            <button id="macosProfileBtn" class="macos-btn macos-btn-secondary" style="padding: 6px 12px;">
                <i class="fa-regular fa-user"></i>
            </button>

            <!-- Profile Popup -->
            <div id="macosProfilePopup" class="macos-window"
                style="display: none; position: absolute; right: 0; top: calc(100% + 8px); width: 280px; z-index: 9999;">
                <div style="padding: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <% if (typeof profile_pic_url !=='undefined' && profile_pic_url) { %>
                            <img src="<%= profile_pic_url %>" alt="Foto de Perfil"
                                style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">
                            <% } else { %>
                                <div
                                    style="width: 48px; height: 48px; border-radius: 50%; background: var(--macos-bg-tertiary); display: flex; align-items: center; justify-content: center;">
                                    <i class="fa-solid fa-user text-xl"></i>
                                </div>
                                <% } %>
                                    <div>
                                        <p style="font-weight: 600; color: var(--macos-text-primary); font-size: 14px;">
                                            <%= typeof username !=='undefined' ? username : 'UsuÃ¡rio' %>
                                        </p>
                                        <p style="font-size: 12px; color: var(--macos-text-secondary);">
                                            <%= typeof email !=='undefined' ? email : '' %>
                                        </p>
                                    </div>
                    </div>

                    <div class="macos-divider"></div>

                    <nav style="display: flex; flex-direction: column; gap: 4px;">
                        <a href="/perfil" class="macos-sidebar-item">
                            <span class="macos-sidebar-item-icon">
                                <i class="fa-regular fa-id-card"></i>
                            </span>
                            <span class="macos-sidebar-item-text">Meu Perfil</span>
                        </a>

                        <form id="macosLogoutForm" action="/logout" method="POST" style="width: 100%;">
                            <button type="submit" class="macos-sidebar-item"
                                style="width: 100%; border: none; background: none; cursor: pointer; color: var(--macos-red);">
                                <span class="macos-sidebar-item-icon">
                                    <i class="fa-solid fa-arrow-right-from-bracket"></i>
                                </span>
                                <span class="macos-sidebar-item-text">Sair</span>
                            </button>
                        </form>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm';
    const SUPABASE_URL = <%= JSON.stringify(typeof supabaseUrl !== 'undefined' ? supabaseUrl : '') %>;
    const SUPABASE_ANON_KEY = <%= JSON.stringify(typeof supabaseAnonKey !== 'undefined' ? supabaseAnonKey : '') %>;

    // Profile Popup Logic
    const macosProfileBtn = document.getElementById('macosProfileBtn');
    const macosProfilePopup = document.getElementById('macosProfilePopup');
    if (macosProfileBtn && macosProfilePopup) {
        macosProfileBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            macosProfilePopup.style.display = macosProfilePopup.style.display === 'none' ? 'block' : 'none';
        });

        document.addEventListener('click', (e) => {
            if (macosProfilePopup.style.display !== 'none' && !macosProfilePopup.contains(e.target) && !macosProfileBtn.contains(e.target)) {
                macosProfilePopup.style.display = 'none';
            }
        });
    }

    // Theme Toggle Logic
    const themeToggle = document.getElementById('macos-theme-toggle');
    const iconDark = document.getElementById('macos-theme-icon-dark');
    const iconLight = document.getElementById('macos-theme-icon-light');

    if (themeToggle && iconDark && iconLight) {
        // Carregar tema salvo
        const savedTheme = localStorage.getItem('theme') || 'dark';
        if (savedTheme === 'light') {
            document.documentElement.classList.add('light');
            themeToggle.checked = true;
            iconDark.style.display = 'none';
            iconLight.style.display = 'block';
        }

        themeToggle.addEventListener('change', () => {
            if (themeToggle.checked) {
                document.documentElement.classList.add('light');
                localStorage.setItem('theme', 'light');
                iconDark.style.display = 'none';
                iconLight.style.display = 'block';
            } else {
                document.documentElement.classList.remove('light');
                localStorage.setItem('theme', 'dark');
                iconDark.style.display = 'block';
                iconLight.style.display = 'none';
            }
        });
    }

    // Logout Logic
    if (SUPABASE_URL && SUPABASE_ANON_KEY) {
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const logoutForm = document.getElementById('macosLogoutForm');
        if (logoutForm) {
            logoutForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    await supabase.auth.signOut();
                } catch (err) {
                    console.error('Erro deslogando Supabase:', err);
                }
                await fetch('/logout', { method: 'POST' });
                window.location.href = '/login';
            });
        }
    }
</script>