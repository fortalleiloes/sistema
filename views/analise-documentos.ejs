<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <title>Análise de Documentos - Fortal</title>
    <%- include('partials/head') %>
        <style>
            .dropzone-area {
                border: 2px dashed var(--macos-divider);
                border-radius: 12px;
                padding: 32px;
                text-align: center;
                transition: all 0.2s;
                background: var(--macos-bg-tertiary);
                cursor: pointer;
                position: relative;
            }

            .dropzone-area:hover,
            .dropzone-area.dragover {
                border-color: var(--macos-accent);
                background: rgba(0, 122, 255, 0.05);
            }

            .dropzone-icon {
                font-size: 32px;
                color: var(--macos-text-secondary);
                margin-bottom: 12px;
            }

            .file-info {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px;
                background: var(--macos-bg-secondary);
                border: 1px solid var(--macos-divider);
                border-radius: 8px;
                margin-top: 12px;
            }

            .loading-overlay {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(255, 255, 255, 0.8);
                backdrop-filter: blur(4px);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 50;
                border-radius: 12px;
            }

            /* --- CLEAN DOCUMENT TYPOGRAPHY --- */
            .analysis-container {
                background: var(--macos-bg-secondary);
                border: 1px solid var(--macos-border);
                border-radius: 12px;
                padding: 40px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            }

            .markdown-content {
                color: var(--macos-text-primary);
                line-height: 1.8;
                /* Increased line-height */
                font-size: 16px;
            }

            .markdown-content h1,
            .markdown-content h2,
            .markdown-content h3 {
                color: var(--macos-text-primary);
                font-weight: 700;
                line-height: 1.3;
            }

            .markdown-content h1 {
                font-size: 2em;
                margin-top: 1.5em;
                /* Large top margin */
                margin-bottom: 1em;
                border-bottom: 2px solid var(--macos-accent);
                padding-bottom: 0.5em;
            }

            .markdown-content h2 {
                font-size: 1.5em;
                color: var(--macos-accent);
                /* Highlight headers */
                margin-top: 2.5em;
                /* Bigger separation between sections */
                margin-bottom: 1em;
                padding-top: 1em;
                border-top: 1px solid var(--macos-divider);
                /* Visual separator */
            }

            .markdown-content h3 {
                font-size: 1.2em;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                color: var(--macos-text-secondary);
                margin-top: 2em;
                margin-bottom: 0.8em;
            }

            .markdown-content p {
                margin-bottom: 1.5em;
                /* More space between paragraphs */
                color: var(--macos-text-secondary);
                text-align: justify;
                /* Cleaner look */
            }

            .markdown-content ul {
                list-style: none;
                padding-left: 0;
                margin-bottom: 2em;
            }

            .markdown-content li {
                position: relative;
                padding-left: 28px;
                margin-bottom: 12px;
                /* Increased item spacing */
                color: var(--macos-text-secondary);
            }

            .markdown-content li::before {
                content: '•';
                position: absolute;
                left: 8px;
                color: var(--macos-accent);
                font-weight: bold;
                font-size: 1.2em;
            }

            .markdown-content strong {
                color: var(--macos-text-primary);
                font-weight: 600;
            }

            /* Blockquotes for important highlights */
            .markdown-content blockquote {
                border-left: 4px solid var(--macos-accent);
                background: rgba(255, 159, 10, 0.1);
                /* Accent light bg */
                padding: 16px;
                border-radius: 0 8px 8px 0;
                margin: 1.5em 0;
                font-style: italic;
                color: var(--macos-text-primary);
            }

            /* Verdict Badges */
            .verdict-badge {
                display: inline-block;
                padding: 8px 16px;
                border-radius: 8px;
                font-weight: 800;
                font-size: 1.2rem;
                margin-bottom: 12px;
                text-transform: uppercase;
            }

            .verdict-safe {
                background: rgba(52, 199, 89, 0.15);
                color: #34C759;
                border: 1px solid rgba(52, 199, 89, 0.3);
            }

            .verdict-warning {
                background: rgba(255, 149, 0, 0.15);
                color: #FF9500;
                border: 1px solid rgba(255, 149, 0, 0.3);
            }

            .verdict-danger {
                background: rgba(255, 59, 48, 0.15);
                color: #FF3B30;
                border: 1px solid rgba(255, 59, 48, 0.3);
            }

            /* List Styling */
            .analysis-list {
                list-style: none;
                padding: 0;
            }

            .analysis-list li {
                position: relative;
                padding-left: 24px;
                margin-bottom: 12px;
                line-height: 1.5;
                font-size: 0.95rem;
                color: var(--macos-text-secondary);
            }

            .analysis-list li::before {
                content: '•';
                position: absolute;
                left: 6px;
                color: var(--macos-accent);
                font-weight: bold;
            }

            .analysis-list strong {
                color: var(--macos-text-primary);
                font-weight: 600;
            }
        </style>
</head>

<body class="min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
    <%- include('partials/macos-toolbar', { title: 'Análise de Documentos' }) %>
        <%- include('partials/macos-sidebar', { user: user }) %>

            <main class="macos-main-content">
                <div class="page-container" style="max-width: 1100px; margin: 0 auto; padding: 24px;">

                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h1 class="text-2xl font-bold dark:text-white">Análise Jurídica com IA</h1>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">Envie o Edital e a Matrícula para gerar
                                um parecer executivo simplificado.</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <!-- Edital Upload -->
                        <div class="analysis-card relative">
                            <h3 class="font-semibold mb-4 dark:text-white flex items-center gap-2">
                                <i class="fa-regular fa-file-pdf text-red-500"></i> 1. Edital do Leilão
                            </h3>
                            <div class="dropzone-area" id="dropzone-edital"
                                onclick="document.getElementById('file-edital').click()">
                                <i class="fa-solid fa-cloud-arrow-up dropzone-icon"></i>
                                <p class="text-sm text-gray-600 dark:text-gray-300">Clique ou arraste o Edital</p>
                                <input type="file" id="file-edital" class="hidden" accept=".pdf"
                                    onchange="handleFileSelect('edital', this)">
                            </div>
                            <div id="preview-edital" class="hidden"></div>
                        </div>

                        <!-- Matricula Upload -->
                        <div class="analysis-card relative">
                            <h3 class="font-semibold mb-4 dark:text-white flex items-center gap-2">
                                <i class="fa-regular fa-file-lines text-blue-500"></i> 2. Matrícula do Imóvel
                            </h3>
                            <div class="dropzone-area" id="dropzone-matricula"
                                onclick="document.getElementById('file-matricula').click()">
                                <i class="fa-solid fa-cloud-arrow-up dropzone-icon"></i>
                                <p class="text-sm text-gray-600 dark:text-gray-300">Clique ou arraste a Matrícula</p>
                                <input type="file" id="file-matricula" class="hidden" accept=".pdf"
                                    onchange="handleFileSelect('matricula', this)">
                            </div>
                            <div id="preview-matricula" class="hidden"></div>
                        </div>
                    </div>

                    <!-- Action Button -->
                    <div class="flex justify-center mb-10">
                        <button onclick="startAnalysis()" id="btn-analyze"
                            class="macos-btn-primary px-10 py-4 text-lg font-semibold flex items-center gap-3 opacity-50 cursor-not-allowed shadow-none transform transition-all duration-200"
                            disabled>
                            <i class="fa-solid fa-wand-magic-sparkles"></i>
                            Gerar Análise com IA
                        </button>
                    </div>

                    <!-- Results Section -->
                    <!-- Results Section -->
                    <div id="result-section" class="hidden animate-fade-in relative min-h-[200px]">

                        <!-- Header with Actions -->
                        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <h2 class="text-xl font-bold dark:text-white flex items-center gap-2">
                                <i class="fa-solid fa-scale-balanced text-blue-500"></i>
                                Parecer Jurídico
                            </h2>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="downloadPDF()"
                                    class="macos-btn-primary text-sm flex items-center gap-2">
                                    <i class="fa-solid fa-file-arrow-down"></i> Baixar PDF
                                </button>
                                <button onclick="window.print()"
                                    class="macos-btn-secondary text-sm flex items-center gap-2">
                                    <i class="fa-solid fa-print"></i> Imprimir
                                </button>
                                <button onclick="copyAnalysis()"
                                    class="macos-btn-secondary text-sm flex items-center gap-2">
                                    <i class="fa-regular fa-copy"></i> Copiar
                                </button>
                            </div>
                        </div>

                        <!-- Rendered Content Container -->
                        <div id="analysis-content" class="w-full analysis-container">
                            <!-- JS will inject markdown here -->
                        </div>

                        <!-- Loading Overlay -->
                        <div id="loading-overlay" class="loading-overlay hidden">
                            <div class="animate-spin rounded-full h-14 w-14 border-b-2 border-blue-600 mb-6"></div>
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Analisando Documentos...
                            </h3>
                            <p class="text-gray-500 dark:text-gray-400">A IA está lendo o Edital e a Matrícula para
                                identificar riscos.</p>
                        </div>
                    </div>

                </div>
            </main>

            <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
            <script>
                async function downloadPDF() {
                    const element = document.getElementById('analysis-content');
                    const btn = document.querySelector('button[onclick="downloadPDF()"]');
                    const originalText = btn.innerHTML;

                    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Gerando...';
                    btn.disabled = true;

                    const opt = {
                        margin: [15, 15, 15, 15], // top, left, bottom, right
                        filename: 'Parecer_Juridico_Imovel.pdf',
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                    };

                    try {
                        await html2pdf().set(opt).from(element).save();
                    } catch (err) {
                        console.error("Erro ao gerar PDF:", err);
                        alert("Erro ao gerar PDF.");
                    } finally {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                }

                const files = {
                    edital: null,
                    matricula: null
                };

                function handleFileSelect(type, input) {
                    if (input.files && input.files[0]) {
                        const file = input.files[0];
                        files[type] = file;

                        // Update UI
                        const dropzone = document.getElementById(`dropzone-${type}`);
                        const preview = document.getElementById(`preview-${type}`);

                        dropzone.classList.add('hidden');
                        preview.classList.remove('hidden');
                        preview.innerHTML = `
                    <div class="file-info animate-scale-in">
                        <i class="fa-solid fa-check-circle text-green-500 text-xl"></i>
                        <div class="flex-grow min-w-0">
                            <p class="font-medium truncate text-sm dark:text-white">${file.name}</p>
                            <p class="text-xs text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                        </div>
                        <button onclick="resetFile('${type}')" class="text-gray-400 hover:text-red-500 p-2">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                `;

                        checkForm();
                    }
                }

                function resetFile(type) {
                    files[type] = null;
                    document.getElementById(`file-${type}`).value = '';
                    document.getElementById(`dropzone-${type}`).classList.remove('hidden');
                    document.getElementById(`preview-${type}`).classList.add('hidden');
                    checkForm();
                }

                function checkForm() {
                    const btn = document.getElementById('btn-analyze');
                    if (files.edital && files.matricula) {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed', 'shadow-none');
                        btn.classList.add('shadow-xl', 'hover:scale-105');
                    } else {
                        btn.disabled = true;
                        btn.classList.add('opacity-50', 'cursor-not-allowed', 'shadow-none');
                        btn.classList.remove('shadow-xl', 'hover:scale-105');
                    }
                }

                async function startAnalysis() {
                    if (!files.edital || !files.matricula) return;

                    const resultSection = document.getElementById('result-section');
                    const loadingOverlay = document.getElementById('loading-overlay');
                    const analysisContent = document.getElementById('analysis-content');
                    const btn = document.getElementById('btn-analyze');

                    // Show loading state
                    resultSection.classList.remove('hidden');
                    loadingOverlay.classList.remove('hidden');
                    analysisContent.innerHTML = '';
                    btn.disabled = true;
                    btn.classList.add('opacity-50');

                    resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

                    const formData = new FormData();
                    formData.append('edital', files.edital);
                    formData.append('matricula', files.matricula);

                    try {
                        const response = await fetch('/api/analise-documentos/process', {
                            method: 'POST',
                            body: formData
                        });

                        const data = await response.json();

                        if (!response.ok) throw new Error(data.error || 'Erro na análise');

                        const markdownText = data.analysis || data.output || data.text || "Análise concluída, mas nenhum texto foi retornado.";

                        // Simple full rendering with better CSS
                        analysisContent.innerHTML = marked.parse(markdownText);

                    } catch (error) {
                        console.error(error);
                        analysisContent.innerHTML = `
                            <div class="p-6 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 rounded-xl flex items-center gap-4">
                                <i class="fa-solid fa-triangle-exclamation text-2xl"></i>
                                <div>
                                    <h3 class="font-bold text-lg">Erro na Análise</h3>
                                    <p>${error.message}</p>
                                </div>
                            </div>
                        `;
                    } finally {
                        loadingOverlay.classList.add('hidden');
                        btn.disabled = false;
                        btn.classList.remove('opacity-50');
                    }
                }

                function copyAnalysis() {
                    const content = document.getElementById('analysis-content').innerText;
                    navigator.clipboard.writeText(content).then(() => {
                        alert('Análise copiada!');
                    });
                }
            </script>
</body>

</html>