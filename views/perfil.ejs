<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <title>Ajustes de Perfil</title>
    <%- include('partials/head') %>
</head>

<body class="min-h-screen bg-[var(--bg-primary)] text-[var(--text-primary)]">

    <%- include('partials/macos-toolbar', { title: 'Ajustes de Perfil' , username: user.username, profile_pic_url:
        user.profile_pic_url }) %>
        <%- include('partials/macos-sidebar', { user: user }) %>

            <div class="p-4 md:p-8 ml-0 md:ml-64 mt-16 min-h-screen transition-all duration-300">
                <div class="max-w-3xl mx-auto">

                    <!-- Header Estilo macOS Settings -->
                    <div class="flex items-center gap-5 mb-8 animate-fade-in-up">
                        <div
                            class="w-20 h-20 rounded-2xl bg-gradient-to-br from-gray-400 to-gray-600 flex items-center justify-center shadow-lg shadow-gray-500/20">
                            <i class="fa-solid fa-user-gear text-4xl text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold tracking-tight">Ajustes de Perfil</h1>
                            <p class="text-[var(--text-secondary)] text-lg">Gerencie suas informações pessoais e
                                segurança.</p>
                        </div>
                    </div>

                    <% if (typeof error !=='undefined' && error==='new_password_length' ) { %>
                        <div
                            class="bg-red-500/10 border border-red-500/20 text-red-500 p-4 rounded-xl mb-6 flex items-center gap-3">
                            <i class="fa-solid fa-circle-exclamation"></i>
                            A nova senha deve ter pelo menos 6 caracteres.
                        </div>
                        <% } %>
                            <% if (typeof error !=='undefined' && error==='server' ) { %>
                                <div
                                    class="bg-red-500/10 border border-red-500/20 text-red-500 p-4 rounded-xl mb-6 flex items-center gap-3">
                                    <i class="fa-solid fa-circle-exclamation"></i>
                                    Ocorreu um erro no servidor. Tente novamente.
                                </div>
                                <% } %>
                                    <% if (typeof success !=='undefined' && success==='reset' ) { %>
                                        <div
                                            class="bg-green-500/10 border border-green-500/20 text-green-500 p-4 rounded-xl mb-6 flex items-center gap-3">
                                            <i class="fa-solid fa-check-circle"></i>
                                            Dados zerados com sucesso.
                                        </div>
                                        <% } %>
                                            <% if (typeof success !=='undefined' && success==='password_changed' ) { %>
                                                <div
                                                    class="bg-green-500/10 border border-green-500/20 text-green-500 p-4 rounded-xl mb-6 flex items-center gap-3">
                                                    <i class="fa-solid fa-check-circle"></i>
                                                    Senha alterada com sucesso!
                                                </div>
                                                <% } %>

                                                    <!-- Foto de Perfil -->
                                                    <div class="macos-card mb-6 animate-fade-in-up"
                                                        style="animation-delay: 0.1s;">
                                                        <h2
                                                            class="text-lg font-semibold mb-4 flex items-center gap-2 border-b border-[var(--macos-border)] pb-3">
                                                            <i
                                                                class="fa-solid fa-camera text-[var(--macos-accent)]"></i>
                                                            Foto
                                                            de Perfil
                                                        </h2>
                                                        <form action="/perfil/update-photo" method="POST"
                                                            enctype="multipart/form-data"
                                                            class="flex items-center gap-6">
                                                            <div class="relative group">
                                                                <% if (user.profile_pic_url) { %>
                                                                    <img src="<%= user.profile_pic_url %>"
                                                                        alt="Foto de Perfil"
                                                                        class="w-24 h-24 rounded-full object-cover shadow-md ring-4 ring-[var(--bg-secondary)]">
                                                                    <% } else { %>
                                                                        <div
                                                                            class="w-24 h-24 rounded-full bg-[var(--bg-tertiary)] flex items-center justify-center shadow-md ring-4 ring-[var(--bg-secondary)]">
                                                                            <i
                                                                                class="fa-solid fa-user text-4xl text-[var(--text-secondary)]"></i>
                                                                        </div>
                                                                        <% } %>
                                                                            <div
                                                                                class="absolute inset-0 bg-black/30 rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center cursor-pointer pointer-events-none">
                                                                                <i
                                                                                    class="fa-solid fa-pen text-white"></i>
                                                                            </div>
                                                            </div>

                                                            <div class="flex-grow">
                                                                <label class="macos-form-label">Alterar Foto</label>
                                                                <div class="flex gap-3 items-center">
                                                                    <input type="file" id="profilePhoto"
                                                                        name="profilePhoto" accept="image/*" required
                                                                        class="block w-full text-sm text-[var(--text-secondary)]
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-full file:border-0
                                file:text-sm file:font-semibold
                                file:bg-[var(--macos-accent)] file:text-white
                                hover:file:bg-[var(--macos-accent)]/90
                                cursor-pointer">
                                                                </div>
                                                                <p class="text-xs text-[var(--text-secondary)] mt-2">
                                                                    Recomendado: JPG ou PNG, max 5MB.</p>
                                                                <div class="mt-4 flex justify-end">
                                                                    <button type="submit"
                                                                        class="macos-btn-primary">Salvar
                                                                        Foto</button>
                                                                </div>
                                                            </div>
                                                        </form>
                                                    </div>

                                                    <!-- Informações Pessoais -->
                                                    <div class="macos-card mb-6 animate-fade-in-up"
                                                        style="animation-delay: 0.2s;">
                                                        <h2
                                                            class="text-lg font-semibold mb-4 flex items-center gap-2 border-b border-[var(--macos-border)] pb-3">
                                                            <i
                                                                class="fa-solid fa-id-card text-[var(--macos-accent)]"></i>
                                                            Informações Pessoais
                                                        </h2>
                                                        <form action="/perfil/update-info" method="POST">
                                                            <div class="macos-form-group">
                                                                <label for="username" class="macos-form-label">Nome de
                                                                    Usuário</label>
                                                                <input type="text" id="username" name="username"
                                                                    value="<%= user.username %>" required
                                                                    class="macos-input">
                                                            </div>
                                                            <div class="macos-form-group">
                                                                <label class="macos-form-label">Email</label>
                                                                <input type="email" value="<%= user.email %>" disabled
                                                                    class="macos-input opacity-60 cursor-not-allowed">
                                                                <p class="text-xs text-[var(--text-secondary)] mt-1">O
                                                                    email não
                                                                    pode ser alterado.</p>
                                                            </div>
                                                            <div class="flex justify-end mt-4">
                                                                <button type="submit" class="macos-btn-primary">Salvar
                                                                    Alterações</button>
                                                            </div>
                                                        </form>
                                                    </div>

                                                    <!-- Segurança -->
                                                    <div class="macos-card mb-6 animate-fade-in-up"
                                                        style="animation-delay: 0.3s;">
                                                        <h2
                                                            class="text-lg font-semibold mb-4 flex items-center gap-2 border-b border-[var(--macos-border)] pb-3">
                                                            <i class="fa-solid fa-lock text-[var(--macos-accent)]"></i>
                                                            Segurança
                                                        </h2>
                                                        <form id="change-password-form" action="/perfil/change-password"
                                                            method="POST">
                                                            <div class="macos-form-group">
                                                                <label for="newPassword" class="macos-form-label">Nova
                                                                    Senha</label>
                                                                <input type="password" id="newPassword"
                                                                    name="newPassword" required minlength="6"
                                                                    class="macos-input" placeholder="••••••••">
                                                            </div>
                                                            <div class="flex justify-end mt-4">
                                                                <button type="submit"
                                                                    class="macos-btn-secondary">Alterar
                                                                    Senha</button>
                                                            </div>
                                                        </form>
                                                    </div>

                                                    <!-- Zona de Perigo -->
                                                    <div class="macos-card border-red-500/30 bg-red-500/5 animate-fade-in-up"
                                                        style="animation-delay: 0.4s;">
                                                        <h2
                                                            class="text-lg font-semibold text-red-500 mb-4 flex items-center gap-2 border-b border-red-500/20 pb-3">
                                                            <i class="fa-solid fa-triangle-exclamation"></i> Zona de
                                                            Perigo
                                                        </h2>
                                                        <div
                                                            class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                                            <div>
                                                                <h3 class="font-semibold text-[var(--text-primary)]">
                                                                    Zerar Todos
                                                                    os Dados</h3>
                                                                <p class="text-sm text-[var(--text-secondary)] mt-1">
                                                                    Esta ação remove permanentemente todos os seus
                                                                    cálculos,
                                                                    arremates, imóveis e custos. Não pode ser desfeita.
                                                                </p>
                                                            </div>
                                                            <button id="reset-all-data-btn"
                                                                class="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white font-medium transition-colors shadow-sm whitespace-nowrap">
                                                                Zerar Dados...
                                                            </button>
                                                        </div>
                                                    </div>

                </div>
            </div>

            <!-- Modal de Confirmação (macOS Style) -->
            <div id="confirm-reset-modal"
                class="fixed inset-0 z-50 hidden items-center justify-center transition-opacity duration-300"
                style="background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px);">
                <div
                    class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-xl rounded-2xl shadow-2xl w-full max-w-md p-6 border border-white/20 transform scale-100 transition-all">
                    <div class="flex flex-col items-center text-center mb-6">
                        <div
                            class="w-16 h-16 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center mb-4">
                            <i class="fa-solid fa-triangle-exclamation text-3xl text-red-500"></i>
                        </div>
                        <h3 class="text-xl font-bold text-[var(--text-primary)]">Tem certeza absoluta?</h3>
                        <p class="text-[var(--text-secondary)] mt-2 text-sm">
                            Esta ação apagará <strong>todos</strong> os seus dados. Isso é irreversível.
                        </p>
                    </div>

                    <div class="bg-[var(--bg-tertiary)] rounded-xl p-4 mb-6 text-left">
                        <p class="text-xs font-bold text-[var(--text-secondary)] uppercase tracking-wider mb-2">O que
                            será apagado:</p>
                        <ul class="text-sm text-[var(--text-primary)] space-y-2">
                            <li class="flex items-center gap-2"><i class="fa-solid fa-xmark text-red-500"></i> Cálculos
                                de Viabilidade</li>
                            <li class="flex items-center gap-2"><i class="fa-solid fa-xmark text-red-500"></i> Histórico
                                de Arremates</li>
                            <li class="flex items-center gap-2"><i class="fa-solid fa-xmark text-red-500"></i> Carteira
                                de Imóveis</li>
                        </ul>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm text-[var(--text-secondary)] mb-2">Digite <strong
                                class="text-red-500">ZERAR</strong> para confirmar:</label>
                        <input type="text" id="confirm-text" placeholder="ZERAR"
                            class="macos-input text-center font-mono tracking-widest uppercase">
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <button id="cancel-reset-btn" class="macos-btn-secondary justify-center">Cancelar</button>
                        <button id="confirm-reset-btn"
                            class="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white font-bold transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                            Apagar Tudo
                        </button>
                    </div>
                </div>
            </div>

            <!-- Scripts -->
            <script type="module" id="app-script" data-username="<%= user.username %>" src="/js/app.js"></script>
            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    // Reset Data Logic
                    const resetBtn = document.getElementById('reset-all-data-btn');
                    const modal = document.getElementById('confirm-reset-modal');
                    const cancelBtn = document.getElementById('cancel-reset-btn');
                    const confirmBtn = document.getElementById('confirm-reset-btn');
                    const confirmText = document.getElementById('confirm-text');

                    if (resetBtn) {
                        resetBtn.addEventListener('click', () => {
                            modal.classList.remove('hidden');
                            modal.classList.add('flex');
                            confirmText.value = '';
                            confirmBtn.disabled = true;
                            setTimeout(() => confirmText.focus(), 100);
                        });

                        cancelBtn.addEventListener('click', () => {
                            modal.classList.add('hidden');
                            modal.classList.remove('flex');
                        });

                        confirmText.addEventListener('input', (e) => {
                            confirmBtn.disabled = e.target.value !== 'ZERAR';
                        });

                        confirmBtn.addEventListener('click', async () => {
                            confirmBtn.disabled = true;
                            confirmBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Apagando...';

                            try {
                                const response = await fetch('/perfil/reset-all-data', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' }
                                });
                                const result = await response.json();

                                if (result.success) {
                                    window.location.href = '/perfil?success=reset';
                                } else {
                                    alert('Erro: ' + (result.error || 'Erro desconhecido'));
                                    confirmBtn.disabled = false;
                                    confirmBtn.innerHTML = 'Apagar Tudo';
                                }
                            } catch (error) {
                                console.error('Erro:', error);
                                alert('Erro ao zerar dados.');
                                confirmBtn.disabled = false;
                                confirmBtn.innerHTML = 'Apagar Tudo';
                            }
                        });
                    }
                });
            </script>

            <!-- Supabase script removed -->
</body>

</html>