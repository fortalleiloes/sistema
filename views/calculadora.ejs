<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <title>Calculadora de Viabilidade - Fortal</title>
    <%- include('partials/head') %>
        <style>
            /* NUCLEAR FIX FOR RENDERING GLITCHES v2 */
            /* Forces the browser to render simply without complex GPU layering */
            * {
                -webkit-font-smoothing: antialiased;
            }

            .macos-card,
            .macos-card:hover,
            .macos-list-item,
            .macos-list-item:hover,
            .macos-btn,
            .macos-btn:hover,
            input,
            select,
            .macos-window,
            .macos-main-content {
                transform: none !important;
                transition: none !important;
                animation: none !important;
                backface-visibility: visible !important;
                -webkit-backface-visibility: visible !important;
                perspective: none !important;
                -webkit-perspective: none !important;
                will-change: auto !important;
                filter: none !important;
            }

            .macos-card:hover {
                /* Static shadow only */
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15) !important;
            }

            /* Force solid background to avoid alpha compositing issues */
            .macos-card {
                background-color: var(--macos-bg-secondary) !important;
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
                border: 1px solid var(--macos-divider) !important;
            }

            /* Disable all entry animations */
            .animate-fade-in,
            .animate-scale-in,
            .animate-slide-in-left {
                animation: none !important;
                opacity: 1 !important;
                transform: none !important;
            }

            /* Prevent white flash on modals */
            .macos-modal-overlay {
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
                background: rgba(0, 0, 0, 0.7) !important;
            }
        </style>
</head>

<body class="min-h-screen">

    <%- include('partials/macos-toolbar', { title: 'Calculadora' }) %>

        <%- include('partials/macos-sidebar', { user: user }) %>

            <main class="macos-main-content">
                <div class="animate-fade-in" style="padding-bottom: 40px; max-width: 1200px; margin: 0 auto;">

                    <!-- Subtítulo (Abaixo da linha do Header) -->
                    <div style="margin-bottom: 24px; padding-left: 4px;">
                        <p style="font-size: 16px; color: var(--macos-text-secondary); font-weight: 500;">Simule a
                            viabilidade dos seus arremates</p>
                    </div>

                    <!-- Feedback de Sucesso -->
                    <% if (locals.success==='saved' ) { %>
                        <div class="macos-card"
                            style="background: rgba(52, 199, 89, 0.1); border-color: var(--macos-success); padding: 16px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
                            <i class="fa-solid fa-check-circle"
                                style="color: var(--macos-success); font-size: 20px;"></i>
                            <div>
                                <h4 style="font-weight: 600; color: var(--macos-success); margin-bottom: 2px;">Cálculo
                                    Salvo!</h4>
                                <p style="font-size: 13px; color: var(--macos-text-primary);">Você pode acessá-lo no seu
                                    Histórico de Arremates.</p>
                            </div>
                        </div>
                        <% } %>

                            <!-- Banner: Modo de Edição -->
                            <% if (locals.editMode) { %>
                                <div class="macos-card"
                                    style="background: rgba(255, 214, 10, 0.1); border-color: var(--macos-accent); padding: 16px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
                                    <i class="fa-solid fa-pen-to-square"
                                        style="color: var(--macos-accent); font-size: 20px;"></i>
                                    <div style="flex: 1;">
                                        <h4 style="font-weight: 600; color: var(--macos-accent); margin-bottom: 2px;">
                                            Editando Cálculo
                                        </h4>
                                        <p style="font-size: 13px; color: var(--macos-text-primary);">
                                            Você está editando: <strong>
                                                <%= locals.editingName %>
                                            </strong>. Faça as alterações desejadas e clique em "Calcular Viabilidade".
                                        </p>
                                    </div>
                                    <a href="/calculadora" class="macos-btn-secondary" style="text-decoration: none;">
                                        <i class="fa-solid fa-times" style="margin-right: 6px;"></i>
                                        Cancelar Edição
                                    </a>
                                </div>
                                <% } %>

                                    <!-- Formulário Principal -->
                                    <form action="/calculadora" method="POST" id="calculatorForm"
                                        onsubmit="return validateAndSubmit(event)">

                                        <div
                                            style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">

                                            <!-- Coluna 1: Investimento -->
                                            <div class="macos-card" style="padding: 24px;">
                                                <div
                                                    style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                                                    <h2
                                                        style="font-size: 22px; font-weight: 600; color: var(--macos-text-primary);">
                                                        Investimento</h2>

                                                    <!-- Seletor de Pagamento (Segmented Control) -->
                                                    <div class="macos-segmented-control" style="width: auto;">
                                                        <button type="button" id="btn-vista" class="active"
                                                            onclick="setPaymentType('vista')">À Vista</button>
                                                        <button type="button" id="btn-financiado"
                                                            onclick="setPaymentType('financiado')">Financiado</button>
                                                    </div>
                                                    <input type="hidden" name="tipoPagamento" id="tipoPagamento"
                                                        value="<%= locals.inputData?.tipoPagamento || 'vista' %>">

                                                    <!-- Preservar ID e Nome se estiver editando -->
                                                    <% if (locals.editMode && locals.editingId) { %>
                                                        <input type="hidden" name="calculationId"
                                                            value="<%= locals.editingId %>">
                                                        <input type="hidden" name="editingName"
                                                            value="<%= locals.editingName %>">
                                                        <% } else if (locals.inputData &&
                                                            locals.inputData.calculationId) { %>
                                                            <!-- Caso venha de um POST anterior -->
                                                            <input type="hidden" name="calculationId"
                                                                value="<%= locals.inputData.calculationId %>">
                                                            <input type="hidden" name="editingName"
                                                                value="<%= locals.inputData.editingName %>">
                                                            <% } %>

                                                </div>

                                                <div class="macos-form-group">
                                                    <label class="macos-form-label">Valor do Arremate</label>
                                                    <div class="macos-input-wrapper">
                                                        <input type="number" step="0.01" name="valorArrematado"
                                                            id="valorArrematado"
                                                            value="<%= locals.inputData?.valorArrematado || '' %>"
                                                            required class="macos-input" placeholder="0,00">
                                                    </div>
                                                </div>

                                                <div class="macos-form-group">
                                                    <label class="macos-form-label">Valor de Avaliação (Base
                                                        ITBI)</label>
                                                    <div class="macos-input-wrapper">
                                                        <input type="number" step="0.01" name="valorAvaliacao"
                                                            id="valorAvaliacao"
                                                            value="<%= locals.inputData?.valorAvaliacao || '' %>"
                                                            class="macos-input"
                                                            placeholder="Valor de avaliação do banco/prefeitura"
                                                            required>
                                                    </div>

                                                    <!-- Toggle Base de Cálculo do ITBI -->
                                                    <div
                                                        style="margin-top: 12px; padding: 12px; background: var(--macos-bg-tertiary); border-radius: 8px;">
                                                        <div
                                                            style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                                            <label
                                                                style="font-size: 12px; font-weight: 600; color: var(--macos-text-primary);">
                                                                Base de Cálculo do ITBI
                                                            </label>
                                                            <div class="macos-segmented-control"
                                                                style="width: auto; font-size: 11px;">
                                                                <button type="button" id="btn-itbi-avaliacao"
                                                                    class="active" onclick="setItbiBase('avaliacao')"
                                                                    style="padding: 4px 12px;">Avaliação</button>
                                                                <button type="button" id="btn-itbi-arremate"
                                                                    onclick="setItbiBase('arremate')"
                                                                    style="padding: 4px 12px;">Arremate</button>
                                                            </div>
                                                        </div>
                                                        <p id="itbi-base-description"
                                                            style="font-size: 11px; color: var(--macos-text-secondary); margin: 0;">
                                                            ITBI calculado sobre o <strong>Valor de Avaliação</strong>
                                                        </p>
                                                    </div>
                                                    <input type="hidden" name="itbiBase" id="itbiBase"
                                                        value="<%= locals.inputData?.itbiBase || 'avaliacao' %>">
                                                </div>



                                                <!-- Campos de Financiamento (Condicional) -->
                                                <div id="financiamento-fields"
                                                    style="display: none; margin-bottom: 20px; padding: 16px; background: var(--macos-bg-tertiary); border-radius: 12px;">
                                                    <div class="macos-form-group">
                                                        <label class="macos-form-label">Entrada</label>
                                                        <div class="macos-input-wrapper">
                                                            <input type="number" step="0.01" name="valorEntrada"
                                                                value="<%= locals.inputData?.valorEntrada || '' %>"
                                                                class="macos-input" placeholder="0,00">
                                                        </div>
                                                    </div>
                                                    <div class="macos-form-group">
                                                        <label class="macos-form-label">Valor Financiado</label>
                                                        <div class="macos-input-wrapper">
                                                            <input type="number" step="0.01" name="valorFinanciado"
                                                                value="<%= locals.inputData?.valorFinanciado || '' %>"
                                                                class="macos-input" placeholder="0,00">
                                                        </div>
                                                    </div>
                                                    <div class="macos-form-group" style="margin-bottom: 0;">
                                                        <label class="macos-form-label">Parcela Mensal</label>
                                                        <div class="macos-input-wrapper">
                                                            <input type="number" step="0.01"
                                                                name="custoMensalFinanciamento"
                                                                value="<%= locals.inputData?.custoMensalFinanciamento || '' %>"
                                                                class="macos-input" placeholder="0,00">
                                                        </div>
                                                    </div>
                                                </div>

                                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                                    <div class="macos-form-group">
                                                        <label class="macos-form-label">Assessoria</label>
                                                        <div class="macos-input-wrapper"
                                                            style="display: flex; gap: 8px;">
                                                            <!-- Input Visível (Formatado) -->
                                                            <input type="text" id="assessoriaDisplay"
                                                                class="macos-input"
                                                                value="<%= locals.results ? locals.results.common.valorAssessoria.toLocaleString('pt-BR', {minimumFractionDigits: 2}) : (locals.inputData && locals.inputData.valorAssessoria ? parseFloat(locals.inputData.valorAssessoria).toLocaleString('pt-BR', {minimumFractionDigits: 2}) : '') %>"
                                                                placeholder="Automático"
                                                                oninput="handleAssessoriaInput(this)"
                                                                style="flex: 1; text-align: left;">

                                                            <!-- Input Oculto (Valor Numérico para o Server) -->
                                                            <input type="hidden" name="valorAssessoria"
                                                                id="valorAssessoriaHidden"
                                                                value="<%= locals.results ? locals.results.common.valorAssessoria : (locals.inputData && locals.inputData.valorAssessoria ? locals.inputData.valorAssessoria : '') %>">
                                                            <div class="macos-btn-secondary" role="button"
                                                                onclick="event.stopPropagation(); event.preventDefault(); abrirModalAssessoriaV2();"
                                                                style="padding: 0 12px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                                                <i class="fa-solid fa-gear"></i>
                                                            </div>
                                                        </div>
                                                        <!-- Inputs ocultos para enviar os parâmetros da regra -->
                                                        <input type="hidden" name="assessoriaThreshold"
                                                            id="assessoriaThreshold"
                                                            value="<%= locals.inputData?.assessoriaThreshold || '120000' %>">
                                                        <input type="hidden" name="assessoriaFeeBelow"
                                                            id="assessoriaFeeBelow"
                                                            value="<%= locals.inputData?.assessoriaFeeBelow || '6000' %>">
                                                        <input type="hidden" name="assessoriaFeeAbovePercent"
                                                            id="assessoriaFeeAbovePercent"
                                                            value="<%= locals.inputData?.assessoriaFeeAbovePercent || '5' %>">
                                                    </div>
                                                    <div class="macos-form-group">
                                                        <div style="display: flex; gap: 12px; align-items: stretch;">
                                                            <div
                                                                style="flex: 1; display: flex; flex-direction: column;">
                                                                <label class="macos-form-label" id="itbi-label"
                                                                    style="flex-grow: 1; display: flex; align-items: end; margin-bottom: 8px;">ITBI
                                                                    (%)</label>
                                                                <input type="number" step="0.1" name="itbi"
                                                                    value="<%= locals.inputData?.itbi || '2' %>"
                                                                    class="macos-input" placeholder="2">
                                                            </div>
                                                            <div style="flex: 1; display: none; flex-direction: column;"
                                                                id="itbi-financiado-container">
                                                                <label class="macos-form-label"
                                                                    style="flex-grow: 1; display: flex; align-items: end; margin-bottom: 8px;">ITBI
                                                                    Financ. (%)</label>
                                                                <input type="number" step="0.1"
                                                                    name="itbiFinanciadoPercent"
                                                                    value="<%= locals.inputData?.itbiFinanciadoPercent || '0.5' %>"
                                                                    class="macos-input" placeholder="0.5">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="macos-form-group">
                                                    <label class="macos-form-label">
                                                        <input type="checkbox" name="incluirLeiloeiro" value="1"
                                                            <%=(!locals.inputData || locals.inputData.incluirLeiloeiro
                                                            !==false && locals.inputData.incluirLeiloeiro !=='0' )
                                                            ? 'checked' : '' %>
                                                        style="margin-right: 8px;">
                                                        Incluir taxa do leiloeiro (5%)
                                                    </label>
                                                </div>
                                            </div>

                                            <!-- Coluna 2: Custos e Venda -->
                                            <div class="macos-card" style="padding: 24px;">
                                                <h2
                                                    style="font-size: 22px; font-weight: 600; color: var(--macos-text-primary); margin-bottom: 20px;">
                                                    Custos e Venda</h2>

                                                <div class="macos-form-group">
                                                    <label class="macos-form-label">Valor de Venda Estimado</label>
                                                    <div class="macos-input-wrapper">
                                                        <input type="number" step="0.01" name="valorVendaFinal"
                                                            value="<%= locals.inputData?.valorVendaFinal || '' %>"
                                                            required class="macos-input" placeholder="0,00">
                                                    </div>
                                                </div>

                                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                                    <div class="macos-form-group">
                                                        <label class="macos-form-label">Reforma</label>
                                                        <div class="macos-input-wrapper">
                                                            <input type="number" step="0.01" name="reforma"
                                                                value="<%= locals.inputData?.reforma || '' %>"
                                                                class="macos-input" placeholder="0,00">
                                                        </div>
                                                    </div>
                                                    <div class="macos-form-group">
                                                        <label class="macos-form-label">Débitos</label>
                                                        <div class="macos-input-wrapper">
                                                            <input type="number" step="0.01" name="debitosPendentes"
                                                                value="<%= locals.inputData?.debitosPendentes || '' %>"
                                                                class="macos-input" placeholder="0,00">
                                                        </div>
                                                    </div>
                                                </div>

                                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                                    <div class="macos-form-group">
                                                        <label class="macos-form-label">Custos de Cartório</label>
                                                        <div class="macos-input-wrapper">
                                                            <input type="number" step="0.01" name="custosCartorarios"
                                                                value="<%= locals.inputData?.custosCartorarios || '' %>"
                                                                class="macos-input" placeholder="0,00">
                                                        </div>
                                                    </div>
                                                    <div class="macos-form-group">
                                                        <label class="macos-form-label">Custos Adicionais</label>
                                                        <div class="macos-input-wrapper">
                                                            <input type="number" step="0.01" name="custosAdicionais"
                                                                value="<%= locals.inputData?.custosAdicionais || '' %>"
                                                                class="macos-input" placeholder="0,00">
                                                        </div>
                                                    </div>
                                                </div>



                                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                                    <div class="macos-form-group">
                                                        <label class="macos-form-label">Desocupação / Advogado</label>
                                                        <div class="macos-input-wrapper">
                                                            <input type="number" step="0.01" name="custoDesocupacao"
                                                                value="<%= locals.inputData?.custoDesocupacao || '' %>"
                                                                class="macos-input" placeholder="0,00">
                                                        </div>
                                                    </div>
                                                    <div class="macos-form-group">
                                                        <label class="macos-form-label">Seguro Fixo</label>
                                                        <div class="macos-input-wrapper">
                                                            <input type="number" step="0.01" name="taxaSeguroCaixa"
                                                                value="<%= locals.inputData?.taxaSeguroCaixa || '' %>"
                                                                class="macos-input" placeholder="Ex: 190,00">
                                                        </div>
                                                    </div>
                                                </div>

                                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                                    <div class="macos-form-group">
                                                        <label class="macos-form-label">Condomínio (Mês)</label>
                                                        <div class="macos-input-wrapper">
                                                            <input type="number" step="0.01" name="condominioMensal"
                                                                value="<%= locals.inputData?.condominioMensal || '' %>"
                                                                class="macos-input" placeholder="0,00">
                                                        </div>
                                                    </div>
                                                    <div class="macos-form-group">
                                                        <label class="macos-form-label">IPTU (Mensal)</label>
                                                        <div class="macos-input-wrapper">
                                                            <input type="number" step="0.01" name="iptuMensal"
                                                                value="<%= locals.inputData?.iptuMensal || '' %>"
                                                                class="macos-input" placeholder="0,00">
                                                        </div>
                                                    </div>
                                                </div>



                                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                                    <div class="macos-form-group">
                                                        <label class="macos-form-label">Corretagem (%)</label>
                                                        <input type="number" step="0.1" name="corretagemPercent"
                                                            value="<%= locals.inputData?.corretagemPercent || '6' %>"
                                                            class="macos-input" placeholder="6">
                                                    </div>
                                                    <div class="macos-form-group">
                                                        <label class="macos-form-label">Imposto de Renda (%)</label>
                                                        <input type="number" step="0.1" name="aliquotaIRGC" value="15"
                                                            readonly class="macos-input"
                                                            style="background-color: var(--macos-bg-tertiary); cursor: default;">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Botões de Ação -->
                                        <div
                                            style="display: flex; gap: 12px; justify-content: flex-end; margin-bottom: 40px;">
                                            <button type="button"
                                                onclick="document.getElementById('calculatorForm').reset()"
                                                class="macos-btn-secondary">
                                                <i class="fa-solid fa-eraser" style="margin-right: 8px;"></i> Limpar
                                            </button>
                                            <button type="submit" class="macos-btn-primary"
                                                style="padding: 10px 24px; font-size: 15px;">
                                                <i class="fa-solid fa-calculator" style="margin-right: 8px;"></i>
                                                Calcular
                                                Viabilidade
                                            </button>
                                        </div>
                                    </form>

                                    <!-- Resultados -->
                                    <% if (results) { %>
                                        <div id="results-section" class="animate-scale-in">
                                            <div
                                                style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
                                                <h2
                                                    style="font-size: 24px; font-weight: 700; color: var(--macos-text-primary);">
                                                    Resultados da Análise</h2>
                                                <button onclick="abrirDetailsModal()" class="macos-btn-secondary"
                                                    style="padding: 12px 24px; font-size: 15px; margin-right: 12px;">
                                                    <i class="fa-solid fa-file-invoice-dollar"
                                                        style="margin-right: 8px;"></i>
                                                    Detalhamento
                                                </button>
                                                <button type="button" onclick="abrirModalSalvar(event)"
                                                    class="macos-btn-primary"
                                                    style="padding: 12px 24px; font-size: 15px; box-shadow: 0 4px 12px rgba(255, 214, 10, 0.3);">
                                                    <i class="fa-solid fa-bookmark" style="margin-right: 8px;"></i>
                                                    Salvar
                                                    Análise
                                                </button>
                                            </div>

                                            <div class="macos-grid"
                                                style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 40px;">
                                                <% const scenarios=[ { m: 4, d: results.projection4Months,
                                                    label: 'Venda Rápida' }, { m: 8, d: results.projection8Months,
                                                    label: 'Venda Média' }, { m: 12, d: results.projection12Months,
                                                    label: 'Venda Longa' }, { m: 16, d: results.projection16Months,
                                                    label: 'Venda Tardia' } ]; %>

                                                    <% scenarios.forEach(s=> {
                                                        const isPositive = s.d.resultadoLiquido > 0;
                                                        const color = isPositive ? '#34C759' : '#FF3B30';
                                                        %>
                                                        <div class="macos-card"
                                                            style="padding: 20px; position: relative; overflow: hidden; border: 1px solid <%= isPositive ? 'rgba(52, 199, 89, 0.2)' : 'rgba(255, 59, 48, 0.2)' %>;">
                                                            <div
                                                                style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: <%= color %>;">
                                                            </div>

                                                            <div
                                                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                                                <span
                                                                    style="font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--macos-text-secondary);">
                                                                    <%= s.label %>
                                                                </span>
                                                                <span
                                                                    style="background: var(--macos-bg-tertiary); padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600;">
                                                                    <%= s.m %> Meses
                                                                </span>
                                                            </div>

                                                            <div style="margin-bottom: 16px;">
                                                                <p
                                                                    style="font-size: 13px; color: var(--macos-text-secondary); margin-bottom: 4px;">
                                                                    Lucro Líquido</p>
                                                                <h3
                                                                    style="font-size: 28px; font-weight: 700; color: <%= color %>; letter-spacing: -0.5px;">
                                                                    <%= s.d.resultadoLiquido.toLocaleString('pt-BR', {
                                                                        style: 'currency' , currency: 'BRL' }) %>
                                                                </h3>
                                                            </div>

                                                            <div style="margin-bottom: 16px;">
                                                                <p
                                                                    style="font-size: 11px; color: var(--macos-text-secondary);">
                                                                    Total Investido</p>
                                                                <p
                                                                    style="font-size: 16px; font-weight: 600; color: var(--macos-text-primary);">
                                                                    <%= s.d.investimentoTotal.toLocaleString('pt-BR', {
                                                                        style: 'currency' , currency: 'BRL' }) %>
                                                                </p>
                                                            </div>

                                                            <div style="margin-bottom: 16px;">
                                                                <p
                                                                    style="font-size: 11px; color: var(--macos-text-secondary);">
                                                                    Valor de Venda</p>
                                                                <p
                                                                    style="font-size: 16px; font-weight: 600; color: #34C759;">
                                                                    <%= parseFloat(inputData.valorVendaFinal ||
                                                                        0).toLocaleString('pt-BR', { style: 'currency' ,
                                                                        currency: 'BRL' }) %>
                                                                </p>
                                                            </div>

                                                            <div
                                                                style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding-top: 16px; border-top: 1px solid var(--macos-divider);">
                                                                <div>
                                                                    <p
                                                                        style="font-size: 11px; color: var(--macos-text-secondary);">
                                                                        ROI</p>
                                                                    <p
                                                                        style="font-size: 14px; font-weight: 600; color: <%= color %>;">
                                                                        <%= s.d.roiLiquido.toFixed(2) %>%
                                                                    </p>
                                                                </div>
                                                                <div style="text-align: right;">
                                                                    <p
                                                                        style="font-size: 11px; color: var(--macos-text-secondary);">
                                                                        Custo/Mês</p>
                                                                    <p
                                                                        style="font-size: 14px; font-weight: 600; color: var(--macos-text-primary);">
                                                                        <%= s.d.custoMensalRecorrente.toLocaleString('pt-BR',
                                                                            { style: 'currency' , currency: 'BRL' }) %>
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <% }); %>
                                            </div>
                                        </div>
                                        <% } %>

                                            <!-- Cálculos Salvos -->
                                            <% if (savedCalculations && savedCalculations.length> 0) { %>
                                                <h2
                                                    style="font-size: 22px; font-weight: 600; color: var(--macos-text-primary); margin-bottom: 16px;">
                                                    Cálculos Salvos
                                                </h2>
                                                <div class="macos-card" style="padding: 0;">
                                                    <div style="display: grid; grid-template-columns: 1fr;">
                                                        <% savedCalculations.forEach(calc=> {
                                                            let data = {};
                                                            try { data = JSON.parse(calc.data); } catch(e) {}

                                                            const valorArrematado = parseFloat(data.valorArrematado) ||
                                                            0;
                                                            const valorVendaFinal = parseFloat(data.valorVendaFinal) ||
                                                            0;
                                                            %>
                                                            <div class="macos-list-item"
                                                                style="border-bottom: 1px solid var(--macos-divider); padding: 16px 20px; cursor: default;">
                                                                <div class="macos-list-item-icon"
                                                                    style="background: var(--macos-accent); color: white;">
                                                                    <i class="fa-solid fa-calculator"></i>
                                                                </div>
                                                                <div class="macos-list-item-content" style="flex: 1;">
                                                                    <div
                                                                        style="display: flex; justify-content: space-between; align-items: center;">
                                                                        <div style="flex: 1;">
                                                                            <h4 class="macos-list-item-title"
                                                                                style="font-size: 16px;">
                                                                                <%= calc.name %>
                                                                            </h4>
                                                                            <p class="macos-list-item-subtitle"
                                                                                style="font-size: 14px; margin-top: 4px;">
                                                                                Investimento: <%=
                                                                                    valorArrematado.toLocaleString('pt-BR',
                                                                                    {style: 'currency' , currency: 'BRL'
                                                                                    }) %> •
                                                                                    Venda: <%=
                                                                                        valorVendaFinal.toLocaleString('pt-BR',
                                                                                        {style: 'currency' ,
                                                                                        currency: 'BRL' }) %>
                                                                            </p>
                                                                        </div>
                                                                        <div
                                                                            style="display: flex; align-items: center; gap: 12px;">
                                                                            <span
                                                                                style="font-size: 12px; color: var(--macos-text-tertiary);">
                                                                                <%= new
                                                                                    Date(calc.created_at).toLocaleDateString('pt-BR')
                                                                                    %>
                                                                            </span>
                                                                            <div style="display: flex; gap: 8px;">
                                                                                <button type="button"
                                                                                    class="macos-btn-secondary"
                                                                                    onclick="abrirDetalhesCalculo(<%= calc.id %>, '<%= calc.name.replace(/'/g, '') %>', '<%= encodeURIComponent(calc.data) %>')"
                                                                                    style="padding: 6px 12px; font-size: 13px;">
                                                                                    <i class="fa-solid fa-eye"
                                                                                        style="margin-right: 4px;"></i>
                                                                                    Detalhar
                                                                                </button>
                                                                                <button type="button"
                                                                                    class="macos-btn-primary"
                                                                                    onclick="editarCalculo(<%= calc.id %>)"
                                                                                    style="padding: 6px 12px; font-size: 13px;">
                                                                                    <i class="fa-solid fa-pen"
                                                                                        style="margin-right: 4px;"></i>
                                                                                    Editar
                                                                                </button>
                                                                                <button type="button"
                                                                                    class="macos-btn-secondary"
                                                                                    onclick="deleteCalculation(<%= calc.id %>)"
                                                                                    style="padding: 6px 12px; font-size: 13px; color: #FF3B30 !important; border-color: rgba(255, 59, 48, 0.3);">
                                                                                    <i class="fa-solid fa-trash"
                                                                                        style="margin-right: 4px;"></i>
                                                                                    Excluir
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <% }); %>
                                                    </div>
                                                </div>
                                                <% } %>

                </div>
            </main>

            <!-- Modal Detalhamento (macOS Sonoma Style) -->
            <% if (results) { %>
                <div id="detailsModal" class="macos-modal-overlay"
                    style="display: none; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);">
                    <div class="macos-window"
                        style="width: 500px; max-width: 95%; background: var(--macos-bg-secondary); border-radius: 16px; box-shadow: 0 25px 50px rgba(0,0,0,0.4); display: flex; flex-direction: column; max-height: 90vh;">
                        <div
                            style="padding: 24px 28px; border-bottom: 1px solid var(--macos-divider); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--macos-text-primary);">
                                Detalhamento Financeiro</h3>
                            <button onclick="fecharDetailsModal()"
                                style="width: 32px; height: 32px; border-radius: 50%; background: var(--macos-bg-tertiary); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;"
                                onmouseover="this.style.background='rgba(255,59,48,0.1)'; this.querySelector('i').style.color='#FF3B30';"
                                onmouseout="this.style.background='var(--macos-bg-tertiary)'; this.querySelector('i').style.color='var(--macos-text-secondary)';">
                                <i class="fa-solid fa-xmark"
                                    style="color: var(--macos-text-secondary); font-size: 16px;"></i>
                            </button>
                        </div>

                        <div style="padding: 28px; overflow-y: auto; flex: 1;">
                            <!-- Conteúdo do modal mantido, apenas wrapper alterado -->
                            <div style="margin-bottom: 24px;">
                                <h4
                                    style="font-size: 13px; font-weight: 700; color: var(--macos-text-secondary); text-transform: uppercase; margin-bottom: 12px; border-bottom: 1px solid var(--macos-divider); padding-bottom: 8px; letter-spacing: 0.5px;">
                                    Custos de Aquisição
                                </h4>
                                <div
                                    style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                                    <span style="color: var(--macos-text-secondary);">Valor de Arremate</span>
                                    <span style="font-weight: 500; color: var(--macos-text-primary);">
                                        <%= parseFloat(inputData.valorArrematado || 0).toLocaleString('pt-BR',
                                            {style: 'currency' , currency: 'BRL' }) %>
                                    </span>
                                </div>
                                <div
                                    style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                                    <span style="color: var(--macos-text-secondary);">Assessoria</span>
                                    <span style="font-weight: 500; color: var(--macos-text-primary);">
                                        <%= results.common.valorAssessoria.toLocaleString('pt-BR', {style: 'currency' ,
                                            currency: 'BRL' }) %>
                                    </span>
                                </div>
                                <div
                                    style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                                    <span style="color: var(--macos-text-secondary);">Leiloeiro (5%)</span>
                                    <span style="font-weight: 500; color: var(--macos-text-primary);">
                                        <%= results.common.valorLeiloeiro.toLocaleString('pt-BR', {style: 'currency' ,
                                            currency: 'BRL' }) %>
                                    </span>
                                </div>
                                <div
                                    style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                                    <span style="color: var(--macos-text-secondary);">ITBI</span>
                                    <span style="font-weight: 500; color: var(--macos-text-primary);">
                                        <%= results.common.valorITBI.toLocaleString('pt-BR', {style: 'currency' ,
                                            currency: 'BRL' }) %>
                                    </span>
                                </div>
                                <div
                                    style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                                    <span style="color: var(--macos-text-secondary);">Cartório / Registro</span>
                                    <span style="font-weight: 500; color: var(--macos-text-primary);">
                                        <%= parseFloat(inputData.custosCartorarios || 0).toLocaleString('pt-BR',
                                            {style: 'currency' , currency: 'BRL' }) %>
                                    </span>
                                </div>
                                <div
                                    style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                                    <span style="color: var(--macos-text-secondary);">Reforma</span>
                                    <span style="font-weight: 500; color: var(--macos-text-primary);">
                                        <%= parseFloat(inputData.reforma || 0).toLocaleString('pt-BR',
                                            {style: 'currency' , currency: 'BRL' }) %>
                                    </span>
                                </div>
                                <div
                                    style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                                    <span style="color: var(--macos-text-secondary);">Débitos Pendentes</span>
                                    <span style="font-weight: 500; color: var(--macos-text-primary);">
                                        <%= parseFloat(inputData.debitosPendentes || 0).toLocaleString('pt-BR',
                                            {style: 'currency' , currency: 'BRL' }) %>
                                    </span>
                                </div>
                                <div
                                    style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                                    <span style="color: var(--macos-text-secondary);">Desocupação</span>
                                    <span style="font-weight: 500; color: var(--macos-text-primary);">
                                        <%= parseFloat(inputData.custoDesocupacao || 0).toLocaleString('pt-BR',
                                            {style: 'currency' , currency: 'BRL' }) %>
                                    </span>
                                </div>
                            </div>

                            <div style="margin-bottom: 24px;">
                                <h4
                                    style="font-size: 13px; font-weight: 700; color: var(--macos-text-secondary); text-transform: uppercase; margin-bottom: 12px; border-bottom: 1px solid var(--macos-divider); padding-bottom: 8px; letter-spacing: 0.5px;">
                                    Custos de Venda
                                </h4>
                                <div
                                    style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                                    <span style="color: var(--macos-text-secondary);">Corretagem</span>
                                    <span style="font-weight: 500; color: var(--macos-text-primary);">
                                        <%= results.common.corretagem.toLocaleString('pt-BR', {style: 'currency' ,
                                            currency: 'BRL' }) %>
                                    </span>
                                </div>
                            </div>

                            <div style="margin-bottom: 24px;">
                                <h4
                                    style="font-size: 13px; font-weight: 700; color: var(--macos-text-secondary); text-transform: uppercase; margin-bottom: 12px; border-bottom: 1px solid var(--macos-divider); padding-bottom: 8px; letter-spacing: 0.5px;">
                                    Valor de Venda
                                </h4>
                                <div
                                    style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                                    <span style="color: var(--macos-text-secondary);">Valor de Venda Estimado</span>
                                    <span style="font-weight: 600; color: #34C759; font-size: 16px;">
                                        <%= parseFloat(inputData.valorVendaFinal || 0).toLocaleString('pt-BR',
                                            {style: 'currency' , currency: 'BRL' }) %>
                                    </span>
                                </div>
                            </div>

                            <div style="margin-bottom: 12px;">
                                <h4
                                    style="font-size: 13px; font-weight: 700; color: var(--macos-text-secondary); text-transform: uppercase; margin-bottom: 12px; border-bottom: 1px solid var(--macos-divider); padding-bottom: 8px; letter-spacing: 0.5px;">
                                    Impostos e Manutenção (Simulação 4 Meses)
                                </h4>
                                <div
                                    style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                                    <span style="color: var(--macos-text-secondary);">Imposto de Renda (Estimado)</span>
                                    <span style="font-weight: 500; color: #FF3B30;">
                                        <%= results.projection4Months.impostoLucro.toLocaleString('pt-BR',
                                            {style: 'currency' , currency: 'BRL' }) %>
                                    </span>
                                </div>
                                <div
                                    style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                                    <span style="color: var(--macos-text-secondary);">Outros Impostos (S/ Venda)</span>
                                    <span style="font-weight: 500; color: #FF3B30;">
                                        <%= results.projection4Months.tributacaoEntrada.toLocaleString('pt-BR',
                                            {style: 'currency' , currency: 'BRL' }) %>
                                    </span>
                                </div>
                                <div
                                    style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                                    <span style="color: var(--macos-text-secondary);">Manutenção
                                        (Cond./IPTU/Seguro)</span>
                                    <span style="font-weight: 500; color: var(--macos-text-primary);">
                                        <%= results.projection4Months.custosPeriodo.toLocaleString('pt-BR',
                                            {style: 'currency' , currency: 'BRL' }) %>
                                    </span>
                                </div>
                                <div
                                    style="display: flex; justify-content: space-between; margin-top: 20px; font-size: 15px; border-top: 1px dashed var(--macos-divider); padding-top: 16px;">
                                    <span style="font-weight: 600; color: var(--macos-text-primary);">Total Geral de
                                        Custos e Impostos</span>
                                    <% const totalCosts=results.common.valorAssessoria + results.common.valorLeiloeiro +
                                        results.common.valorITBI + parseFloat(inputData.custosCartorarios || 0) +
                                        parseFloat(inputData.reforma || 0) + parseFloat(inputData.debitosPendentes || 0)
                                        + parseFloat(inputData.custoDesocupacao || 0) + results.common.corretagem +
                                        results.projection4Months.impostoDevido +
                                        results.projection4Months.custosPeriodo; %>
                                        <span style="font-weight: 700; color: var(--macos-text-primary);">
                                            <%= totalCosts.toLocaleString('pt-BR', {style: 'currency' , currency: 'BRL'
                                                }) %>
                                        </span>
                                </div>
                            </div>
                        </div>

                        <div
                            style="padding: 20px 28px; background: var(--macos-bg-tertiary); border-radius: 0 0 16px 16px; border-top: 1px solid var(--macos-divider); display: flex; justify-content: flex-end;">
                            <button type="button" class="macos-btn-primary"
                                onclick="fecharDetailsModal()">Fechar</button>
                        </div>
                    </div>
                </div>
                <% } %>

                    <!-- Modal Salvar (macOS Sonoma Style) -->
                    <div id="saveModal" class="macos-modal-overlay"
                        style="display: none; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 9999;">
                        <div class="macos-window" onclick="event.stopPropagation()"
                            style="width: 440px; background: var(--macos-bg-secondary); border-radius: 16px; box-shadow: 0 25px 50px rgba(0,0,0,0.4); display: flex; flex-direction: column;">
                            <div
                                style="padding: 24px 28px; border-bottom: 1px solid var(--macos-divider); display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h3 style="font-size: 20px; font-weight: 700; color: var(--macos-text-primary);">
                                        Salvar Análise</h3>
                                </div>
                                <button
                                    onclick="const m = document.getElementById('saveModal'); m.classList.remove('active'); setTimeout(() => m.style.display = 'none', 300);"
                                    style="width: 32px; height: 32px; border-radius: 50%; background: var(--macos-bg-tertiary); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;"
                                    onmouseover="this.style.background='rgba(255,59,48,0.1)'; this.querySelector('i').style.color='#FF3B30';"
                                    onmouseout="this.style.background='var(--macos-bg-tertiary)'; this.querySelector('i').style.color='var(--macos-text-secondary)';">
                                    <i class="fa-solid fa-xmark"
                                        style="color: var(--macos-text-secondary); font-size: 16px;"></i>
                                </button>
                            </div>

                            <form action="/calculadora/salvar" method="POST"
                                style="flex: 1; display: flex; flex-direction: column;">
                                <div style="padding: 28px; flex: 1;">
                                    <p
                                        style="color: var(--macos-text-secondary); font-size: 14px; margin-bottom: 24px;">
                                        Dê um nome para esta oportunidade para encontrá-la facilmente depois no seu
                                        histórico.
                                    </p>

                                    <% for (const key in inputData) { %>
                                        <input type="hidden" name="<%= key %>" value="<%= inputData[key] %>">
                                        <% } %>

                                            <% if (locals.editMode && locals.editingId) { %>
                                                <input type="hidden" name="calculationId"
                                                    value="<%= locals.editingId %>">
                                                <% } %>

                                                    <div class="macos-form-group">
                                                        <label class="macos-form-label">Nome da Oportunidade</label>
                                                        <input type="text" name="calculationName" required
                                                            class="macos-input"
                                                            placeholder="Ex: Apto Centro - Leilão Caixa"
                                                            value="<%= locals.editMode ? locals.editingName : '' %>"
                                                            autofocus>
                                                    </div>
                                </div>

                                <div
                                    style="padding: 20px 28px; background: var(--macos-bg-tertiary); border-radius: 0 0 16px 16px; border-top: 1px solid var(--macos-divider); display: flex; justify-content: flex-end; gap: 12px;">
                                    <button type="button" class="macos-btn-secondary"
                                        onclick="const m = document.getElementById('saveModal'); m.classList.remove('active'); setTimeout(() => m.style.display = 'none', 300);">Cancelar</button>
                                    <button type="submit" class="macos-btn-primary">Salvar</button>
                                </div>
                            </form>
                        </div>
                    </div>



                    <!-- Modal: Detalhes do Cálculo Salvo -->
                    <div id="modal-detalhes-calculo" class="hidden"
                        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; padding: 20px;">
                        <div class="macos-window"
                            style="width: 700px; max-width: 100%; background: var(--macos-bg-secondary); border-radius: 16px; box-shadow: 0 25px 50px rgba(0,0,0,0.4); transform: scale(0.95); transition: transform 0.3s; max-height: 90vh; display: flex; flex-direction: column;">

                            <!-- Header do Modal -->
                            <div
                                style="padding: 24px 28px; border-bottom: 1px solid var(--macos-divider); flex-shrink: 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h3 id="modal-calculo-titulo"
                                            style="font-size: 22px; font-weight: 700; color: var(--macos-text-primary); margin-bottom: 4px;">
                                            Detalhes do Cálculo
                                        </h3>
                                        <p style="font-size: 14px; color: var(--macos-text-secondary);">
                                            Informações completas da análise de viabilidade
                                        </p>
                                    </div>
                                    <button onclick="fecharDetalhesCalculo()"
                                        style="width: 32px; height: 32px; border-radius: 50%; background: var(--macos-bg-tertiary); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;"
                                        onmouseover="this.style.background='rgba(255,59,48,0.1)'; this.querySelector('i').style.color='#FF3B30';"
                                        onmouseout="this.style.background='var(--macos-bg-tertiary)'; this.querySelector('i').style.color='var(--macos-text-secondary)';">
                                        <i class="fa-solid fa-xmark"
                                            style="color: var(--macos-text-secondary); font-size: 16px; transition: color 0.2s;"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Conteúdo do Modal (Scrollable) -->
                            <div id="modal-calculo-conteudo" style="padding: 28px; overflow-y: auto; flex: 1;">
                                <!-- Conteúdo será preenchido dinamicamente -->
                            </div>

                            <!-- Footer com Ações -->
                            <div
                                style="padding: 20px 28px; border-top: 1px solid var(--macos-divider); background: var(--macos-bg-tertiary); border-radius: 0 0 16px 16px; flex-shrink: 0;">
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" class="macos-btn-secondary" onclick="fecharDetalhesCalculo()">
                                        <i class="fa-solid fa-times" style="margin-right: 6px;"></i>
                                        Fechar
                                    </button>
                                    <button type="button" id="btn-editar-calculo-modal" class="macos-btn-primary"
                                        onclick="">
                                        <i class="fa-solid fa-pen" style="margin-right: 6px;"></i>
                                        Editar Cálculo
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal: Editar Cálculo -->
                    <div id="modal-editar-calculo" class="hidden"
                        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1001; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; padding: 20px;">
                        <div class="macos-window"
                            style="width: 900px; max-width: 100%; background: var(--macos-bg-secondary); border-radius: 16px; box-shadow: 0 25px 50px rgba(0,0,0,0.4); transform: scale(0.95); transition: transform 0.3s; max-height: 90vh; display: flex; flex-direction: column;">

                            <div
                                style="padding: 24px 28px; border-bottom: 1px solid var(--macos-divider); flex-shrink: 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h3 id="modal-editar-titulo"
                                            style="font-size: 22px; font-weight: 700; color: var(--macos-text-primary); margin-bottom: 4px;">
                                            Editar Cálculo
                                        </h3>
                                        <p style="font-size: 14px; color: var(--macos-text-secondary);">
                                            Atualize os valores do cálculo
                                        </p>
                                    </div>
                                    <button onclick="fecharModalEditar()"
                                        style="width: 32px; height: 32px; border-radius: 50%; background: var(--macos-bg-tertiary); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;"
                                        onmouseover="this.style.background='rgba(255,59,48,0.1)'; this.querySelector('i').style.color='#FF3B30';"
                                        onmouseout="this.style.background='var(--macos-bg-tertiary)'; this.querySelector('i').style.color='var(--macos-text-secondary)';">
                                        <i class="fa-solid fa-xmark"
                                            style="color: var(--macos-text-secondary); font-size: 16px; transition: color 0.2s;"></i>
                                    </button>
                                </div>
                            </div>

                            <form id="form-editar-calculo" style="overflow-y: auto; flex: 1;">
                                <div id="modal-editar-conteudo" style="padding: 28px; display: grid; gap: 20px;">
                                </div>
                            </form>

                            <div
                                style="padding: 20px 28px; border-top: 1px solid var(--macos-divider); background: var(--macos-bg-tertiary); border-radius: 0 0 16px 16px; flex-shrink: 0;">
                                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                    <button type="button" class="macos-btn-secondary" onclick="fecharModalEditar()">
                                        <i class="fa-solid fa-times" style="margin-right: 6px;"></i>
                                        Cancelar
                                    </button>
                                    <button type="button" class="macos-btn-primary" onclick="salvarEdicaoCalculo()">
                                        <i class="fa-solid fa-save" style="margin-right: 6px;"></i>
                                        Salvar Alterações
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <script>
                        // Formata input como moeda BRL enquanto digita
                        function formatCurrencyInput(input) {
                            let value = input.value.replace(/\D/g, '');
                            value = (parseInt(value) / 100).toFixed(2) + '';
                            value = value.replace('.', ',');
                            value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
                            if (value === 'NaN' || value === '0,00') value = '';
                            input.value = value;
                        }

                        // Converte string formatada (120.000,00) para float (120000.00)
                        function parseCurrency(value) {
                            if (!value) return 0;
                            return parseFloat(value.replace(/\./g, '').replace(',', '.'));
                        }

                        // Controla o submit do formulário
                        function validateAndSubmit(event) {
                            console.log('📋 validateAndSubmit chamado');
                            console.log('📋 Event submitter:', event.submitter);

                            // Se não houver submitter ou se for o botão de calcular, permite
                            if (!event.submitter || event.submitter.type === 'submit') {
                                console.log('✅ Submit permitido');
                                return true;
                            }

                            // Caso contrário, bloqueia
                            console.log('❌ Submit bloqueado');
                            event.preventDefault();
                            return false;
                        }

                        // Formata float para string BRL sem o símbolo R$
                        function formatCurrencyValue(value) {
                            if (!value) return '';
                            return parseFloat(value).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        }
                    </script>

                    <script>
                        function setPaymentType(type) {
                            document.getElementById('tipoPagamento').value = type;
                            document.getElementById('btn-vista').classList.toggle('active', type === 'vista');
                            document.getElementById('btn-financiado').classList.toggle('active', type === 'financiado');

                            const fields = document.getElementById('financiamento-fields');
                            const itbiFinanciadoContainer = document.getElementById('itbi-financiado-container');
                            const itbiLabel = document.getElementById('itbi-label');

                            if (type === 'financiado') {
                                fields.style.display = 'block';
                                // Animação simples de fade in
                                fields.style.opacity = '0';
                                setTimeout(() => fields.style.opacity = '1', 10);

                                // Mostra campo ITBI Financiado e ajusta label
                                if (itbiFinanciadoContainer) {
                                    itbiFinanciadoContainer.style.display = 'flex';
                                    itbiFinanciadoContainer.style.flexDirection = 'column'; // Garantir direção correta
                                }
                                if (itbiLabel) itbiLabel.textContent = 'ITBI Entrada (%)';
                            } else {
                                fields.style.display = 'none';

                                // Esconde campo ITBI Financiado e restaura label
                                if (itbiFinanciadoContainer) itbiFinanciadoContainer.style.display = 'none';
                                if (itbiLabel) itbiLabel.textContent = 'ITBI (%)';
                            }
                        }

                        // Inicializa estado
                        document.addEventListener('DOMContentLoaded', () => {
                            const currentType = document.getElementById('tipoPagamento').value;
                            setPaymentType(currentType);

                            // Inicializa estado do toggle ITBI
                            const currentItbiBase = document.getElementById('itbiBase').value;
                            setItbiBase(currentItbiBase);
                        });

                        // Função para alternar base de cálculo do ITBI
                        function setItbiBase(base) {
                            document.getElementById('itbiBase').value = base;
                            document.getElementById('btn-itbi-avaliacao').classList.toggle('active', base === 'avaliacao');
                            document.getElementById('btn-itbi-arremate').classList.toggle('active', base === 'arremate');

                            const description = document.getElementById('itbi-base-description');
                            if (base === 'avaliacao') {
                                description.innerHTML = 'ITBI calculado sobre o <strong>Valor de Avaliação</strong>';
                            } else {
                                description.innerHTML = 'ITBI calculado sobre o <strong>Valor de Arremate</strong>';
                            }
                        }

                        // Funções para modal de detalhes do cálculo
                        function abrirDetalhesCalculo(id, nome, dadosEncoded) {
                            const dados = JSON.parse(decodeURIComponent(dadosEncoded));

                            // Atualizar título
                            document.getElementById('modal-calculo-titulo').textContent = nome;

                            // Construir HTML do conteúdo
                            const formatMoney = (val) => parseFloat(val || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                            const html = `
                                <div style="display: grid; gap: 20px;">
                                    <!-- Investimento -->
                                    <div style="background: var(--macos-bg-tertiary); border-radius: 12px; padding: 20px; border: 1px solid var(--macos-divider);">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                                            <div style="width: 36px; height: 36px; border-radius: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center;">
                                                <i class="fa-solid fa-wallet" style="color: white; font-size: 16px;"></i>
                                            </div>
                                            <h4 style="font-size: 16px; font-weight: 600; color: var(--macos-text-primary); margin: 0;">Investimento</h4>
                                        </div>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                                <span style="font-size: 12px; color: var(--macos-text-secondary); font-weight: 500;">Valor Arremate</span>
                                                <strong style="font-size: 15px; color: var(--macos-text-primary);">${formatMoney(dados.valorArrematado)}</strong>
                                            </div>
                                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                                <span style="font-size: 12px; color: var(--macos-text-secondary); font-weight: 500;">Valor Avaliação</span>
                                                <strong style="font-size: 15px; color: var(--macos-text-primary);">${formatMoney(dados.valorAvaliacao)}</strong>
                                            </div>
                                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                                <span style="font-size: 12px; color: var(--macos-text-secondary); font-weight: 500;">Tipo Pagamento</span>
                                                <strong style="font-size: 15px; color: var(--macos-text-primary);">${(() => {
                                    const tipo = (dados.tipoPagamento || '').toString().toLowerCase();
                                    return tipo === 'vista' || tipo === 'à vista' ? 'À Vista' : 'Financiado';
                                })()}</strong>
                                            </div>
                                            ${(() => {
                                    const tipo = (dados.tipoPagamento || '').toString().toLowerCase();
                                    return (tipo !== 'vista' && tipo !== 'à vista') ? `
                                                    <div style="display: flex; flex-direction: column; gap: 4px;">
                                                        <span style="font-size: 12px; color: var(--macos-text-secondary); font-weight: 500;">Entrada</span>
                                                        <strong style="font-size: 15px; color: var(--macos-text-primary);">${formatMoney(dados.valorEntrada)}</strong>
                                                    </div>
                                                    <div style="display: flex; flex-direction: column; gap: 4px;">
                                                        <span style="font-size: 12px; color: var(--macos-text-secondary); font-weight: 500;">Valor Financiado</span>
                                                        <strong style="font-size: 15px; color: var(--macos-text-primary);">${formatMoney(dados.valorFinanciado)}</strong>
                                                    </div>
                                                    <div style="display: flex; flex-direction: column; gap: 4px;">
                                                        <span style="font-size: 12px; color: var(--macos-text-secondary); font-weight: 500;">Parcela Mensal</span>
                                                        <strong style="font-size: 15px; color: var(--macos-text-primary);">${formatMoney(dados.custoMensalFinanciamento)}</strong>
                                                    </div>
                                                ` : '';
                                })()}
                                        </div>
                                    </div>

                                    <!-- Custos e Taxas -->
                                    <div style="background: var(--macos-bg-tertiary); border-radius: 12px; padding: 20px; border: 1px solid var(--macos-divider);">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                                            <div style="width: 36px; height: 36px; border-radius: 8px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); display: flex; align-items: center; justify-content: center;">
                                                <i class="fa-solid fa-receipt" style="color: white; font-size: 16px;"></i>
                                            </div>
                                            <h4 style="font-size: 16px; font-weight: 600; color: var(--macos-text-primary); margin: 0;">Custos e Taxas</h4>
                                        </div>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                                <span style="font-size: 12px; color: var(--macos-text-secondary); font-weight: 500;">ITBI (${dados.itbi}%)</span>
                                                <strong style="font-size: 15px; color: var(--macos-text-primary);">Base: ${dados.itbiBase === 'arremate' ? 'Arremate' : 'Avaliação'}</strong>
                                            </div>
                                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                                <span style="font-size: 12px; color: var(--macos-text-secondary); font-weight: 500;">Reforma</span>
                                                <strong style="font-size: 15px; color: var(--macos-text-primary);">${formatMoney(dados.reforma)}</strong>
                                            </div>
                                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                                <span style="font-size: 12px; color: var(--macos-text-secondary); font-weight: 500;">Custos Cartório</span>
                                                <strong style="font-size: 15px; color: var(--macos-text-primary);">${formatMoney(dados.custosCartorarios)}</strong>
                                            </div>
                                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                                <span style="font-size: 12px; color: var(--macos-text-secondary); font-weight: 500;">Débitos</span>
                                                <strong style="font-size: 15px; color: var(--macos-text-primary);">${formatMoney(dados.debitosPendentes)}</strong>
                                            </div>
                                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                                <span style="font-size: 12px; color: var(--macos-text-secondary); font-weight: 500;">Desocupação</span>
                                                <strong style="font-size: 15px; color: var(--macos-text-primary);">${formatMoney(dados.custoDesocupacao)}</strong>
                                            </div>
                                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                                <span style="font-size: 12px; color: var(--macos-text-secondary); font-weight: 500;">Custos Adicionais</span>
                                                <strong style="font-size: 15px; color: var(--macos-text-primary);">${formatMoney(dados.custosAdicionais)}</strong>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Custos Mensais -->
                                    <div style="background: var(--macos-bg-tertiary); border-radius: 12px; padding: 20px; border: 1px solid var(--macos-divider);">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                                            <div style="width: 36px; height: 36px; border-radius: 8px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); display: flex; align-items: center; justify-content: center;">
                                                <i class="fa-solid fa-calendar-days" style="color: white; font-size: 16px;"></i>
                                            </div>
                                            <h4 style="font-size: 16px; font-weight: 600; color: var(--macos-text-primary); margin: 0;">Custos Mensais</h4>
                                        </div>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                                <span style="font-size: 12px; color: var(--macos-text-secondary); font-weight: 500;">Condomínio</span>
                                                <strong style="font-size: 15px; color: var(--macos-text-primary);">${formatMoney(dados.condominioMensal)}</strong>
                                            </div>
                                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                                <span style="font-size: 12px; color: var(--macos-text-secondary); font-weight: 500;">IPTU Mensal</span>
                                                <strong style="font-size: 15px; color: var(--macos-text-primary);">${formatMoney(dados.iptuMensal)}</strong>
                                            </div>
                                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                                <span style="font-size: 12px; color: var(--macos-text-secondary); font-weight: 500;">Seguro Fixo</span>
                                                <strong style="font-size: 15px; color: var(--macos-text-primary);">${formatMoney(dados.taxaSeguroCaixa)}</strong>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Venda -->
                                    <div style="background: var(--macos-bg-tertiary); border-radius: 12px; padding: 20px; border: 1px solid var(--macos-divider);">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                                            <div style="width: 36px; height: 36px; border-radius: 8px; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); display: flex; align-items: center; justify-content: center;">
                                                <i class="fa-solid fa-tag" style="color: white; font-size: 16px;"></i>
                                            </div>
                                            <h4 style="font-size: 16px; font-weight: 600; color: var(--macos-text-primary); margin: 0;">Venda</h4>
                                        </div>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                                <span style="font-size: 12px; color: var(--macos-text-secondary); font-weight: 500;">Valor Venda</span>
                                                <strong style="font-size: 15px; color: var(--macos-text-primary);">${formatMoney(dados.valorVendaFinal)}</strong>
                                            </div>
                                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                                <span style="font-size: 12px; color: var(--macos-text-secondary); font-weight: 500;">Corretagem (${dados.corretagemPercent || 6}%)</span>
                                                <strong style="font-size: 15px; color: var(--macos-text-primary);">${(() => {
                                    const valorVenda = parseFloat(dados.valorVendaFinal) || 0;
                                    const corretagemPercent = parseFloat(dados.corretagemPercent) || 6;
                                    const corretagem = valorVenda * (corretagemPercent / 100);
                                    return formatMoney(corretagem);
                                })()}</strong>
                                            </div>
                                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                                <span style="font-size: 12px; color: var(--macos-text-secondary); font-weight: 500;">IR (${((parseFloat(dados.aliquotaIRGC) || 0.15) * 100).toFixed(0)}%)</span>
                                                <strong style="font-size: 15px; color: var(--macos-text-primary);">${(() => {
                                    const valorVenda = parseFloat(dados.valorVendaFinal) || 0;
                                    const corretagemPercent = parseFloat(dados.corretagemPercent) || 6;
                                    const corretagem = valorVenda * (corretagemPercent / 100);

                                    const valorArremate = parseFloat(dados.valorArrematado) || 0;
                                    const reforma = parseFloat(dados.reforma) || 0;
                                    const custosCartorarios = parseFloat(dados.custosCartorarios) || 0;
                                    const debitosPendentes = parseFloat(dados.debitosPendentes) || 0;
                                    const custoDesocupacao = parseFloat(dados.custoDesocupacao) || 0;
                                    const custosAdicionais = parseFloat(dados.custosAdicionais) || 0;

                                    const totalCustos = valorArremate + reforma + custosCartorarios + debitosPendentes + custoDesocupacao + custosAdicionais;
                                    const lucroBruto = valorVenda - corretagem - totalCustos;
                                    const aliquotaIR = parseFloat(dados.aliquotaIRGC) || 0.15;
                                    const impostoRenda = lucroBruto > 0 ? lucroBruto * aliquotaIR : 0;
                                    return formatMoney(impostoRenda);
                                })()}</strong>
                                            </div>
                                        </div>
                                    </div>
                                    </div>
                                </div>
                            `;

                            document.getElementById('modal-calculo-conteudo').innerHTML = html;
                            document.getElementById('btn-editar-calculo-modal').setAttribute('onclick', `editarCalculo(${id})`);

                            // Abrir modal
                            const modal = document.getElementById('modal-detalhes-calculo');
                            modal.classList.remove('hidden');
                            modal.classList.add('active');
                            setTimeout(() => {
                                modal.style.opacity = '1';
                                modal.style.pointerEvents = 'auto';
                                modal.querySelector('.macos-window').style.transform = 'scale(1)';
                            }, 10);
                        }

                        function fecharDetalhesCalculo() {
                            const modal = document.getElementById('modal-detalhes-calculo');
                            modal.style.opacity = '0';
                            modal.style.pointerEvents = 'none';
                            modal.querySelector('.macos-window').style.transform = 'scale(0.95)';
                            setTimeout(() => {
                                modal.classList.add('hidden');
                                modal.classList.remove('active');
                            }, 300);
                        }

                        // Funções para o modal de detalhes do cálculo ao vivo
                        function abrirDetailsModal() {
                            const modal = document.getElementById('detailsModal');
                            modal.style.display = 'flex';
                            modal.classList.add('active');
                            setTimeout(() => {
                                modal.style.opacity = '1';
                                modal.style.pointerEvents = 'auto';
                            }, 10);
                        }

                        function fecharDetailsModal() {
                            const modal = document.getElementById('detailsModal');
                            modal.style.opacity = '0';
                            modal.style.pointerEvents = 'none';
                            setTimeout(() => {
                                modal.style.display = 'none';
                                modal.classList.remove('active');
                            }, 300);
                        }

                        // Variável global para armazenar o ID do cálculo sendo editado
                        let calculoEditandoId = null;

                        async function editarCalculo(id) {
                            calculoEditandoId = id;

                            // Buscar dados do cálculo
                            const response = await fetch(`/api/saved-calculations`);
                            const calculos = await response.json();
                            const calculo = calculos.find(c => c.id === id);

                            if (!calculo) {
                                alert('Cálculo não encontrado');
                                return;
                            }

                            const dados = JSON.parse(calculo.data);

                            // Atualizar título
                            document.getElementById('modal-editar-titulo').textContent = `Editar: ${calculo.name} `;

                            // Construir formulário
                            const formatMoney = (val) => {
                                if (!val && val !== 0) return '';
                                // Formata como BRL
                                return parseFloat(val).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                            };

                            const html = `
                                < div style = "display: grid; grid-template-columns: 1fr 1fr; gap: 20px;" >
                                    <div class="macos-form-group">
                                        <label class="macos-form-label">Valor de Arremate</label>
                                        <input type="text" id="edit-valorArrematado" name="valorArrematado" value="${formatMoney(dados.valorArrematado)}" class="macos-input currency-input" required>
                                    </div>
                                    <div class="macos-form-group">
                                        <label class="macos-form-label">Valor de Avaliação</label>
                                        <input type="text" id="edit-valorAvaliacao" name="valorAvaliacao" value="${formatMoney(dados.valorAvaliacao)}" class="macos-input currency-input" required>
                                    </div>
                                    <div class="macos-form-group">
                                        <label class="macos-form-label">Valor de Venda</label>
                                        <input type="text" id="edit-valorVendaFinal" name="valorVendaFinal" value="${formatMoney(dados.valorVendaFinal)}" class="macos-input currency-input" required>
                                    </div>
                                    <div class="macos-form-group">
                                        <label class="macos-form-label">ITBI (%)</label>
                                        <input type="number" step="0.1" id="edit-itbi" value="${dados.itbi || 2}" class="macos-input">
                                    </div>
                                    <div class="macos-form-group">
                                        <label class="macos-form-label">Reforma</label>
                                        <input type="text" id="edit-reforma" name="reforma" value="${formatMoney(dados.reforma)}" class="macos-input currency-input">
                                    </div>
                                    <div class="macos-form-group">
                                        <label class="macos-form-label">Custos de Cartório</label>
                                        <input type="text" id="edit-custosCartorarios" name="custosCartorarios" value="${formatMoney(dados.custosCartorarios)}" class="macos-input currency-input">
                                    </div>
                                    <div class="macos-form-group">
                                        <label class="macos-form-label">Débitos Pendentes</label>
                                        <input type="text" id="edit-debitosPendentes" name="debitosPendentes" value="${formatMoney(dados.debitosPendentes)}" class="macos-input currency-input">
                                    </div>
                                    <div class="macos-form-group">
                                        <label class="macos-form-label">Desocupação/Advogado</label>
                                        <input type="text" id="edit-custoDesocupacao" name="custoDesocupacao" value="${formatMoney(dados.custoDesocupacao)}" class="macos-input currency-input">
                                    </div>
                                    <div class="macos-form-group">
                                        <label class="macos-form-label">Condomínio (Mensal)</label>
                                        <input type="text" id="edit-condominioMensal" name="condominioMensal" value="${formatMoney(dados.condominioMensal)}" class="macos-input currency-input">
                                    </div>
                                    <div class="macos-form-group">
                                        <label class="macos-form-label">IPTU (Mensal)</label>
                                        <input type="text" id="edit-iptuMensal" name="iptuMensal" value="${formatMoney(dados.iptuMensal)}" class="macos-input currency-input">
                                    </div>
                                    <div class="macos-form-group">
                                        <label class="macos-form-label">Seguro Fixo</label>
                                        <input type="text" id="edit-taxaSeguroCaixa" name="taxaSeguroCaixa" value="${formatMoney(dados.taxaSeguroCaixa)}" class="macos-input currency-input">
                                    </div>
                                    <div class="macos-form-group">
                                        <label class="macos-form-label">Corretagem (%)</label>
                                        <input type="number" step="0.1" id="edit-corretagemPercent" value="${dados.corretagemPercent || 6}" class="macos-input">
                                    </div>
                                </div >
                                `;

                            document.getElementById('modal-editar-conteudo').innerHTML = html;

                            // Abrir modal
                            const modal = document.getElementById('modal-editar-calculo');
                            modal.classList.remove('hidden');

                            // Inicializar máscaras de moeda para os novos inputs
                            if (window.initCurrencyInputs) {
                                window.initCurrencyInputs();
                            }

                            setTimeout(() => {
                                modal.style.opacity = '1';
                                modal.style.pointerEvents = 'auto';
                                modal.querySelector('.macos-window').style.transform = 'scale(1)';
                            }, 10);
                        }

                        function fecharModalEditar() {
                            const modal = document.getElementById('modal-editar-calculo');
                            modal.style.opacity = '0';
                            modal.style.pointerEvents = 'none';
                            modal.querySelector('.macos-window').style.transform = 'scale(0.95)';
                            setTimeout(() => {
                                modal.classList.add('hidden');
                                calculoEditandoId = null;
                            }, 300);
                        }

                        async function salvarEdicaoCalculo() {
                            if (!calculoEditandoId) return;

                            // Helper para obter valor numérico de inputs de moeda (que podem ser text ou hidden)
                            const getCurrencyValue = (id) => {
                                const input = document.getElementById(id);
                                if (!input) return 0;

                                // Se o input tem formato de moeda (texto com R$), precisamos limpar
                                if (input.type === 'text' && input.value.includes('R$')) {
                                    return parseFloat(input.value.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
                                }

                                // Se for o input original hidden (currency-input.js cria hidden com o mesmo nome, mas aqui estamos pegando por ID)
                                // O currency-input.js cria hidden inputs, mas o ID do edit-* é o visível.
                                // Vamos tentar pegar o valor limpo diretamente do input visível.
                                const rawValue = input.value;
                                if (typeof rawValue === 'string') {
                                    return parseFloat(rawValue.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
                                }
                                return parseFloat(rawValue) || 0;
                            };

                            // Coletar dados do formulário
                            const dadosAtualizados = {
                                valorArrematado: getCurrencyValue('edit-valorArrematado'),
                                valorAvaliacao: getCurrencyValue('edit-valorAvaliacao'),
                                valorVendaFinal: getCurrencyValue('edit-valorVendaFinal'),
                                itbi: parseFloat(document.getElementById('edit-itbi').value) || 2,
                                reforma: getCurrencyValue('edit-reforma'),
                                custosCartorarios: getCurrencyValue('edit-custosCartorarios'),
                                debitosPendentes: getCurrencyValue('edit-debitosPendentes'),
                                custoDesocupacao: getCurrencyValue('edit-custoDesocupacao'),
                                condominioMensal: getCurrencyValue('edit-condominioMensal'),
                                iptuMensal: getCurrencyValue('edit-iptuMensal'),
                                taxaSeguroCaixa: getCurrencyValue('edit-taxaSeguroCaixa'),
                                corretagemPercent: parseFloat(document.getElementById('edit-corretagemPercent').value) || 6
                            };

                            try {
                                const response = await fetch(`/api/saved-calculations/${calculoEditandoId}`, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ data: dadosAtualizados })
                                });

                                if (response.ok) {
                                    fecharModalEditar();
                                    alert('Cálculo atualizado com sucesso!');
                                    location.reload(); // Recarregar para mostrar dados atualizados
                                } else {
                                    alert('Erro ao atualizar cálculo');
                                }
                            } catch (error) {
                                console.error('Erro:', error);
                                alert('Erro ao salvar alterações');
                            }
                        }

                        async function deleteCalculation(id) {
                            if (!confirm('Tem certeza que deseja excluir este cálculo? Esta ação não pode ser desfeita.')) return;

                            try {
                                const response = await fetch(`/api/saved-calculations/${id}`, {
                                    method: 'DELETE'
                                });

                                if (response.ok) {
                                    // Remove o elemento da lista visualmente ou recarrega
                                    // Para simplicidade e consistência, vamos recarregar
                                    location.reload();
                                } else {
                                    const data = await response.json();
                                    alert('Erro ao excluir: ' + (data.error || 'Erro desconhecido'));
                                }
                            } catch (error) {
                                console.error('Erro:', error);
                                alert('Erro ao processar a exclusão.');
                            }
                        }

                        // Fechar modal ao clicar fora
                        document.getElementById('modal-editar-calculo')?.addEventListener('click', (e) => {
                            if (e.target.id === 'modal-editar-calculo') {
                                fecharModalEditar();
                            }
                        });

                        // Fechar modal ao clicar fora
                        document.getElementById('modal-detalhes-calculo')?.addEventListener('click', (e) => {
                            if (e.target.id === 'modal-detalhes-calculo') {
                                fecharDetalhesCalculo();
                            }
                        });

                        // Fechar saveModal ao clicar fora
                        // Função Global para Abrir Modal de Salvar
                        window.abrirModalSalvar = function (event) {
                            if (event) {
                                event.preventDefault();
                                event.stopPropagation();
                                event.stopImmediatePropagation();
                            }

                            const modal = document.getElementById('saveModal');
                            if (!modal) return;

                            // Adiciona um listener temporário no documento para bloquear todos os cliques
                            const blockClicks = (e) => {
                                if (!modal.contains(e.target)) {
                                    e.stopPropagation();
                                    e.stopImmediatePropagation();
                                }
                            };

                            // Adiciona o bloqueador na fase de captura (antes de qualquer outro listener)
                            document.addEventListener('click', blockClicks, true);

                            // Remove o bloqueador após 500ms
                            setTimeout(() => {
                                document.removeEventListener('click', blockClicks, true);
                            }, 500);

                            // Mostra o modal usando a classe 'active' (conforme CSS)
                            modal.style.display = 'flex';
                            setTimeout(() => {
                                modal.classList.add('active');
                            }, 10);

                            // Foca no input após o modal aparecer
                            setTimeout(() => {
                                const input = modal.querySelector('input[name="calculationName"]');
                                if (input) input.focus();
                            }, 100);
                        };

                        // Fechar saveModal ao clicar fora
                        document.getElementById('saveModal')?.addEventListener('click', (e) => {
                            // Apenas fecha se clicar exatamente no overlay (fundo)
                            if (e.target.id === 'saveModal') {
                                const modal = document.getElementById('saveModal');
                                modal.classList.remove('active');
                                setTimeout(() => {
                                    modal.style.display = 'none';
                                }, 300); // Aguarda a animação de fade out
                            }
                        });
                    </script>


                    <script>
                        // --- Lógica de Assessoria: Manual x Automática ---
                        window.assessoriaManual = false;

                        function handleAssessoriaInput(input) {
                            // 1. Formatar moeda
                            if (typeof formatCurrencyInput === 'function') {
                                formatCurrencyInput(input);
                            }

                            // 2. Atualizar input oculto (Raw)
                            if (typeof parseCurrency === 'function') {
                                const rawVal = parseCurrency(input.value);
                                const hidden = document.getElementById('valorAssessoriaHidden');
                                if (hidden) hidden.value = rawVal;
                            }

                            // 3. Setar Flag Manual
                            if (input.value && input.value !== '') {
                                window.assessoriaManual = true;
                            } else {
                                // Se limpar, volta para o automático
                                window.assessoriaManual = false;
                                updateAssessoriaFromRule();
                            }
                        }

                        function updateAssessoriaFromRule() {
                            if (window.assessoriaManual) return;

                            // Obter valor do Arremate
                            let arremateVal = 0;
                            const arremateHidden = document.querySelector('input[name="valorArrematado"]');
                            if (arremateHidden) {
                                arremateVal = parseFloat(arremateHidden.value) || 0;
                            } else {
                                // Fallback se não usar currency script
                                const arremateInput = document.querySelector('input[name="valorArrematado"]');
                                if (arremateInput) arremateVal = parseFloat(arremateInput.value) || 0;
                            }

                            // Obter Regras
                            const getVal = (id, def) => {
                                const el = document.getElementById(id);
                                return el ? (parseFloat(el.value) || def) : def;
                            };

                            const threshold = getVal('assessoriaThreshold', 120000);
                            const feeBelow = getVal('assessoriaFeeBelow', 6000);
                            const feeAbovePercent = getVal('assessoriaFeeAbovePercent', 5);

                            // Calcular
                            let fee = 0;
                            if (arremateVal > 0) {
                                if (arremateVal <= threshold) {
                                    fee = feeBelow;
                                } else {
                                    fee = (arremateVal * feeAbovePercent) / 100;
                                }
                            }
                            // Arredondar
                            fee = Math.round((fee + Number.EPSILON) * 100) / 100;

                            // Atualizar Inputs
                            const display = document.getElementById('assessoriaDisplay');
                            const hidden = document.getElementById('valorAssessoriaHidden');

                            if (display && hidden) {
                                hidden.value = fee > 0 ? fee : '';
                                if (typeof formatCurrencyValue === 'function') {
                                    display.value = fee > 0 ? formatCurrencyValue(fee) : '';
                                } else {
                                    display.value = fee > 0 ? fee.toFixed(2).replace('.', ',') : '';
                                }
                            }
                        }

                        // Listener para mudanças no Valor do Arremate
                        document.addEventListener('input', function (e) {
                            // Verifica se é o input visível do Arremate (irmão do hidden)
                            const nextSibling = e.target.nextElementSibling;
                            if (nextSibling && nextSibling.name === 'valorArrematado') {
                                setTimeout(updateAssessoriaFromRule, 50); // Leve delay para garantir atualização do hidden
                            }
                        });
                    </script>

                    <script>
                        console.log('Script de auto-preenchimento carregado (v3 - Currency Compatible)');

                        function parseMoney(val) {
                            if (typeof val === 'number') return val;
                            if (!val) return 0;
                            return parseFloat(val.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
                        }

                        document.addEventListener('input', function (e) {
                            // Verifica se o elemento atual é o input visível do Valor do Arremate
                            // O script currency-input.js remove o ID/Name do visível e cria um hidden logo depois com o name original.
                            const nextSibling = e.target.nextElementSibling;

                            if (nextSibling && nextSibling.name === 'valorArrematado') {
                                const rawValue = e.target.value;
                                const valor = parseMoney(rawValue);

                                // console.log('Valor Arremate detectado:', valor);

                                // Helper para encontrar o input visível baseado no name do hidden
                                const getVisibleInput = (name) => {
                                    const hidden = document.querySelector(`input[name = "${name}"]`);
                                    return hidden ? hidden.previousElementSibling : null;
                                };

                                const entradaVisible = getVisibleInput('valorEntrada');
                                const financiadoVisible = getVisibleInput('valorFinanciado');
                                const parcelaVisible = getVisibleInput('custoMensalFinanciamento');

                                const updateField = (visibleInput, val) => {
                                    if (visibleInput) {
                                        // Seta o valor formatado (toFixed(2)) e dispara input para o currency-input.js formatar e salvar no hidden
                                        visibleInput.value = val.toFixed(2);
                                        visibleInput.dispatchEvent(new Event('input', { bubbles: true }));
                                    }
                                };

                                // Regra: Entrada 5%
                                updateField(entradaVisible, valor * 0.05);

                                // Regra: Financiado 95%
                                const financiado = valor * 0.95;
                                updateField(financiadoVisible, financiado);

                                // Regra: Parcela 1.05% do Financiado
                                updateField(parcelaVisible, financiado * 0.0105);
                            }
                        });
                    </script>

                    <!-- Modal Configuração Assessoria (V2 - Moved to End of Body) -->
                    <div id="assessoriaModalV2" class="macos-modal-overlay"
                        style="display: none; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 99999;">
                        <div class="macos-window" onclick="event.stopPropagation()"
                            style="width: 400px; background: var(--macos-bg-secondary); border-radius: 16px; box-shadow: 0 25px 50px rgba(0,0,0,0.4); display: flex; flex-direction: column;">
                            <div
                                style="padding: 24px 28px; border-bottom: 1px solid var(--macos-divider); display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="font-size: 20px; font-weight: 700; color: var(--macos-text-primary);">
                                    Configurar Assessoria</h3>
                                <button onclick="fecharModalAssessoriaV2()"
                                    style="width: 32px; height: 32px; border-radius: 50%; background: var(--macos-bg-tertiary); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;"
                                    onmouseover="this.style.background='rgba(255,59,48,0.1)'; this.querySelector('i').style.color='#FF3B30';"
                                    onmouseout="this.style.background='var(--macos-bg-tertiary)'; this.querySelector('i').style.color='var(--macos-text-secondary)';">
                                    <i class="fa-solid fa-xmark"
                                        style="color: var(--macos-text-secondary); font-size: 16px;"></i>
                                </button>
                            </div>

                            <div style="padding: 28px; flex: 1;">
                                <p style="font-size: 14px; color: var(--macos-text-secondary); margin-bottom: 24px;">
                                    Defina a regra de cobrança da assessoria.</p>

                                <div style="display: grid; gap: 20px;">
                                    <div class="macos-form-group">
                                        <label class="macos-form-label">Valor Limite</label>
                                        <div class="macos-input-wrapper" style="position: relative;">
                                            <span
                                                style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--macos-text-secondary); font-size: 14px;">R$</span>
                                            <input type="text" id="modalAssessoriaThreshold" class="macos-input"
                                                oninput="formatCurrencyInput(this)" style="padding-left: 36px;"
                                                placeholder="120.000,00">
                                        </div>
                                        <p
                                            style="font-size: 12px; color: var(--macos-text-secondary); margin-top: 6px;">
                                            Até este valor, será cobrada uma taxa fixa.</p>
                                    </div>

                                    <div class="macos-form-group">
                                        <label class="macos-form-label">Taxa Fixa</label>
                                        <div class="macos-input-wrapper" style="position: relative;">
                                            <span
                                                style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--macos-text-secondary); font-size: 14px;">R$</span>
                                            <input type="text" id="modalAssessoriaFeeBelow" class="macos-input"
                                                oninput="formatCurrencyInput(this)" style="padding-left: 36px;"
                                                placeholder="6.000,00">
                                        </div>
                                        <p
                                            style="font-size: 12px; color: var(--macos-text-secondary); margin-top: 6px;">
                                            Valor cobrado se o arremate for ≤ limite.</p>
                                    </div>

                                    <div class="macos-form-group">
                                        <label class="macos-form-label">Porcentagem Acima do Limite</label>
                                        <div class="macos-input-wrapper" style="position: relative;">
                                            <input type="number" step="0.1" id="modalAssessoriaFeeAbovePercent"
                                                class="macos-input" style="padding-right: 30px;" placeholder="5">
                                            <span
                                                style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--macos-text-secondary); font-size: 14px;">%</span>
                                        </div>
                                        <p
                                            style="font-size: 12px; color: var(--macos-text-secondary); margin-top: 6px;">
                                            % sobre o total se ultrapassar o limite.</p>
                                    </div>
                                </div>
                            </div>

                            <div
                                style="padding: 20px 28px; background: var(--macos-bg-tertiary); border-radius: 0 0 16px 16px; border-top: 1px solid var(--macos-divider); display: flex; justify-content: flex-end; gap: 12px;">
                                <button type="button" class="macos-btn-secondary"
                                    onclick="fecharModalAssessoriaV2()">Cancelar</button>
                                <button type="button" class="macos-btn-primary"
                                    onclick="saveAssessoriaConfigV2()">Confirmar</button>
                            </div>
                        </div>
                    </div>

                    <script>
                        function abrirModalAssessoriaV2() {
                            console.log('🔵 abrirModalAssessoriaV2 CHAMADA');
                            const modal = document.getElementById('assessoriaModalV2');
                            console.log('🔵 Modal encontrado:', modal);

                            if (!modal) {
                                console.error('❌ Modal assessoriaModalV2 não encontrado!');
                                return;
                            }

                            modal.style.display = 'flex';
                            // Force reflow to ensure the display change is applied before adding the class
                            modal.offsetHeight;
                            // Add active class to trigger opacity: 1
                            modal.classList.add('active');
                            console.log('🔵 Modal display definido como flex e classe active adicionada');

                            // Sync current values
                            const threshold = document.getElementById('assessoriaThreshold').value;
                            const feeBelow = document.getElementById('assessoriaFeeBelow').value;

                            console.log('🔵 Valores - threshold:', threshold, 'feeBelow:', feeBelow);

                            if (window.formatCurrencyValue) {
                                document.getElementById('modalAssessoriaThreshold').value = formatCurrencyValue(threshold);
                                document.getElementById('modalAssessoriaFeeBelow').value = formatCurrencyValue(feeBelow);
                            }
                            document.getElementById('modalAssessoriaFeeAbovePercent').value = document.getElementById('assessoriaFeeAbovePercent').value;

                            console.log('🔵 Modal aberto com sucesso');

                            // Observer para detectar mudanças no estilo
                            const observer = new MutationObserver((mutations) => {
                                mutations.forEach((mutation) => {
                                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                                        console.log('⚠️ ESTILO DO MODAL MUDOU!');
                                        console.log('⚠️ Novo display:', modal.style.display);
                                        console.trace('Stack trace da mudança:');
                                    }
                                });
                            });

                            observer.observe(modal, { attributes: true, attributeFilter: ['style'] });

                            // Desconecta após 5 segundos
                            setTimeout(() => observer.disconnect(), 5000);
                        }

                        function fecharModalAssessoriaV2() {
                            console.log('🔴 fecharModalAssessoriaV2 CHAMADA');
                            console.trace('Stack trace do fechamento:');
                            const modal = document.getElementById('assessoriaModalV2');
                            modal.classList.remove('active');
                            modal.style.display = 'none';
                        }

                        function saveAssessoriaConfigV2() {
                            const thresholdStr = document.getElementById('modalAssessoriaThreshold').value;
                            const feeBelowStr = document.getElementById('modalAssessoriaFeeBelow').value;
                            const feeAbove = document.getElementById('modalAssessoriaFeeAbovePercent').value;

                            const threshold = parseCurrency(thresholdStr);
                            const feeBelow = parseCurrency(feeBelowStr);

                            document.getElementById('assessoriaThreshold').value = threshold;
                            document.getElementById('assessoriaFeeBelow').value = feeBelow;
                            document.getElementById('assessoriaFeeAbovePercent').value = feeAbove;

                            // Recalcular assessoria com as novas regras (se não for manual)
                            if (typeof updateAssessoriaFromRule === 'function') {
                                updateAssessoriaFromRule();
                            }

                            fecharModalAssessoriaV2();
                        }
                    </script>
</body>

</html>