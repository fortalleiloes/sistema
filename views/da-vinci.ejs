<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <title>Gerador de Proposta - Fortal</title>
    <%- include('partials/head') %>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Merriweather:ital,wght@0,300;0,700;1,300&display=swap"
            rel="stylesheet">
        <style>
            .screen-only-hide {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
                height: 0 !important;
                width: 0 !important;
                overflow: hidden !important;
                position: absolute !important;
                z-index: -9999 !important;
                pointer-events: none !important;
                top: -9999px !important;
                left: -9999px !important;
            }

            @media print {
                .screen-only-hide {
                    display: block !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    height: auto !important;
                    width: 100% !important;
                    position: absolute !important;
                    z-index: 9999 !important;
                    top: 0 !important;
                    left: 0 !important;
                }
            }

            /* Utility to force hide elements during print via JS */
            @media print {
                .force-print-hidden {
                    display: none !important;
                    visibility: hidden !important;
                    opacity: 0 !important;
                }
            }

            /* PREMIUM PDF DESIGN SYSTEM (Da Vinci 2.0) */
            /* FORCE SITE FONT GLOBAL OVERRIDE */
            :root {
                --font-primary: var(--macos-font-system);
            }

            body,
            .font-serif,
            .pdf-serif,
            .font-sans,
            .pdf-sans,
            p,
            div,
            span,
            strong,
            b {
                font-family: var(--macos-font-system) !important;
                letter-spacing: -0.02em;
            }

            h1,
            h2,
            h3,
            h4,
            h5,
            h6 {
                font-family: var(--macos-font-heading) !important;
            }

            /* Base PDF Font Settings */
            .pdf-sans {
                font-family: var(--macos-font-system) !important;
            }

            .pdf-serif {
                font-family: var(--macos-font-heading) !important;
            }

            /* Screen Only Styles */
            .page-container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 24px;
            }

            /* UI STYLES (Screen) - DARK MODE COMPATIBLE */
            .step-card {
                background: var(--macos-bg-window, #ffffff);
                border-radius: 12px;
                padding: 24px;
                margin-bottom: 24px;
                border: 1px solid var(--macos-border, #e5e7eb);
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
                color: var(--macos-text-primary, #000000);
            }

            .step-header {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 20px;
                border-bottom: 1px solid var(--macos-divider, #f3f4f6);
                padding-bottom: 16px;
            }

            .step-number {
                width: 32px;
                height: 32px;
                background: #FFD60A;
                color: black;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 800;
                font-size: 14px;
                flex-shrink: 0;
            }

            .step-title {
                font-size: 18px;
                font-weight: 700;
                color: var(--macos-text-primary, #111827);
                margin: 0;
            }

            /* Inputs Form Styles */
            label {
                display: block;
                font-size: 13px;
                font-weight: 600;
                color: var(--macos-text-secondary, #374151);
                margin-bottom: 6px;
            }

            input[type="text"],
            input[type="number"],
            textarea,
            select {
                width: 100%;
                padding: 10px 12px;
                border: 1px solid var(--macos-border, #d1d5db);
                border-radius: 6px;
                font-size: 14px;
                transition: all 0.2s;
                background-color: var(--macos-bg-tertiary, #ffffff);
                color: var(--macos-text-primary, #000000);
            }

            input:focus,
            textarea:focus,
            select:focus {
                outline: none;
                border-color: #FFD60A;
                box-shadow: 0 0 0 3px rgba(255, 214, 10, 0.1);
            }

            ::placeholder {
                color: var(--macos-text-tertiary, #9ca3af);
            }

            /* Dark Mode Specific Overrides just in case variables fail */
            html.dark .step-card {
                background-color: #1c1c1e;
                border-color: #2c2c2e;
            }

            html.dark input,
            html.dark textarea,
            html.dark select {
                background-color: #2c2c2e;
                /* um pouco mais claro que o card */
                border-color: #3f3f46;
                color: white;
            }

            html.dark .step-title {
                color: white;
            }

            html.dark label {
                color: #a1a1aa;
            }

            html.dark input::placeholder {
                color: #9ca3af;
            }

            html.dark label,
            html.dark .text-gray-600,
            html.dark .text-gray-700 {
                color: #d1d5db !important;
            }

            html.dark .bg-blue-50 {
                background-color: rgba(30, 58, 138, 0.2);
            }

            html.dark .border-blue-100 {
                border-color: #1e40af;
            }

            html.dark .text-blue-900 {
                color: #dbeafe;
            }

            html.dark .hover\:bg-gray-50:hover {
                background-color: #374151;
            }

            /* LIVE PREVIEW STYLES (Screen Only) */
            @media screen {
                #pdf-content {
                    position: absolute;
                    left: -9999px;
                    visibility: hidden;
                }

                #pdf-preview-container {
                    display: block;
                }
            }




            /* PRINT & PDF STYLES and CORE SHEET DEFINITION */
            .pdf-sheet {
                /* GEOMETRY */
                width: 210mm !important;
                height: 296mm !important;
                /* Reducing 1mm to prevent overflow causing blank pages */
                min-height: 296mm !important;
                max-height: 296mm !important;

                /* APPEARANCE */
                background-color: white !important;
                border-left: 8px solid #FFD60A !important;
                /* PREMIUM SPINE */
                padding: 40px 40px 40px 40px !important;
                /* Standard Internal Padding */
                margin: 0 auto;
                position: relative;
                box-sizing: border-box;
                overflow: hidden !important;
                /* STRICT SAFETY */
                display: block;

                /* PRINT BEHAVIOR */
                page-break-after: always;
                break-after: page;
                break-inside: avoid-page;
                page-break-inside: avoid;
            }

            /* Specific Adjustment for Cover (Page 1) content centering if needed */
            .pdf-sheet.cover-page {
                display: flex;
                flex-direction: column;
                justify-content: center;
            }

            /* Legacy compatibility just in case */
            .pdf-content-page {
                display: none;
                /* Deprecated in favor of pdf-sheet */
            }

            /* Professional Footer */
            .pdf-footer {
                position: absolute;
                bottom: 25px;
                left: 40px;
                right: 40px;
                border-top: 1px solid #f3f4f6;
                padding-top: 12px;
                display: flex;
                justify-content: center;
                align-items: center;
                font-family: 'Inter', sans-serif;
            }

            .pdf-footer-info {
                position: absolute;
                left: 0;
                font-size: 8px;
                color: #9CA3AF;
                text-transform: uppercase;
                letter-spacing: 1px;
                font-weight: 600;
            }

            .pdf-footer-page {
                position: absolute;
                right: 0;
                font-size: 9px;
                color: #111;
                font-weight: 700;
                background: #FFD60A;
                padding: 2px 8px;
                border-radius: 4px;
            }

            .pdf-footer-page::after {
                content: counter(reportPage);
            }

            body {
                counter-reset: reportPage;
            }

            .pdf-content-page .brand-header {
                margin-top: 0 !important;
            }

            .page-break-after-always {
                page-break-after: always;
                break-after: page;
                break-inside: avoid;
                display: block;
                position: relative;
                width: 100% !important;
                max-width: 210mm !important;
                height: 296mm;
                /* Ajuste para evitar criação de folha branca extra */
                padding: 0;
                /* Aumentar margem interna para segurança */
                margin: 0 auto;
                box-sizing: border-box;
                background-color: white;
                overflow: hidden;
            }

            .force-print-bg {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                background-repeat: repeat !important;
                z-index: 0 !important;
                /* Removed experimental image-orientation */
            }

            /* Watermark specific styles */
            .pdf-watermark-bg {
                background-repeat: repeat !important;
                background-position: center !important;
            }

            /* Forçar capitalização em todo o conteúdo PDF */
            #pdf-content span,
            #pdf-content p,
            #pdf-content div,
            #pdf-content td {
                text-transform: capitalize !important;
            }

            /* Exceções para capitalização (URLs, emails, etc se necessário) */
            .lowercase-force {
                text-transform: lowercase !important;
            }

            /* Typography */
            .brand-title {
                font-family: 'Playfair Display', serif;
                font-weight: 700;
                color: #000;
            }

            /* Design Components */
            .brand-header {
                margin-bottom: 2rem;
                position: relative;
            }

            .brand-header-line {
                width: 60px;
                height: 4px;
                background: #FFD60A;
                margin-top: 10px;
                border-radius: 2px;
            }

            .brand-header-title {
                font-family: 'Playfair Display', serif;
                font-size: 2rem;
                font-weight: 700;
                color: #111;
                line-height: 1.1;
                margin: 0;
            }

            .brand-card {
                background: rgba(255, 255, 255, 0.95);
                border: 1px solid #e5e5e5;
                border-radius: 12px;
                padding: 16px;
                position: relative;
                z-index: 10;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
                backdrop-filter: blur(5px);
            }

            .brand-tag {
                background: #000;
                color: #fff;
                font-size: 0.65rem;
                font-weight: 800;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                padding: 4px 8px;
                border-radius: 4px;

                .brand-highlight-text {
                    background: linear-gradient(180deg, transparent 65%, #FFD60A 65%);

                    /* PRINT RESET FINAL FIX V3 */
                    @media print {
                        @page {
                            margin: 0;
                            size: A4 portrait;
                        }

                        html,
                        body {
                            width: 210mm !important;
                            height: 100% !important;
                            margin: 0 !important;
                            padding: 0 !important;
                            background: white !important;
                            overflow: visible !important;
                            display: block !important;
                        }

                        /* HIDE EVERYTHING ELSE */
                        body>*:not(.macos-main-content),
                        .macos-toolbar,
                        .macos-sidebar,
                        .page-container,
                        .no-print,
                        header,
                        aside {
                            display: none !important;
                        }

                        /* PREPARE WRAPPERS */
                        .macos-main-content,
                        main {
                            display: block !important;
                            width: 100% !important;
                            margin: 0 !important;
                            padding: 0 !important;
                            position: static !important;
                            /* Restore flow */
                            background: transparent !important;
                            box-shadow: none !important;
                        }

                        /* PDF CONTENT CONTAINER */
                        #pdf-content {
                            display: block !important;
                            width: 210mm !important;
                            /* Strict A4 width */
                            margin: 0 !important;
                            padding: 0 !important;
                            position: relative !important;
                            left: 0 !important;
                            top: 0 !important;
                        }

                        /* INDIVIDUAL SHEETS */
                        .pdf-sheet {
                            width: 210mm !important;
                            height: 296mm !important;
                            /* Exact A4 height minus tiny buffer if needed, but 296mm is safe */
                            margin: 0 !important;
                            /* FORCE LEFT ALIGNMENT */
                            padding: 40px !important;
                            /* Restore internal padding */
                            box-sizing: border-box !important;
                            page-break-after: always !important;
                            break-after: page !important;
                            background-color: white !important;
                            overflow: hidden !important;
                            border-left: 8px solid #FFD60A !important;
                            position: relative !important;
                        }

                        /* REMOVE BREAK ON LAST PAGE */
                        .pdf-sheet:last-of-type,
                        .pdf-sheet:last-child {
                            page-break-after: auto !important;
                            break-after: auto !important;
                            margin-bottom: 0 !important;
                        }
                    }
                }
            }
        </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-200">
    <%- include('partials/macos-toolbar', { title: 'Gerador de Proposta' , profile_pic_url: user.profile_pic_url }) %>
        <%- include('partials/macos-sidebar', { user: user }) %>

            <!-- MAIN CONTENT WRAPPER -->
            <main class="macos-main-content">
                <!-- INPUT SECTION (Visible on Screen) -->
                <div class="page-container no-print">

                    <!-- Botões de Rascunho -->
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 16px; background: var(--macos-bg-secondary); border-radius: 12px; border: 1px solid var(--macos-divider);">
                        <div>
                            <h3
                                style="font-size: 16px; font-weight: 600; color: var(--macos-text-primary); margin: 0 0 4px 0;">
                                <i class="fa-solid fa-file-pen"
                                    style="margin-right: 8px; color: var(--macos-accent);"></i>
                                Rascunho Automático
                            </h3>
                            <p style="font-size: 13px; color: var(--macos-text-secondary); margin: 0;">
                                Seus dados são salvos automaticamente no navegador
                            </p>
                        </div>


                        <div style="display: flex; gap: 12px;">
                            <button type="button" onclick="salvarRascunho()" class="macos-btn-primary"
                                style="display: flex; align-items: center; gap: 8px;">
                                <i class="fa-solid fa-save"></i>
                                Salvar Rascunho
                            </button>
                            <button type="button" onclick="carregarRascunho()" class="macos-btn-secondary"
                                style="display: flex; align-items: center; gap: 8px;">
                                <i class="fa-solid fa-rotate-left"></i>
                                Carregar Rascunho
                            </button>
                            <button type="button" onclick="limparRascunho()" class="macos-btn-secondary"
                                style="display: flex; align-items: center; gap: 8px; color: #FF3B30;"
                                onmouseover="this.style.background='rgba(255,59,48,0.1)'"
                                onmouseout="this.style.background='var(--macos-bg-tertiary)'">
                                <i class="fa-solid fa-trash"></i>
                                Limpar
                            </button>
                        </div>
                    </div>

                    <div class="step-card">
                        <div class="step-header">
                            <div class="step-number">1</div>
                            <h2 class="step-title">Dados Gerais e Imagens</h2>
                        </div>



                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label>Nome do Condomínio / Bairro</label>
                                <input type="text" id="inputNome" placeholder="Ex: Nome do Condomínio">
                            </div>
                            <div>
                                <label>Endereço Completo</label>
                                <input type="text" id="inputEndereco" placeholder="Ex: Endereço Completo">
                            </div>
                            <div>
                                <label>Número do Bem</label>
                                <input type="text" id="inputBem" placeholder="Ex: 000000000000-0">
                            </div>
                            <div>
                                <label>Licitação Aberta</label>
                                <input type="text" id="inputLicitacao" placeholder="DD/MM/AAAA Às HH:mm" maxlength="19"
                                    oninput="maskDateHour(this)">
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div>
                                <label>Apartamento/Bloco</label>
                                <input type="text" id="inputApto" placeholder="Ex: Apto 00, Bloco X">
                            </div>
                            <div>
                                <label>Metragem</label>
                                <input type="text" id="inputMetragem" placeholder="Ex: 00m²">
                            </div>
                            <div>
                                <label>Quartos</label>
                                <input type="text" id="inputQuartos" placeholder="Ex: 00">
                            </div>
                            <div>
                                <label>Banheiros</label>
                                <input type="text" id="inputBanheiros" placeholder="Ex: 00">
                            </div>
                            <div>
                                <label>Vaga Garagem</label>
                                <input type="text" id="inputVaga" placeholder="Ex: 00">
                            </div>

                            <div>
                                <label>Valor Avaliação (Caixa)</label>
                                <input type="text" id="inputValorAvaliacao"
                                    class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400 currency-input"
                                    placeholder="Ex: R$ 0,00">
                            </div>
                            <div>
                                <label>Condomínio (R$)</label>
                                <input type="text" id="inputCondominio"
                                    class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400 currency-input"
                                    placeholder="Ex: R$ 0,00">
                            </div>
                        </div>

                        <!-- Image Uploads -->
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Fachada -->
                            <div id="dropzone_fileFachada"
                                class="relative border border-dashed border-gray-400 dark:border-gray-600 p-4 rounded text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 outline-none focus:ring-2 focus:ring-[var(--macos-accent)] transition-all"
                                tabindex="0" onclick="handleSmartUploadClick('fileFachada', this)">
                                <button type="button"
                                    class="remove-image-btn absolute top-2 right-2 text-red-500 hover:text-red-700 hidden z-10 bg-white dark:bg-gray-800 rounded-full w-6 h-6 flex items-center justify-center shadow-md"
                                    onclick="removeImage(event, 'fileFachada', 'previewFachada', 'pdfImage')">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                                <p class="text-sm font-bold text-gray-600 dark:text-gray-300">Foto da Fachada (Capa)</p>
                                <p class="text-[10px] text-gray-400 mt-1">Clica para selecionar, Ctrl+V para colar</p>
                                <input type="file" id="fileFachada" class="hidden" accept="image/*"
                                    onchange="previewUpload(this, 'previewFachada', 'pdfImage')">
                                <img id="previewFachada" class="h-32 mx-auto mt-2 object-contain hidden" />
                            </div>

                            <!-- Mapa -->
                            <div id="dropzone_fileMapa"
                                class="relative border border-dashed border-gray-400 dark:border-gray-600 p-4 rounded text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 outline-none focus:ring-2 focus:ring-[var(--macos-accent)] transition-all"
                                tabindex="0" onclick="handleSmartUploadClick('fileMapa', this)">
                                <button type="button"
                                    class="remove-image-btn absolute top-2 right-2 text-red-500 hover:text-red-700 hidden z-10 bg-white dark:bg-gray-800 rounded-full w-6 h-6 flex items-center justify-center shadow-md"
                                    onclick="removeImage(event, 'fileMapa', 'previewMapa', 'pdfMapImage')">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                                <p class="text-sm font-bold text-gray-600 dark:text-gray-300">Foto do Mapa (Pág 2)</p>
                                <p class="text-[10px] text-gray-400 mt-1">Clica para selecionar, Ctrl+V para colar</p>
                                <input type="file" id="fileMapa" class="hidden" accept="image/*"
                                    onchange="previewUpload(this, 'previewMapa', 'pdfMapImage')">
                                <img id="previewMapa" class="h-32 mx-auto mt-2 object-contain hidden" />
                            </div>
                        </div>

                        <div class="mt-4 border-t pt-4 dark:border-gray-700">
                            <p class="text-sm font-bold text-gray-600 dark:text-gray-300 mb-2">Fotos Análise de Mercado
                                (Pág 3 - Max 3)</p>
                            <div class="grid grid-cols-3 gap-4">
                                <!-- Mkt1 -->
                                <div id="dropzone_fileMkt1"
                                    class="relative border border-dashed border-gray-400 dark:border-gray-600 p-2 text-center hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer outline-none focus:ring-2 focus:ring-[var(--macos-accent)] transition-all"
                                    tabindex="0" onclick="handleSmartUploadClick('fileMkt1', this)">
                                    <button type="button"
                                        class="remove-image-btn absolute top-1 right-1 text-red-500 hover:text-red-700 hidden z-10 bg-white dark:bg-gray-800 rounded-full w-5 h-5 flex items-center justify-center shadow-md"
                                        onclick="removeImage(event, 'fileMkt1', 'pMkt1', 'pdfMkt1')">
                                        <i class="fa-solid fa-xmark text-xs"></i>
                                    </button>
                                    <span class="dark:text-gray-300 text-xs block mb-1">Img 1 (Ctrl+V)</span>
                                    <input type="file" id="fileMkt1" class="hidden"
                                        onchange="previewUpload(this, 'pMkt1', 'pdfMkt1')">
                                    <img id="pMkt1" class="h-20 mx-auto hidden">
                                </div>
                                <!-- Mkt2 -->
                                <div id="dropzone_fileMkt2"
                                    class="relative border border-dashed border-gray-400 dark:border-gray-600 p-2 text-center hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer outline-none focus:ring-2 focus:ring-[var(--macos-accent)] transition-all"
                                    tabindex="0" onclick="handleSmartUploadClick('fileMkt2', this)">
                                    <button type="button"
                                        class="remove-image-btn absolute top-1 right-1 text-red-500 hover:text-red-700 hidden z-10 bg-white dark:bg-gray-800 rounded-full w-5 h-5 flex items-center justify-center shadow-md"
                                        onclick="removeImage(event, 'fileMkt2', 'pMkt2', 'pdfMkt2')">
                                        <i class="fa-solid fa-xmark text-xs"></i>
                                    </button>
                                    <span class="dark:text-gray-300 text-xs block mb-1">Img 2 (Ctrl+V)</span>
                                    <input type="file" id="fileMkt2" class="hidden"
                                        onchange="previewUpload(this, 'pMkt2', 'pdfMkt2')">
                                    <img id="pMkt2" class="h-20 mx-auto hidden">
                                </div>
                                <!-- Mkt3 -->
                                <div id="dropzone_fileMkt3"
                                    class="relative border border-dashed border-gray-400 dark:border-gray-600 p-2 text-center hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer outline-none focus:ring-2 focus:ring-[var(--macos-accent)] transition-all"
                                    tabindex="0" onclick="handleSmartUploadClick('fileMkt3', this)">
                                    <button type="button"
                                        class="remove-image-btn absolute top-1 right-1 text-red-500 hover:text-red-700 hidden z-10 bg-white dark:bg-gray-800 rounded-full w-5 h-5 flex items-center justify-center shadow-md"
                                        onclick="removeImage(event, 'fileMkt3', 'pMkt3', 'pdfMkt3')">
                                        <i class="fa-solid fa-xmark text-xs"></i>
                                    </button>
                                    <span class="dark:text-gray-300 text-xs block mb-1">Img 3 (Ctrl+V)</span>
                                    <input type="file" id="fileMkt3" class="hidden"
                                        onchange="previewUpload(this, 'pMkt3', 'pdfMkt3')">
                                    <img id="pMkt3" class="h-20 mx-auto hidden">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 1.5: Company Info (New) -->
                    <div class="step-card mb-4">
                        <div class="step-header">
                            <div class="step-number">2</div>
                            <h2 class="step-title">Informações da Empresa / Rodapé</h2>
                        </div>

                        <!-- Saved Companies Manager -->
                        <div class="mb-6 p-4 rounded-lg flex gap-2 items-end"
                            style="background: var(--macos-bg-secondary); border: 1px solid var(--macos-border);">
                            <div class="flex-grow">
                                <label class="block text-xs font-bold uppercase tracking-wide mb-1"
                                    style="color: var(--macos-text-secondary);">Empresas
                                    Salvas</label>
                                <select id="selectSavedCompany" class="w-full p-2 border rounded text-sm"
                                    onchange="loadCompanyProfile(this.value)">
                                    <option value="">-- Selecione ou Cadastre Nova --</option>
                                </select>
                            </div>
                            <button onclick="saveCompanyProfile()"
                                class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-bold rounded shadow-sm whitespace-nowrap transition-colors">
                                <i class="fa-solid fa-save mr-1"></i> Salvar Empresa
                            </button>
                            <button onclick="deleteCompanyProfile()"
                                class="px-3 py-2 bg-red-100 hover:bg-red-200 text-red-600 rounded shadow-sm transition-colors"
                                title="Excluir Empresa Selecionada">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label>Instagram Comercial</label>
                                <input type="text" id="inputInstagram" placeholder="Ex: @seuinstagram">
                            </div>
                            <div>
                                <label>Nome da Empresa / CRECI (Responsável pela Arrematação)</label>
                                <input type="text" id="inputCreci" placeholder="Ex: Fortal Leilões - CRECI 1234">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label>Texto do Rodapé (Direita)</label>
                            <input type="text" id="inputFooter" placeholder="Ex: Consultoria Especializada em Leilões">
                        </div>

                        <!-- Logo Rodapé -->
                        <div class="mb-4">
                            <label>Logo do Rodapé (Pequena)</label>
                            <div id="dropzone_fileLogoFooter"
                                class="relative border border-dashed border-gray-400 dark:border-gray-600 p-4 rounded text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 outline-none focus:ring-2 focus:ring-[var(--macos-accent)] transition-all"
                                tabindex="0" onclick="handleSmartUploadClick('fileLogoFooter', this)">
                                <button type="button"
                                    class="remove-image-btn absolute top-2 right-2 text-red-500 hover:text-red-700 hidden z-10 bg-white dark:bg-gray-800 rounded-full w-6 h-6 flex items-center justify-center shadow-md"
                                    onclick="removeImage(event, 'fileLogoFooter', 'previewLogoFooter', 'pdfFooterLogo')">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                                <p class="text-sm font-bold text-gray-600 dark:text-gray-300">Logo Pequena (Rodapé)</p>
                                <p class="text-[10px] text-gray-400 mt-1">Clica para selecionar, Ctrl+V para colar</p>
                                <input type="file" id="fileLogoFooter" class="hidden" accept="image/*"
                                    onchange="previewUpload(this, 'previewLogoFooter', 'pdfFooterLogo')">
                                <img id="previewLogoFooter" class="h-12 mx-auto mt-2 object-contain hidden" />
                            </div>
                        </div>
                    </div> <!-- End Company Info -->
                </div>

                <!-- Step 2: Financial Data (Import) -->
                <div
                    class="step-card bg-white dark:bg-gray-800 dark:border-gray-700 transition-colors duration-200 no-print">
                    <div class="step-header border-b border-gray-100 dark:border-gray-700">
                        <div class="step-number">3</div>
                        <h2 class="step-title dark:text-white">Dados Financeiros (Viabilidade)</h2>
                    </div>

                    <div
                        class="bg-blue-50 dark:bg-gray-700 p-4 rounded-lg border border-blue-100 dark:border-gray-600 mb-4">
                        <label class="block text-sm font-medium text-blue-900 dark:text-gray-200 mb-2">Importar de
                            um cálculo
                            salvo:</label>
                        <select id="selectCalculo"
                            class="w-full p-2 border border-blue-200 rounded-lg bg-white dark:bg-gray-800 dark:border-gray-600 dark:text-white"
                            onchange="loadCalculationData(this)">
                            <option value="">Selecione para preencher automaticamente...</option>
                            <% if (savedCalculations && savedCalculations.length> 0) { %>
                                <% savedCalculations.forEach(calc=> { %>
                                    <option value="<%= calc.id %>">
                                        <%= calc.name %> - <%= new Date(calc.created_at).toLocaleDateString('pt-BR') %>
                                    </option>
                                    <% }) %>
                                        <% } %>
                        </select>
                    </div>

                    <!-- Manual Inputs Removed -->



                </div> <!-- Close Step 3 -->

                <!-- PDF PREVIEW SECTION (Separated) -->
                <div class="mb-12 no-print mt-12">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                            <i class="fa-solid fa-eye mr-2"></i>Prévia do PDF (6 Páginas)
                        </h2>
                        <div class="flex gap-3">
                            <button onclick="generateDaVinciPDF()" id="btnGerarPDF"
                                class="bg-gray-900 text-white px-8 py-3 rounded-lg font-bold hover:bg-gray-800 flex items-center gap-2">
                                <i class="fa-solid fa-file-pdf"></i>
                                Gerar PDF Completo
                            </button>
                        </div>
                    </div>

                    <div id="pdf-preview-container" class="space-y-8" style="max-width: 900px; margin: 0 auto;">
                        <!-- As 4 páginas do PDF serão exibidas aqui -->
                    </div>
                </div>

                <!-- PDF CONTENT (Visible on screen for preview, used for print) -->
                <div id="pdf-content" class="font-sans text-black" style="display: block;">

                    <!-- PAGE 1: CAPA PREMIUM -->
                    <div contenteditable="true" spellcheck="false"
                        class="pdf-sheet cover-page flex flex-col justify-center">
                        <div class="absolute inset-0 opacity-[0.1] pointer-events-none force-print-bg pdf-watermark-bg">
                        </div>

                        <div class="relative z-10 w-full flex flex-col h-full py-12">
                            <!-- Header Info -->
                            <div class="flex justify-between items-end border-b-4 border-black pb-6 mb-12">
                                <div>
                                    <p class="text-xs font-bold tracking-[0.2em] uppercase text-gray-400 mb-2">Relatório
                                        de Oportunidade</p>
                                    <div class="max-w-[450px]">
                                        <h1 class="text-4xl font-serif font-black text-black leading-tight break-words"
                                            id="pdfNomeImovel">Nome do Imóvel Premium</h1>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-1">Data
                                        do Leilão</p>
                                    <div class="bg-[#FFD60A] px-4 py-2 font-black text-xl text-black inline-block"
                                        id="pdfLicitacao">--/--/----</div>
                                </div>
                            </div>

                            <!-- Main Image -->
                            <div class="flex items-center justify-center mb-4">
                                <div class="w-full h-[400px] p-2 bg-white border border-gray-100 shadow-2xl relative">
                                    <div class="w-full h-full overflow-hidden relative grayscale-[10%] contrast-[1.1]">
                                        <img id="pdfImage" src="" class="w-full h-full object-cover">
                                    </div>
                                    <!-- Badge Processo -->
                                    <div class="absolute top-6 right-6 bg-black text-white px-4 py-2 shadow-lg">
                                        <p class="text-[10px] uppercase tracking-widest font-bold mb-0.5 opacity-70">
                                            Número do Bem</p>
                                        <p class="font-mono font-bold text-sm" id="pdfBem">00000.0000</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Footer Prices -->
                            <!-- Footer Prices (Redesigned - Standardized) -->
                            <div
                                class="bg-gray-50 border border-gray-100 p-6 rounded-xl flex items-center justify-between shadow-sm">
                                <!-- Market Value -->
                                <div>
                                    <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1">
                                        Avaliação Caixa
                                    </p>
                                    <p class="text-3xl font-serif font-black text-gray-900" id="pdfAvaliacao">
                                        R$ 0,00
                                    </p>
                                </div>

                                <!-- Separator Arrow -->
                                <div class="text-gray-300">
                                    <i class="fa-solid fa-arrow-right text-xl"></i>
                                </div>

                                <!-- Bid Value -->
                                <div class="text-right">
                                    <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1">
                                        Oportunidade (Lance)
                                    </p>
                                    <p class="text-3xl font-serif font-black text-gray-900" id="pdfLance">
                                        R$ 0,00
                                    </p>
                                </div>
                            </div>
                        </div>
                        <!-- Footer with Logo -->
                        <div class="pdf-footer">
                            <div class="pdf-footer-info">Relatório de Análise • Uso Exclusivo</div>
                            <img class="pdfFooterLogo" src=""
                                style="display: none; height: 60px; max-width: 200px; object-fit: contain;">
                            <div class="pdf-footer-page"></div>
                        </div>
                    </div>

                    <!-- PAGE 2: INFORMAÇÕES -->
                    <div class="pdf-sheet" contenteditable="true" spellcheck="false">
                        <div class="absolute inset-0 opacity-[0.1] pointer-events-none force-print-bg pdf-watermark-bg">
                        </div>

                        <div class="brand-header">
                            <h2 class="brand-header-title">Ficha Técnica</h2>
                            <div class="brand-header-line"></div>
                        </div>

                        <!-- Main Location Card -->
                        <div class="brand-card mb-8">
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3">Localização
                                Privilegiada</p>
                            <p class="text-xl font-serif text-gray-900 leading-relaxed flex gap-3 items-start">
                                <i class="fa-solid fa-location-dot mt-1.5 text-[#FFD60A]"></i>
                                <span id="pdfEndereco" class="font-medium capitalize">Endereço Completo do Imóvel</span>
                            </p>
                        </div>

                        <!-- Map Container -->
                        <div class="brand-card p-2 mb-4 !bg-white">
                            <div class="w-full h-[350px] bg-gray-100 rounded-lg overflow-hidden relative">
                                <img id="pdfMapImage" src="" class="w-full h-full object-cover">
                                <div class="absolute inset-0 border border-black/5 pointer-events-none rounded-lg">
                                </div>
                            </div>
                        </div>

                        <!-- Grid Info -->
                        <!-- Grid Info -->
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Metragem -->
                            <div id="cardMetragem"
                                class="brand-card flex items-center gap-4 p-4 bg-gray-50 border border-gray-200 shadow-sm rounded-xl">
                                <div
                                    class="w-12 h-12 rounded-full bg-black flex items-center justify-center text-[#FFD60A] text-2xl flex-shrink-0 shadow-md">
                                    <i class="fa-solid fa-ruler-combined"></i>
                                </div>
                                <div>
                                    <p
                                        class="text-xs text-black uppercase font-extrabold tracking-widest mb-1 opacity-80">
                                        Área Privativa</p>
                                    <p class="text-2xl font-black text-gray-900 leading-none" id="pdfMetragem">-- m²</p>
                                </div>
                            </div>

                            <!-- Quartos -->
                            <div id="cardQuartos"
                                class="brand-card flex items-center gap-4 p-4 bg-gray-50 border border-gray-200 shadow-sm rounded-xl">
                                <div
                                    class="w-12 h-12 rounded-full bg-black flex items-center justify-center text-[#FFD60A] text-2xl flex-shrink-0 shadow-md">
                                    <i class="fa-solid fa-bed"></i>
                                </div>
                                <div>
                                    <p
                                        class="text-xs text-black uppercase font-extrabold tracking-widest mb-1 opacity-80">
                                        Dormitórios</p>
                                    <p class="text-2xl font-black text-gray-900 leading-none" id="pdfQuartos">--</p>
                                </div>
                            </div>

                            <!-- Banheiros -->
                            <div id="cardBanheiros"
                                class="brand-card flex items-center gap-4 p-4 bg-gray-50 border border-gray-200 shadow-sm rounded-xl">
                                <div
                                    class="w-12 h-12 rounded-full bg-black flex items-center justify-center text-[#FFD60A] text-2xl flex-shrink-0 shadow-md">
                                    <i class="fa-solid fa-shower"></i>
                                </div>
                                <div>
                                    <p
                                        class="text-xs text-black uppercase font-extrabold tracking-widest mb-1 opacity-80">
                                        Banheiros</p>
                                    <p class="text-2xl font-black text-gray-900 leading-none" id="pdfBanheiros">--</p>
                                </div>
                            </div>

                            <!-- Vagas -->
                            <div id="cardVaga"
                                class="brand-card flex items-center gap-4 p-4 bg-gray-50 border border-gray-200 shadow-sm rounded-xl">
                                <div
                                    class="w-12 h-12 rounded-full bg-black flex items-center justify-center text-[#FFD60A] text-2xl flex-shrink-0 shadow-md">
                                    <i class="fa-solid fa-car"></i>
                                </div>
                                <div>
                                    <p
                                        class="text-xs text-black uppercase font-extrabold tracking-widest mb-1 opacity-80">
                                        Vagas de Garagem</p>
                                    <p class="text-2xl font-black text-gray-900 leading-none" id="pdfVaga">--</p>
                                </div>
                            </div>

                            <!-- Complemento -->
                            <div id="cardApto"
                                class="brand-card flex items-center gap-4 p-4 bg-gray-50 border border-gray-200 shadow-sm rounded-xl col-span-2">
                                <div
                                    class="w-12 h-12 rounded-full bg-black flex items-center justify-center text-[#FFD60A] text-2xl flex-shrink-0 shadow-md">
                                    <i class="fa-solid fa-building"></i>
                                </div>
                                <div>
                                    <p
                                        class="text-xs text-black uppercase font-extrabold tracking-widest mb-1 opacity-80">
                                        Complemento / Unidade</p>
                                    <p class="text-2xl font-black text-gray-900 leading-none" id="pdfApto">Apto --</p>
                                </div>

                            </div>

                            <!-- Condomínio -->
                            <div id="cardCondominio"
                                class="brand-card flex items-center gap-4 p-4 bg-gray-50 border border-gray-200 shadow-sm rounded-xl col-span-2">
                                <div
                                    class="w-12 h-12 rounded-full bg-black flex items-center justify-center text-[#FFD60A] text-2xl flex-shrink-0 shadow-md">
                                    <i class="fa-solid fa-money-bill-wave"></i>
                                </div>
                                <div>
                                    <p
                                        class="text-xs text-black uppercase font-extrabold tracking-widest mb-1 opacity-80">
                                        Condomínio Mensal</p>
                                    <p class="text-2xl font-black text-gray-900 leading-none" id="pdfCondominio">R$ --
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="pdf-footer">
                            <div class="pdf-footer-info">Relatório de Análise • Uso Exclusivo</div>
                            <img class="pdfFooterLogo" src=""
                                style="display: none; height: 60px; max-width: 200px; object-fit: contain;">
                            <div class="pdf-footer-page"></div>
                        </div>
                    </div>

                    <!-- PAGE 3: MERCADO -->
                    <div class="pdf-sheet" contenteditable="true" spellcheck="false">
                        <div class="absolute inset-0 opacity-[0.1] pointer-events-none force-print-bg pdf-watermark-bg">
                        </div>

                        <div class="brand-header">
                            <h2 class="brand-header-title">Análise de Mercado</h2>
                            <div class="brand-header-line"></div>
                        </div>

                        <div class="space-y-4">
                            <div class="brand-card !p-0 overflow-hidden h-[210px]">
                                <img id="pdfMkt1" src="" class="w-full h-full object-cover">
                            </div>
                            <div class="brand-card !p-0 overflow-hidden h-[210px]">
                                <img id="pdfMkt2" src="" class="w-full h-full object-cover">
                            </div>
                            <div class="brand-card !p-0 overflow-hidden h-[210px]">
                                <img id="pdfMkt3" src="" class="w-full h-full object-cover">
                            </div>
                        </div>
                        <div class="pdf-footer">
                            <div class="pdf-footer-info">Relatório de Análise • Uso Exclusivo</div>
                            <img class="pdfFooterLogo" src=""
                                style="display: none; height: 60px; max-width: 200px; object-fit: contain;">
                            <div class="pdf-footer-page"></div>
                        </div>
                    </div>

                    <!-- PAGE 4: VIABILIDADE FINANCEIRA (REDESIGNED) -->
                    <div class="pdf-sheet" contenteditable="true" spellcheck="false">
                        <div class="absolute inset-0 opacity-[0.1] pointer-events-none force-print-bg pdf-watermark-bg">
                        </div>

                        <div class="brand-header">
                            <h2 class="brand-header-title">Estudo de Viabilidade</h2>
                            <div class="brand-header-line"></div>
                        </div>

                        <!-- DYNAMIC CONTENT CONTAINER -->
                        <div id="pdfViabilityContent" class="space-y-6">
                            <div
                                class="h-96 flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-lg bg-gray-50">
                                <i class="fa-solid fa-calculator text-4xl text-gray-300 mb-4"></i>
                                <p class="text-gray-500 font-bold mb-2">Nenhum cálculo selecionado</p>
                                <p class="text-sm text-gray-400 text-center max-w-xs">Use o menu "Importar de um cálculo
                                    salvo" no topo da página para gerar o estudo financeiro.</p>
                            </div>
                        </div>

                        <div class="pdf-footer">
                            <div class="pdf-footer-info">Relatório de Análise • Uso Exclusivo</div>
                            <img class="pdfFooterLogo" src=""
                                style="display: none; height: 60px; max-width: 200px; object-fit: contain;">
                            <div class="pdf-footer-page"></div>
                        </div>
                    </div>

                    <!-- PAGE 5: CONCLUSÃO -->
                    <div class="pdf-sheet" contenteditable="true" spellcheck="false">
                        <div class="absolute inset-0 opacity-[0.1] pointer-events-none force-print-bg pdf-watermark-bg">
                        </div>

                        <div>
                            <!-- Checklist Header -->
                            <div class="brand-header">
                                <h2 class="brand-header-title">Checklist de Validação</h2>
                                <div class="brand-header-line"></div>
                                <!-- Checklist Cards -->
                                <div class="grid grid-cols-2 gap-6 mb-12">
                                    <div class="brand-card">
                                        <div class="flex items-start gap-4">
                                            <div
                                                class="mt-1 w-5 h-5 rounded-full bg-green-100 flex items-center justify-center text-green-600 text-xs text-center shrink-0">
                                                <i class="fa-solid fa-check"></i>
                                            </div>
                                            <div>
                                                <p class="font-bold text-gray-900 text-sm mb-1">Consulta com
                                                    Corretores
                                                </p>
                                                <p class="text-xs text-gray-500">Validação de preço e liquidez com
                                                    especialistas locais.</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="brand-card">
                                        <div class="flex items-start gap-4">
                                            <div
                                                class="mt-1 w-5 h-5 rounded-full bg-green-100 flex items-center justify-center text-green-600 text-xs shrink-0">
                                                <i class="fa-solid fa-check"></i>
                                            </div>
                                            <div>
                                                <p class="font-bold text-gray-900 text-sm mb-1">Vistoria Técnica</p>
                                                <p class="text-xs text-gray-500">Avaliação presencial ou por imagens
                                                    do
                                                    estado do imóvel.</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="brand-card">
                                        <div class="flex items-start gap-4">
                                            <div
                                                class="mt-1 w-5 h-5 rounded-full bg-green-100 flex items-center justify-center text-green-600 text-xs shrink-0">
                                                <i class="fa-solid fa-check"></i>
                                            </div>
                                            <div>
                                                <p class="font-bold text-gray-900 text-sm mb-1">Comparativo em Sites
                                                </p>
                                                <p class="text-xs text-gray-500">Análise de ofertas similares nos
                                                    principais portais.</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="brand-card">
                                        <div class="flex items-start gap-4">
                                            <div
                                                class="mt-1 w-5 h-5 rounded-full bg-green-100 flex items-center justify-center text-green-600 text-xs shrink-0">
                                                <i class="fa-solid fa-check"></i>
                                            </div>
                                            <div>
                                                <p class="font-bold text-gray-900 text-sm mb-1">Análise Documental
                                                </p>
                                                <p class="text-xs text-gray-500">Conferência da matrícula, edital e
                                                    certidões.</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="brand-card">
                                        <div class="flex items-start gap-4">
                                            <div
                                                class="mt-1 w-5 h-5 rounded-full bg-green-100 flex items-center justify-center text-green-600 text-xs shrink-0">
                                                <i class="fa-solid fa-check"></i>
                                            </div>
                                            <div>
                                                <p class="font-bold text-gray-900 text-sm mb-1">Análise Jurídica</p>
                                                <p class="text-xs text-gray-500">Auditoria processual para segurança
                                                    da
                                                    arrematação.</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="brand-card">
                                        <div class="flex items-start gap-4">
                                            <div
                                                class="mt-1 w-5 h-5 rounded-full bg-green-100 flex items-center justify-center text-green-600 text-xs shrink-0">
                                                <i class="fa-solid fa-check"></i>
                                            </div>
                                            <div>
                                                <p class="font-bold text-gray-900 text-sm mb-1">Levantamento de
                                                    Débitos
                                                </p>
                                                <p class="text-xs text-gray-500">Apuração de IPTU, condomínio e
                                                    outras
                                                    dívidas.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="pdf-footer">
                            <div class="pdf-footer-info">Relatório de Análise • Uso Exclusivo</div>
                            <img class="pdfFooterLogo" src=""
                                style="display: none; height: 60px; max-width: 200px; object-fit: contain;">
                            <div class="pdf-footer-page"></div>
                        </div>
                    </div>

                    <!-- PAGE 6: CONSIDERAÇÕES FINAIS -->
                    <div class="pdf-sheet flex flex-col" contenteditable="true" spellcheck="false">
                        <div class="absolute inset-0 opacity-[0.1] pointer-events-none force-print-bg pdf-watermark-bg">
                        </div>

                        <div class="brand-header">
                            <h2 class="brand-header-title">Considerações Finais</h2>
                            <div class="brand-header-line"></div>
                        </div>

                        <div class="brand-card mb-8">
                            <p class="text-justify text-lg leading-relaxed text-gray-800 font-serif">
                                Este investimento apresenta um potencial significativo de retorno, considerando a
                                valorização da região e os custos envolvidos. A <span
                                    class="font-bold brand-highlight-text">nossa equipe</span> está à disposição para
                                esclarecer quaisquer dúvidas e prosseguir com a estratégia de arrematação com total
                                segurança jurídica e técnica.
                            </p>
                        </div>

                        <!-- Footer Section (Premium Redesign) -->
                        <div class="mt-auto mb-12">
                            <div class="border-t border-gray-100 mb-8 w-full"></div>

                            <div class="flex items-center justify-between">
                                <!-- Left: Company Identity -->
                                <div class="flex items-center gap-6">
                                    <!-- Logo Box - Premium Look -->
                                    <div
                                        class="w-20 h-20 bg-gray-900 rounded-xl flex items-center justify-center shadow-lg transform -rotate-2 border border-gray-700">
                                        <i class="fa-solid fa-city text-3xl text-[#FFD60A]"></i>
                                    </div>

                                    <div class="flex flex-col justify-center">
                                        <div class="flex items-center gap-2 mb-1.5">
                                            <div class="h-[2px] w-6 bg-[#FFD60A]"></div>
                                            <p class="text-[10px] uppercase font-bold text-gray-400 tracking-[0.25em]">
                                                Responsável pelo Estudo</p>
                                        </div>

                                        <h3 class="text-3xl font-serif font-black text-gray-900 leading-none tracking-tight mb-1"
                                            id="pdfCreci">
                                            Nome da Empresa
                                        </h3>

                                        <!-- CRECI Number -->
                                        <p class="text-sm font-bold text-gray-600 mb-3" id="pdfCreciNumero">
                                            CRECI: ----
                                        </p>

                                        <!-- Social & Contact Badge -->
                                        <div class="flex items-center gap-3">
                                            <span
                                                class="bg-gray-50 px-3 py-1.5 rounded-full text-xs font-bold text-gray-600 border border-gray-200 flex items-center gap-2 shadow-sm">
                                                <i class="fa-brands fa-instagram text-pink-600"></i>
                                                <span id="pdfInstagram">@instagram</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Right: Official Disclaimer (Stamp style) -->
                                <div class="text-right max-w-[300px]">
                                    <div
                                        class="inline-block border border-dashed border-gray-300 p-4 rounded-lg bg-gray-50/50">
                                        <p class="text-[9px] text-gray-500 leading-relaxed font-medium text-justify">
                                            <i class="fa-solid fa-lock mr-1 text-gray-400"></i>
                                            <strong>CONFIDENCIAL:</strong> Documento de uso exclusivo do destinatário. A
                                            reprodução parcial ou total deste material sem autorização prévia é
                                            estritamente proibida.
                                        </p>
                                        <p class="text-[8px] text-gray-400 text-center mt-2 pt-2 border-t border-gray-200"
                                            id="pdfFooter">Todos os direitos reservados.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="pdf-footer">
                            <div class="pdf-footer-info">Relatório de Análise • Uso Exclusivo</div>
                            <img class="pdfFooterLogo" src=""
                                style="display: none; height: 60px; max-width: 200px; object-fit: contain;">
                            <div class="pdf-footer-page"></div>
                        </div>
                    </div>
            </main>

            <!-- Libs -->
            <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
            <script src="/js/macos-ui.js"></script>
            <script>
                // Máscara para Data e Hora: DD/MM/AAAA Às HH:mm
                window.maskDateHour = (input) => {
                    let v = input.value.replace(/\D/g, ""); // Remove tudo que não é dígito
                    v = v.substring(0, 12); // Limita a 12 dígitos (DDMMAAAAHHmm)

                    let formatted = "";
                    if (v.length > 0) formatted += v.substring(0, 2);
                    if (v.length > 2) formatted += "/" + v.substring(2, 4);
                    if (v.length > 4) formatted += "/" + v.substring(4, 8);
                    if (v.length > 8) formatted += " Às " + v.substring(8, 10);
                    if (v.length > 10) formatted += ":" + v.substring(10, 12);

                    input.value = formatted;
                };

                // GLOBAL HELPERS
                window.fmt = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(parseFloat(v) || 0);

                window.num = (val) => {
                    if (val === undefined || val === null || val === '') return 0;
                    if (typeof val === 'number') return val;

                    let str = String(val);
                    // Remove currency symbol and whitespace
                    str = str.replace('R$', '').replace(/\s/g, '');

                    if (str.includes(',')) {
                        // PT-BR format: 1.234,56 -> 1234.56
                        const sanitized = str.replace(/\./g, '').replace(',', '.');
                        return parseFloat(sanitized) || 0;
                    }

                    // US/Simple format or plain number string
                    return parseFloat(str) || 0;
                };

                // Shorcut for internal use if you prefer, or just use window.fmt
                const fmt = window.fmt;
                const num = window.num;

                // GLOBAL STATE
                let currentCalcData = {};

                // Sync Inputs to PDF Text with Logic to Hide Empty Fields
                const fields = ['Cliente', 'Nome', 'Bem', 'Licitacao', 'Endereco', 'Apto', 'Metragem', 'Quartos', 'Banheiros', 'Vaga', 'Condominio', 'Instagram', 'Creci', 'Footer'];


                // Fields that trigger card hiding if empty
                const optionalFields = {
                    'Metragem': 'cardMetragem',
                    'Quartos': 'cardQuartos',
                    'Banheiros': 'cardBanheiros',
                    'Vaga': 'cardVaga',
                    'Apto': 'cardApto',
                    'Condominio': 'cardCondominio'
                };

                const updateFieldVisibility = (id, value) => {
                    const cardId = optionalFields[id];
                    if (cardId) {
                        // Use querySelectorAll to target BOTH Preview and Source elements (due to ID duplication from cloning)
                        const cards = document.querySelectorAll(`[id="${cardId}"]`);
                        cards.forEach(card => {
                            if (!value || value.trim() === '') {
                                card.style.display = 'none';
                            } else {
                                card.style.display = ''; // Reverts to CSS (flex)
                            }
                        });
                    }
                };

                // Campos que precisam de unidades/sufixos
                const fieldSuffixes = {
                    'Metragem': ' m²',
                    'Quartos': '',
                    'Banheiros': '',
                    'Vaga': ''
                };

                fields.forEach(id => {
                    const input = document.getElementById('input' + id);
                    if (input) {
                        // Initialize visibility on load
                        updateFieldVisibility(id, input.value);

                        input.addEventListener('input', (e) => {
                            let val = e.target.value;

                            // 1. Update Text with Suffixes and Capitalization logic
                            // Special handling for 'Nome' which updates Title and Subtitle areas if needed
                            const targetId = 'pdf' + (id === 'Nome' ? 'NomeImovel' : id);
                            const targets = document.querySelectorAll(`[id="${targetId}"]`);

                            targets.forEach(target => {
                                // Adicionar sufixo se existir e se houver valor
                                let displayVal = val;

                                // Force Capitalization for Names
                                if ((id === 'Cliente' || id === 'Nome') && displayVal) {
                                    displayVal = displayVal.toLowerCase().replace(/(?:^|\s)\S/g, function (a) { return a.toUpperCase(); });
                                }

                                // Handling específico para evitar duplicação de unidades se o usuário digitar
                                if (id === 'Metragem' && val && !val.toLowerCase().includes('m')) {
                                    displayVal += ' m²';
                                }

                                // Default fallback (syncs with sync function logic)
                                if (!displayVal) displayVal = (id === 'Metragem') ? '-- m²' : '--';

                                target.innerText = displayVal;
                            });

                            // 2. Handle Creci/Company Name special update in text body
                            if (id === 'Creci') {
                                const companyName = val.split('-')[0].trim();
                                const textTargets = document.querySelectorAll('[id="pdfCompanyInText"]');
                                textTargets.forEach(el => el.innerText = companyName || "Sua Empresa");

                                // Extract and display CRECI number
                                const creciPart = val.split('-')[1]?.trim() || '';
                                const creciTargets = document.querySelectorAll('[id="pdfCreciNumero"]');
                                creciTargets.forEach(el => {
                                    if (creciPart) {
                                        el.innerText = creciPart;
                                        el.style.display = 'block';
                                    } else {
                                        el.style.display = 'none';
                                    }
                                });
                            }

                            // 3. Update Visibility for Optional Cards (All instances)
                            updateFieldVisibility(id, val);
                        });
                    }
                });

                function removeImage(e, inputId, previewId, pdfTargetId) {
                    if (e) e.stopPropagation();

                    // 1. Reset Input
                    const input = document.getElementById(inputId);
                    if (input) input.value = '';

                    // 2. Hide Preview
                    const preview = document.getElementById(previewId);
                    if (preview) {
                        preview.classList.add('hidden');
                        preview.src = '';
                        if (preview.style.backgroundImage) preview.style.backgroundImage = '';
                    }

                    // 3. Clear PDF Target (if exists)
                    if (pdfTargetId) {
                        let elements = document.querySelectorAll(`[id="${pdfTargetId}"]`);
                        if (elements.length === 0) elements = document.querySelectorAll(`.${pdfTargetId}`);

                        elements.forEach(el => {
                            el.src = '';
                            if (el.style.backgroundImage) el.style.backgroundImage = '';
                            el.classList.add('hidden');
                        });
                    }

                    // 4. Hide Delete Button
                    if (e && e.currentTarget) {
                        e.currentTarget.classList.add('hidden');
                    }

                    // Special case for watermark
                    // Special case for footer logo
                    if (inputId === 'fileLogoFooter') {
                        currentLogoBase64 = null;

                        // Explicitly clear PDF target logic just in case
                        const pdfLogos = document.querySelectorAll('.pdfFooterLogo');
                        pdfLogos.forEach(img => {
                            img.src = "";
                            img.style.display = 'none';
                        });
                    }
                }

                // Image Preview Handler
                function previewUpload(input, previewId, pdfTargetId) {
                    if (input.files && input.files[0]) {
                        // Use createImageBitmap to enforce EXIF orientation baking
                        // This is supported in modern browsers and correctly handles "imageOrientation: from-image" default
                        createImageBitmap(input.files[0])
                            .then(bitmap => {
                                const canvas = document.createElement('canvas');
                                canvas.width = bitmap.width;
                                canvas.height = bitmap.height;
                                const ctx = canvas.getContext('2d');

                                // Draw the pre-orientated bitmap
                                ctx.drawImage(bitmap, 0, 0);

                                const cleanDataUrl = canvas.toDataURL('image/png');

                                // CRITICAL: Update global state if this is the footer logo
                                if (input.id === 'fileLogoFooter') {
                                    currentLogoBase64 = cleanDataUrl;
                                }

                                const preview = document.getElementById(previewId);
                                if (preview.tagName === 'IMG') {
                                    preview.src = cleanDataUrl;
                                } else {
                                    preview.style.backgroundImage = `url(${cleanDataUrl})`;
                                }
                                preview.classList.remove('hidden');

                                if (pdfTargetId) {
                                    let elements = document.querySelectorAll(`[id="${pdfTargetId}"]`);
                                    if (elements.length === 0) {
                                        // Fallback to class selector
                                        elements = document.querySelectorAll(`.${pdfTargetId}`);
                                    }
                                    elements.forEach(el => {
                                        if (el.tagName === 'IMG') {
                                            el.src = cleanDataUrl;
                                            el.style.transform = 'none';
                                            el.style.rotate = '0deg';
                                        } else {
                                            el.style.backgroundImage = `url(${cleanDataUrl})`;
                                            el.style.transform = 'none';
                                        }
                                        el.classList.remove('hidden');
                                        el.style.display = 'block'; // Force visibility
                                    });
                                }

                                // SHOW DELETE BUTTON
                                if (input.parentElement) {
                                    const btn = input.parentElement.querySelector('.remove-image-btn');
                                    if (btn) btn.classList.remove('hidden');
                                }
                            })
                            .catch(err => {
                                console.error("Bitmap Error, fallback to FileReader:", err);
                                const img = new Image();
                                img.onload = function () {
                                    const canvas = document.createElement('canvas');
                                    canvas.width = img.width;
                                    canvas.height = img.height;
                                    const ctx = canvas.getContext('2d');
                                    ctx.drawImage(img, 0, 0);
                                    const cleanDataUrl = canvas.toDataURL('image/png');

                                    // CRITICAL: Update global state
                                    if (input.id === 'fileLogoWatermark') {
                                        currentLogoBase64 = cleanDataUrl;
                                    }

                                    const preview = document.getElementById(previewId);
                                    if (preview.tagName === 'IMG') preview.src = cleanDataUrl;
                                    else preview.style.backgroundImage = `url(${cleanDataUrl})`;
                                    preview.classList.remove('hidden');

                                    if (pdfTargetId) {
                                        let elements = document.querySelectorAll(`[id="${pdfTargetId}"]`);
                                        if (elements.length === 0) {
                                            elements = document.querySelectorAll(`.${pdfTargetId}`);
                                        }
                                        elements.forEach(el => {
                                            if (el.tagName === 'IMG') {
                                                el.src = cleanDataUrl;
                                                el.style.display = 'block';
                                            }
                                            else el.style.backgroundImage = `url(${cleanDataUrl})`;

                                            el.classList.remove('hidden');
                                        });
                                    }
                                };
                                img.src = URL.createObjectURL(input.files[0]);
                            });
                    }
                }

                // --- Company Profile Management (LocalStorage) ---
                let currentLogoBase64 = null;

                // Helper to sanitize Base64 (strip EXIF/Rotation) on load
                function sanitizeBase64Image(base64) {
                    return new Promise((resolve) => {
                        if (!base64) return resolve(null);

                        const img = new Image();
                        img.onload = function () {
                            // Use Standard Canvas Draw (Avoid createImageBitmap on iOS)
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            resolve(canvas.toDataURL('image/png'));
                        };
                        img.onerror = () => resolve(base64); // If fail, return original
                        img.src = base64;
                    });
                }

                function getSavedProfiles() {
                    try {
                        return JSON.parse(localStorage.getItem('savedCompanies') || '[]');
                    } catch (e) {
                        console.error("Erro ao acessar localStorage", e);
                        return [];
                    }
                }

                // --- SMART UPLOAD LOGIC ---
                // Setup paste listeners for all dropzones
                document.querySelectorAll('[id^="dropzone_"]').forEach(zone => {
                    zone.addEventListener('paste', handlePasteEvent);
                });

                function handleSmartUploadClick(inputId, zoneElement) {
                    if (document.activeElement === zoneElement) {
                        // Already focused (2nd click) -> Open File Dialog
                        document.getElementById(inputId).click();
                    } else {
                        // First click -> Focus
                        zoneElement.focus();
                    }
                }

                function handlePasteEvent(e) {
                    const zone = e.currentTarget;
                    const inputId = zone.id.replace('dropzone_', '');
                    const fileInput = document.getElementById(inputId);

                    // Robust retrieval of clipboard data (works better for Windows screenshots)
                    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                    let file = null;

                    // 1. Try finding in Items (Best for screenshots/blobs)
                    if (items) {
                        for (let i = 0; i < items.length; i++) {
                            if (items[i].type.indexOf("image") !== -1) {
                                file = items[i].getAsFile();
                                break;
                            }
                        }
                    }

                    // 2. Fallback to Files array if items didn't yield file
                    if (!file && e.clipboardData && e.clipboardData.files.length > 0) {
                        file = e.clipboardData.files[0];
                    }

                    if (file && file.type.startsWith('image/')) {
                        e.preventDefault();

                        // Manually assigning files to input (DataTransfer hack)
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        fileInput.files = dataTransfer.files;

                        // Trigger change event manually
                        const event = new Event('change', { bubbles: true });
                        fileInput.dispatchEvent(event);

                        // Visual feedback
                        const originalBg = zone.style.backgroundColor;
                        zone.style.backgroundColor = 'rgba(0, 255, 0, 0.1)';
                        setTimeout(() => zone.style.backgroundColor = originalBg, 300);
                    } else if (items) {
                        // Check if user is trying to paste non-image content into image field
                        // Only alert if we found items but none were images
                        let hasItems = items.length > 0;
                        if (hasItems) {
                            // Verify if it is text
                            let isText = false;
                            for (let i = 0; i < items.length; i++) {
                                if (items[i].type.indexOf("text") !== -1) isText = true;
                            }
                            if (isText && !file) console.log("Pasted content was text, ignoring for image upload.");
                        }
                    }
                }

                // --- EXISTING FUNCTIONS ---   
                function saveCompanyProfile() {
                    const instagram = document.getElementById('inputInstagram').value;
                    const creci = document.getElementById('inputCreci').value;
                    const footer = document.getElementById('inputFooter').value;
                    const select = document.getElementById('selectSavedCompany');

                    if (!instagram && !creci) {
                        alert("Preencha pelo menos o Creci ou Instagram para salvar.");
                        return;
                    }

                    const name = creci.split('-')[0].trim() || "Nova Empresa " + new Date().toLocaleTimeString();
                    let saved = getSavedProfiles();
                    let id = select.value;

                    // If an ID is selected, UPDATE existing. Otherwise CREATE new.
                    if (id) {
                        const index = saved.findIndex(c => c.id === id);
                        if (index !== -1) {
                            saved[index] = { ...saved[index], name, instagram, creci, footer, logo: currentLogoBase64 || saved[index].logo };
                            if (!confirm("Deseja atualizar o perfil existente '" + saved[index].name + "'?")) return;
                        } else {
                            // Fallback if ID not found
                            id = Date.now().toString();
                            saved.push({ id, name, instagram, creci, footer, logo: currentLogoBase64 });
                        }
                    } else {
                        id = Date.now().toString();
                        saved.push({ id, name, instagram, creci, footer, logo: currentLogoBase64 });
                    }

                    localStorage.setItem('savedCompanies', JSON.stringify(saved));

                    refreshCompanySelect();
                    document.getElementById('selectSavedCompany').value = id; // Re-select
                    alert("Empresa salva/atualizada com sucesso!");
                }

                function newCompanyProfile() {
                    document.getElementById('selectSavedCompany').value = "";
                    document.getElementById('inputInstagram').value = "";
                    document.getElementById('inputCreci').value = "";
                    document.getElementById('inputFooter').value = "";

                    // Clear Footer Logo
                    document.getElementById('previewLogoFooter').classList.add('hidden');
                    document.getElementById('previewLogoFooter').src = "";
                    currentLogoBase64 = null;

                    // Clear PDF Footer Logos
                    const pdfLogos = document.querySelectorAll('.pdfFooterLogo');
                    pdfLogos.forEach(img => {
                        img.src = "";
                        img.style.display = 'none';
                    });

                    // Trigger input events to clear PDF preview text
                    ['inputInstagram', 'inputCreci', 'inputFooter'].forEach(id => {
                        document.getElementById(id).dispatchEvent(new Event('input'));
                    });
                }

                function deleteCompanyProfile() {
                    const id = document.getElementById('selectSavedCompany').value;
                    if (!id) return;
                    if (!confirm("Tem certeza que deseja excluir esta empresa salva?")) return;

                    let saved = getSavedProfiles();
                    saved = saved.filter(c => c.id !== id);
                    localStorage.setItem('savedCompanies', JSON.stringify(saved));

                    refreshCompanySelect();
                    newCompanyProfile(); // Reset form
                    alert("Empresa removida.");
                }

                async function loadCompanyProfile(id) {
                    if (!id) {
                        newCompanyProfile(); // Clear if deselecting
                        return;
                    }

                    const saved = getSavedProfiles();
                    const profile = saved.find(c => c.id === id);

                    if (profile) {
                        const setVal = (eid, val) => {
                            const el = document.getElementById(eid);
                            if (el) {
                                el.value = val || '';
                                el.dispatchEvent(new Event('input'));
                            }
                        };

                        setVal('inputInstagram', profile.instagram);
                        setVal('inputCreci', profile.creci);
                        setVal('inputFooter', profile.footer);

                        if (profile.logo) {
                            // Sanitize on load to fix legacy saved profiles
                            // Sanitize on load to fix legacy saved profiles
                            const cleanLogo = await sanitizeBase64Image(profile.logo);
                            currentLogoBase64 = cleanLogo;

                            // Apply to Footer Logo
                            const preview = document.getElementById('previewLogoFooter');
                            if (preview) {
                                preview.src = cleanLogo;
                                preview.classList.remove('hidden');
                            }

                            // Apply to PDF Footers
                            const pdfLogos = document.querySelectorAll('.pdfFooterLogo');
                            pdfLogos.forEach(img => {
                                img.src = cleanLogo;
                                img.classList.remove('hidden');
                                img.style.display = 'block'; // Force visibility
                            });

                            // Optional: Update storage with clean version to avoid re-processing?
                            // For now, just fix the view.
                        }
                    }
                }

                function refreshCompanySelect() {
                    const saved = getSavedProfiles();
                    const select = document.getElementById('selectSavedCompany');
                    if (!select) return;

                    const currentVal = select.value; // Store current selection

                    select.innerHTML = '<option value="">-- Selecione ou Cadastre Nova --</option>';

                    saved.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.id;
                        opt.innerText = c.name;
                        select.appendChild(opt);
                    });

                    // Try to restore selection if it still exists
                    if (currentVal && saved.find(c => c.id === currentVal)) {
                        select.value = currentVal;
                    }
                }

                document.addEventListener('DOMContentLoaded', refreshCompanySelect);

                // Initialize PDF Preview
                // Initialize PDF Preview (Global)
                window.initializePDFPreview = function () {
                    const pdfContent = document.getElementById('pdf-content');
                    const previewContainer = document.getElementById('pdf-preview-container');

                    if (!pdfContent || !previewContainer) return;

                    // Get all PDF sheets (pages)
                    const pages = pdfContent.querySelectorAll('.pdf-sheet');

                    // Clear preview container
                    previewContainer.innerHTML = '';

                    // Clone each page into the preview
                    pages.forEach((page, index) => {
                        const pageWrapper = document.createElement('div');
                        pageWrapper.className = 'pdf-preview-page';
                        // Fix for layout: Scale wrapper to match the scaled content size 
                        // A4 (210mm x 297mm) * 0.85 scale
                        pageWrapper.style.cssText = `
                            width: calc(210mm * 0.85); 
                            height: calc(297mm * 0.85);
                            background: white;
                            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                            border-radius: 8px;
                            overflow: hidden;
                            position: relative;
                            margin: 0 auto; 
                        `;

                        // Add page number badge
                        const badge = document.createElement('div');
                        badge.className = 'page-badge';
                        badge.style.cssText = `
                            position: absolute;
                            top: 16px;
                            right: 16px;
                            background: #FFD60A;
                            color: #000;
                            padding: 6px 12px;
                            border-radius: 20px;
                            font-weight: bold;
                            font-size: 12px;
                            z-index: 1000;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                        `;
                        badge.textContent = `Página ${index + 1} de ${pages.length}`;

                        // Clone the page
                        const clonedPage = page.cloneNode(true);
                        // Reset margins and apply strict scaling from top-left
                        clonedPage.style.cssText = `
                            transform: scale(0.85);
                            transform-origin: top left;
                            margin: 0;
                            width: 210mm;
                            height: 297mm;
                            pointer-events: none; /* Prevent editing in preview */
                        `;

                        pageWrapper.appendChild(badge);
                        pageWrapper.appendChild(clonedPage);
                        previewContainer.appendChild(pageWrapper);
                    });
                };

                // Initialize preview on load and when data changes
                document.addEventListener('DOMContentLoaded', () => {
                    // Initialize financial data with default values
                    setTimeout(() => {
                        updateManualFinancialData();
                        initializePDFPreview();

                        // Force Default Logo through Canvas Cleaner to fix iOS Orientation/Tiling
                        // Only do this if no custom logo is present (which would be handled by other logic ideally, but here we enforce default)
                        // If there IS a custom logo saved in profile, loadCompanyProfile will overwrite this shortly after via refreshCompanySelect->loadCompany.

                        // Fetch default logo to process it
                        fetch('/images/logo-fortal.png')
                            .then(res => res.blob())
                            .then(blob => {
                                const reader = new FileReader();
                                reader.onloadend = () => {
                                    // Use the cleaner function!
                                    if (typeof applyWatermarkFromBase64 === 'function') {
                                        console.log("Applying Default Logo via Canvas Cleaner...");
                                        applyWatermarkFromBase64(reader.result);
                                    }
                                }
                                reader.readAsDataURL(blob);
                            })
                            .catch(err => console.error("Error loading default logo for watermark:", err));

                    }, 500);
                });



                // --- Watermark Logic Refactored (Bottom Logo Strategy) ---
                // User Request: One logo per page, at the bottom.


                // Format Currency Helper (Promoted to Global)

                // Parse currency input to number
                // Parse currency input to number (Handles 1.234,56 and 1234.56)
                // Parse currency input to number (Handles 1.234,56 and 1234.56)
                const parseCurrency = (str) => {
                    if (str === undefined || str === null || str === '') return 0;
                    if (typeof str === 'number') return str;

                    const cleanStr = String(str).replace('R$', '').trim();
                    if (!cleanStr) return 0;

                    // Simple logic: If contains comma, assume PT-BR (1.000,00)
                    // If contains ONLY dots and no commas, assume US/Simple (1000.00)
                    if (cleanStr.includes(',')) {
                        return parseFloat(cleanStr.replace(/\./g, '').replace(',', '.')) || 0;
                    }

                    return parseFloat(cleanStr) || 0;
                };

                // Alias for consistency
                window.num = parseCurrency;



                // GLOBAL STATE (Moved to top)
                // let currentCalcData = {};

                // HELPER: Normalize Data Keys (handle case variations)
                const normalizeKeys = (data) => {
                    const normalized = {};
                    if (!data || typeof data !== 'object') return {};

                    Object.keys(data).forEach(key => {
                        const lowerKey = key.charAt(0).toLowerCase() + key.slice(1);
                        normalized[lowerKey] = data[key];
                        normalized[key] = data[key]; // Keep original
                    });

                    // Extended Mappings for Robustness
                    const mappings = {
                        'lance': 'valorArrematado',
                        'valorLance': 'valorArrematado',
                        'arremate': 'valorArrematado',
                        'valorArremate': 'valorArrematado',
                        'avaliacao': 'valorAvaliacao',
                        'valorAvaliacao': 'valorAvaliacao',
                        'condominio': 'condominioMensal',
                        'venda': 'valorVendaFinal',
                        'valorVenda': 'valorVendaFinal',
                        'iptu': 'iptuMensal'
                    };

                    for (const [alias, target] of Object.entries(mappings)) {
                        if ((normalized[target] === undefined || normalized[target] === 0 || normalized[target] === '') &&
                            (normalized[alias] !== undefined && normalized[alias] !== '')) {
                            normalized[target] = normalized[alias];
                        }
                    }

                    return normalized;
                };

                // LOAD DATA FROM API
                async function loadCalculationData(select) {
                    const id = select.value;
                    const container = document.getElementById('pdfViabilityContent');

                    console.log('🔄 loadCalculationData chamado com ID:', id);
                    if (!id) {
                        console.warn('⚠️ Nenhum ID selecionado');
                        return;
                    }

                    // Loading State
                    if (container) {
                        container.innerHTML = `
                            <div class="h-64 flex flex-col items-center justify-center text-gray-400">
                                <i class="fa-solid fa-circle-notch fa-spin text-3xl mb-3"></i>
                                <p>Carregando dados...</p>
                            </div>
                        `;
                    }

                    try {
                        console.log('📡 Fazendo fetch para /api/saved-calculations...');
                        const response = await fetch('/api/saved-calculations');
                        if (!response.ok) {
                            console.error('❌ API retornou erro:', response.status);
                            throw new Error("Erro na API: " + response.status);
                        }

                        const allCalcs = await response.json();
                        console.log('✅ API retornou', allCalcs.length, 'cálculos');

                        const targetCalc = allCalcs.find(c => c.id == id);

                        if (!targetCalc) {
                            console.error('❌ Cálculo ID', id, 'não encontrado');
                            alert("Cálculo não encontrado.");
                            return;
                        }

                        console.log('✅ Cálculo encontrado:', targetCalc.name);
                        console.log('📦 Dados brutos:', targetCalc.data);

                        // Parse Data (Robust)
                        let rawData = targetCalc.data;
                        try {
                            if (typeof rawData === 'string') {
                                rawData = JSON.parse(rawData);
                            }
                            // Double parse check just in case it was double stringified
                            if (typeof rawData === 'string') {
                                rawData = JSON.parse(rawData);
                            }
                        } catch (e) {
                            console.error("Parse Error:", e);
                            // Verify if it's at least an object, if not, create empty
                            if (typeof rawData !== 'object') rawData = {};
                        }

                        // Final safety check
                        if (!rawData || typeof rawData !== 'object') {
                            console.error("Data is not an object:", rawData);
                            rawData = {};
                        }

                        // Normalize Data (Source of Truth)
                        currentCalcData = normalizeKeys(rawData || {});
                        console.log("Calculation Data Loaded:", currentCalcData);

                        // 1. Update Manual Inputs (Visual Only - Do NOT trigger events)
                        // 1. Update Manual Inputs (AND DISPATCH EVENTS TO WAKE UP UI)
                        const setInput = (id, val) => {
                            const el = document.getElementById(id);
                            if (el) {
                                el.value = window.fmt(val);
                                el.dispatchEvent(new Event('input', { bubbles: true }));
                            }
                        };

                        setInput('inputCondominio', window.num(currentCalcData.condominioMensal));
                        setInput('inputValorAvaliacao', window.num(currentCalcData.valorAvaliacao));
                        setInput('inputValorArremate', window.num(currentCalcData.valorArrematado));

                        // 2. Render Calculation Results
                        if (typeof renderScenarioResults === 'function') renderScenarioResults(currentCalcData);

                        // Success Feedback
                        if (typeof mostrarNotificacao === 'function') mostrarNotificacao("Dados carregados: " + (targetCalc.name || "Cálculo"), "success");

                    } catch (error) {
                        console.error("Load Error:", error);
                        alert("Erro ao carregar: " + error.message);
                        if (container) container.innerHTML = `<p class="text-red-500 text-center p-4">Erro ao carregar: ${error.message}</p>`;
                    }
                }

                // RENDER PDF CONTENT
                function renderScenarioResults(dataOverride) {
                    const container = document.getElementById('pdfViabilityContent');
                    const data = dataOverride || currentCalcData;

                    console.log('🎨 renderScenarioResults running. Data keys:', data ? Object.keys(data).length : 0);

                    if (!data || Object.keys(data).length === 0) {
                        if (container) container.innerHTML = '<p class="text-center text-gray-400 p-8">Dados inválidos ou vazios.</p>';
                        return;
                    }

                    if (!container) return;

                    try {
                        // --- 1. CALCULATIONS ---
                        const getNum = (v) => window.num(v);

                        // Helper for deep search locally
                        const findDeepLocal = (obj, key) => {
                            if (!obj || typeof obj !== 'object') return null;
                            if (obj[key] !== undefined && obj[key] !== null && obj[key] !== '') return obj[key];
                            for (const k in obj) {
                                if (typeof obj[k] === 'object' && obj[k] !== null) {
                                    const val = obj[k][key];
                                    if (val !== undefined && val !== null && val !== '') return val;
                                }
                            }
                            return null;
                        };
                        const getAnyDeepLocal = (...keys) => {
                            for (const k of keys) {
                                const val = findDeepLocal(data, k);
                                if (val) return val;
                            }
                            return null;
                        };

                        // Acquisition Strings
                        const vlrArremate = getNum(data.valorArrematado);
                        const vlrAvaliacao = getNum(data.valorAvaliacao);

                        // Expenses
                        const leiloeiro = (String(data.incluirLeiloeiro) === 'false') ? 0 : vlrArremate * 0.05;
                        const itbiPct = getNum(data.itbi) > 0 ? getNum(data.itbi) / 100 : 0.03;

                        // Try to use explicit saved ITBI value first (for legacy compatibility)
                        let itbi = 0;
                        const savedItbi = getAnyDeep ? getAnyDeep('valorITBI', 'itbi_value') : null;

                        // Force Recalculation (Ignore stale saved values)
                        const itbiBaseRaw = getAnyDeepLocal('itbiBase', 'itbi_base', 'base_itbi');

                        // Determine Base ITBI
                        let baseMode = 'avaliacao'; // Default
                        if (itbiBaseRaw && typeof itbiBaseRaw === 'string') {
                            const s = itbiBaseRaw.toLowerCase().trim();
                            if (s === 'arremate' || s === 'lance') baseMode = 'arremate';
                        }
                        // Safety: If Avaliacao is 0/missing, use Arremate
                        if (vlrAvaliacao <= 0) baseMode = 'arremate';

                        const baseItbi = (baseMode === 'avaliacao') ? vlrAvaliacao : vlrArremate;
                        itbi = baseItbi * itbiPct;
                        const cartorio = getNum(data.custosCartorarios);
                        const reforma = getNum(data.reforma);
                        const debitos = getNum(data.debitosPendentes);
                        const desocupacao = getNum(data.custoDesocupacao);
                        const outros = getNum(data.custosAdicionais);
                        const seguro = vlrArremate > 0 ? 190 : 0; // Only apply if valid property

                        // Assessoria Logic (Default 0 if no value)
                        let assessoria = 0;
                        if (vlrArremate > 0) {
                            // New Standard: 7k up to 140k, then 5%
                            const stdThresh = 140000;
                            const stdFee = 7000;
                            const stdPct = 0.05;

                            if (data.assessoriaThreshold !== undefined) {
                                // Custom Logic from Saved Calc
                                const thresh = getNum(data.assessoriaThreshold) || stdThresh;
                                const feeLow = getNum(data.assessoriaFeeBelow) || stdFee;
                                const feeHighPct = (getNum(data.assessoriaFeeAbovePercent) || 5) / 100;
                                assessoria = vlrArremate <= thresh ? feeLow : vlrArremate * feeHighPct;
                            } else if (data.valorAssessoria && getNum(data.valorAssessoria) > 0) {
                                // Legacy fixed value
                                assessoria = getNum(data.valorAssessoria);
                            } else {
                                // Standard Default
                                assessoria = vlrArremate <= stdThresh ? stdFee : vlrArremate * stdPct;
                            }
                        }

                        // Operational
                        const cond = getNum(data.condominioMensal);
                        const iptu = getNum(data.iptuMensal);
                        const custoMensal = cond + iptu;

                        // Bases
                        const investTotalBasico = vlrArremate + leiloeiro + itbi + cartorio + reforma + debitos + outros;
                        const vendaBase = getNum(data.valorVendaFinal) > 0 ? getNum(data.valorVendaFinal) : vlrAvaliacao;

                        // Details Base (12 Months)
                        const op12 = custoMensal * 12;
                        const invest12 = investTotalBasico + op12 + desocupacao + seguro + assessoria;
                        const bruto12 = vendaBase - (vendaBase * 0.06) - invest12;
                        const imposto12 = bruto12 > 0 ? bruto12 * 0.15 : 0;

                        // --- 2. HTML GENERATION ---
                        const scenarios = [
                            { m: 4, label: 'Venda Rápida' },
                            { m: 8, label: 'Venda Média' },
                            { m: 12, label: 'Venda Longa' },
                            { m: 16, label: 'Venda Tardia' }
                        ];

                        let scenariosHTML = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">';

                        scenarios.forEach(s => {
                            const opCost = custoMensal * s.m;
                            const totalInvest = investTotalBasico + opCost + desocupacao + seguro + assessoria;

                            let vendaCenario = vendaBase;
                            // Use Long Term value if > 12 months
                            if (s.m >= 12 && getNum(data.valorVendaLongo) > 0) {
                                vendaCenario = getNum(data.valorVendaLongo);
                            }

                            const corretagem = vendaCenario * 0.06;
                            const bruto = vendaCenario - corretagem - totalInvest;
                            const imposto = bruto > 0 ? bruto * 0.15 : 0;
                            const liq = bruto - imposto;
                            const roi = totalInvest > 0 ? (liq / totalInvest) * 100 : 0;

                            const isPositive = liq > 0;
                            const color = isPositive ? '#34C759' : '#FF3B30';
                            const borderColor = isPositive ? 'rgba(52, 199, 89, 0.2)' : 'rgba(255, 59, 48, 0.2)';

                            scenariosHTML += `
                                <div style="background: #fff; border-radius: 12px; padding: 20px; position: relative; overflow: hidden; border: 1px solid ${borderColor}; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                                    <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: ${color};"></div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                        <span style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: #6b7280; letter-spacing: 0.5px;">${s.label}</span>
                                        <div style="display: flex; gap: 6px;">
                                            <span style="background: #f3f4f6; padding: 3px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; color: #374151;">${s.m} Meses</span>
                                        </div>
                                    </div>
                                    <div style="margin-bottom: 12px;">
                                        <p style="font-size: 10px; color: #6b7280; margin-bottom: 1px;">Lucro Líquido</p>
                                        <h3 style="font-size: 22px; font-weight: 800; color: ${color}; letter-spacing: -0.5px; margin: 0;">${window.fmt(liq)}</h3>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                        <div>
                                            <p style="font-size: 9px; color: #6b7280; margin-bottom: 1px;">ROI</p>
                                            <p style="font-size: 11px; font-weight: 700; color: ${color}; margin: 0;">${roi.toFixed(2)}%</p>
                                        </div>
                                        <div style="text-align: right;">
                                             <p style="font-size: 9px; color: #6b7280; margin-bottom: 1px;">Investimento</p>
                                             <p style="font-size: 11px; font-weight: 600; color: #111827; margin: 0;">${window.fmt(totalInvest)}</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        scenariosHTML += '</div>';

                        const detailsHTML = `
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px dashed #e5e7eb;">
                                <h3 style="font-size: 14px; font-weight: 700; color: #111827; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.5px;">Detalhamento (Base 12 Meses)</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                                    <div>
                                        <h4 style="font-size: 10px; font-weight: 700; color: #9ca3af; text-transform: uppercase; margin-bottom: 8px;">Aquisição & Custos</h4>
                                        
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 11px;">
                                            <span class="text-gray-500">Valor Arremate</span>
                                            <span class="font-bold text-gray-900">${window.fmt(vlrArremate)}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 11px;">
                                            <span class="text-gray-500">Leiloeiro (5%)</span>
                                            <span class="font-bold text-gray-900">${window.fmt(leiloeiro)}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 11px;">
                                            <span class="text-gray-500">Assessoria</span>
                                            <span class="font-bold text-gray-900">${window.fmt(assessoria)}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 11px;">
                                            <span class="text-gray-500">Reforma/Débitos</span>
                                            <span class="font-bold text-gray-900">${window.fmt(reforma + debitos + desocupacao)}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 11px;">
                                            <span class="text-gray-500">Impostos (ITBI/Cart.)</span>
                                            <span class="font-bold text-gray-900">${window.fmt(itbi + cartorio)}</span>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 style="font-size: 10px; font-weight: 700; color: #9ca3af; text-transform: uppercase; margin-bottom: 8px;">Venda & Resultado</h4>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 11px;">
                                            <span class="text-gray-500">Valor Venda</span>
                                            <span class="font-bold text-green-600">${window.fmt(vendaBase)}</span>
                                        </div>
                                         <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 11px;">
                                            <span class="text-gray-500">Custos Mensais (12x)</span>
                                            <span class="font-bold text-red-500">-${window.fmt(op12)}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 11px;">
                                            <span class="text-gray-500">Imposto Renda (15%)</span>
                                            <span class="font-bold text-red-500">-${window.fmt(imposto12)}</span>
                                        </div>
                                        <div style="border-top: 1px solid #e5e7eb; margin-top: 8px; padding-top: 4px; display: flex; justify-content: space-between; font-size: 12px;">
                                            <span class="font-bold text-gray-900">Resultado Líquido</span>
                                            <span class="font-bold text-green-600">${window.fmt(bruto12 - imposto12)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;

                        container.innerHTML = scenariosHTML + detailsHTML;

                        // --- 3. UPDATE PDF FIELDS ---
                        const setText = (id, txt) => {
                            const params = document.querySelectorAll('#' + id);
                            params.forEach(el => el.textContent = txt);
                        };

                        // Update Financial Fields (these exist in saved calculations)
                        setText('pdfAvaliacao', window.fmt(vlrAvaliacao));
                        setText('pdfLance', window.fmt(vlrArremate));
                        setText('pdfCondominio', window.fmt(cond));

                        console.log('✅ PDF atualizado com:', {
                            avaliacao: window.fmt(vlrAvaliacao),
                            lance: window.fmt(vlrArremate),
                            condominio: window.fmt(cond)
                        });

                        console.log('✅ PDF renderizado com sucesso.');
                        // Refresh Preview
                        setTimeout(() => {
                            if (window.initializePDFPreview) {
                                window.initializePDFPreview();
                                console.log('✅ Preview atualizado');
                            }
                        }, 150);

                    } catch (e) {
                        console.error("Render Error:", e);
                        container.innerHTML = `<p class="text-red-500">Erro de renderização: ${e.message}</p>`;
                    }
                }

                // Update PDF with manual financial data
                function updateManualFinancialData() {
                    // Manual inputs removed. 
                    // Financial data is now strictly handled by loadCalculationData().
                    console.log("Manual update disabled.");
                }

                // Refresh PDF preview after manual data update
                const originalUpdateManual = updateManualFinancialData;
                window.updateManualFinancialData = function () {
                    originalUpdateManual();
                    setTimeout(() => initializePDFPreview(), 100);
                };

                // NEW STRATEGY: Fetch from API on demand
                async function loadCalculationData(select) {
                    const id = select.value;
                    const container = document.getElementById('pdfViabilityContent');

                    if (!id) {
                        // Optional: restore placeholder
                        return;
                    }

                    // 0. Visual Loading Feedback
                    container.innerHTML = `
                        <div class="h-[400px] flex items-center justify-center">
                            <p class="text-xl font-bold text-gray-400 animate-pulse">Carregando dados...</p>
                        </div>
                    `;

                    try {
                        // 1. Fetch Fresh Data (Avoids embedding issues)
                        const response = await fetch('/api/saved-calculations');
                        if (!response.ok) throw new Error("Falha ao buscar cálculos");

                        const allCalcs = await response.json();
                        const targetCalc = allCalcs.find(c => c.id == id);

                        if (!targetCalc) {
                            alert("Cálculo não encontrado.");
                            return;
                        }

                        // 2. Parse Data Safe
                        let data;
                        try {
                            data = typeof targetCalc.data === 'string' ? JSON.parse(targetCalc.data) : targetCalc.data;
                        } catch (e) {
                            console.error("JSON Error:", e);
                            alert("Dados corrompidos.");
                            return;
                        }

                        console.log("Dados carregados via API:", data);



                        // HELPER: Float Parser (Prevents NaN)
                        const num = (val) => {
                            if (val === undefined || val === null || val === '') return 0;
                            if (typeof val === 'string' && val.includes(',')) {
                                const sanitized = val.replace(/\./g, '').replace(',', '.');
                                return parseFloat(sanitized) || 0;
                            }
                            return parseFloat(val) || 0;
                        };

                        // ROBUST EXTRACTION (Key Fallbacks + Deep Search)
                        const findDeep = (obj, key) => {
                            if (!obj || typeof obj !== 'object') return null;

                            // Direct match
                            if (obj[key] !== undefined && obj[key] !== null && obj[key] !== '') return obj[key];

                            // Search in direct children (e.g., data.inputData.valorAvaliacao)
                            for (const k in obj) {
                                if (typeof obj[k] === 'object' && obj[k] !== null) {
                                    const val = obj[k][key];
                                    if (val !== undefined && val !== null && val !== '') return val;
                                }
                            }
                            return null;
                        };

                        const getAnyDeep = (...keys) => {
                            for (const k of keys) {
                                const val = findDeep(data, k);
                                if (val) return val;
                            }
                            return 0;
                        };

                        const rawAvaliacao = getAnyDeep('valorAvaliacao', 'avaliacao', 'valor_avaliacao', 'valorAvaliacaoCaixa');
                        const rawArremate = getAnyDeep('valorArrematado', 'lance', 'valorLance', 'valor_arremate');
                        const rawCondominio = getAnyDeep('condominioMensal', 'condominio', 'valorCondominio');

                        // 1. UPDATE INPUTS
                        if (document.getElementById('inputCondominio')) document.getElementById('inputCondominio').value = fmt(num(rawCondominio));

                        // 2. UPDATE PDF HEADERS
                        // 2. UPDATE PDF HEADERS (Preview AND Source)
                        const setText = (id, txt) => {
                            // Selector for duplicate IDs
                            const elements = document.querySelectorAll(`[id="${id}"]`);
                            elements.forEach(el => el.innerText = txt);
                        }

                        setText('pdfAvaliacao', fmt(num(rawAvaliacao)));
                        setText('pdfLance', fmt(num(rawArremate)));
                        setText('pdfCondominio', fmt(num(rawCondominio)));


                        // 3. FINANCIAL CALCULATIONS (Robust)

                        // Acquisition
                        const vlrArremate = num(rawArremate);
                        const vlrAvaliacao = num(rawAvaliacao);

                        // Leiloeiro
                        const leiloeiro = (data.incluirLeiloeiro === false || data.incluirLeiloeiro === 'false') ? 0 : vlrArremate * 0.05;

                        // ITBI
                        const itbiPercent = num(data.itbi) > 0 ? num(data.itbi) / 100 : 0.03;

                        let itbi = 0;
                        // Robust retrieval of ITBI base preference
                        const rawItbiBase = getAnyDeep('itbiBase', 'itbi_base', 'base_itbi');
                        // Also try to find a pre-calculated ITBI value to ensure full match
                        const rawItbiValue = getAnyDeep('valorITBI', 'itbi_value');

                        console.log('🔍 Debug ITBI - Raw Values:', {
                            rawItbiValue,
                            rawItbiBase,
                            vlrAvaliacao: window.fmt(vlrAvaliacao),
                            vlrArremate: window.fmt(vlrArremate),
                            itbiPercent: data.itbi
                        });

                        if (true) {
                            // IGNORE saved 'valorITBI' to ensure correctness. always recalculate.
                            // Determine Base ITBI
                            let baseMode = 'avaliacao'; // Default safest option

                            // Check explicit preference
                            if (rawItbiBase && typeof rawItbiBase === 'string') {
                                const s = rawItbiBase.toLowerCase().trim();
                                if (s === 'arremate' || s === 'lance') baseMode = 'arremate';
                                else if (s === 'avaliacao') baseMode = 'avaliacao';
                            }

                            // Safety: If Avaliacao is missing/zero, fallback to Arremate
                            if (vlrAvaliacao <= 0.1) baseMode = 'arremate';

                            const baseItbi = (baseMode === 'avaliacao') ? vlrAvaliacao : vlrArremate;
                            itbi = baseItbi * itbiPercent;
                            console.log('👉 Force Recalculated ITBI:', { baseMode, baseItbi, itbiPercent, result: itbi });
                        }


                        // Assessoria
                        // Assessoria (Standard: 7k up to 140k, then 5%)
                        let assessoria = 0;
                        const stdThresh = 140000;
                        const stdFee = 7000;
                        const stdPct = 0.05;

                        if (data.assessoriaThreshold !== undefined) {
                            const thresh = num(data.assessoriaThreshold) || stdThresh;
                            const feeLow = num(data.assessoriaFeeBelow) || stdFee;
                            const feeHighPct = (num(data.assessoriaFeeAbovePercent) || 5) / 100;

                            assessoria = vlrArremate <= thresh ? feeLow : vlrArremate * feeHighPct;
                        } else if (data.valorAssessoria && num(data.valorAssessoria) > 0) {
                            assessoria = num(data.valorAssessoria);
                        } else {
                            // Standard Default
                            assessoria = vlrArremate <= stdThresh ? stdFee : vlrArremate * stdPct;
                        }

                        // Other Costs
                        const cartorio = num(data.custosCartorarios);
                        const reforma = num(data.reforma);
                        const debitos = num(data.debitosPendentes);
                        const desocupacao = num(data.custoDesocupacao);
                        const seguro = 190;
                        const outros = num(data.custosAdicionais); // Add support for 'custosAdicionais' if present in data

                        // Monthly Recurrent
                        const cond = num(data.condominioMensal);
                        const iptuMo = num(data.iptuMensal);
                        const custoMensal = cond + iptuMo;

                        // Costs Base (Fixed)
                        const investTotalBasico = vlrArremate + leiloeiro + itbi + cartorio + reforma + debitos + outros;

                        // Projections Base
                        const venda = num(data.valorVendaFinal) > 0 ? num(data.valorVendaFinal) : vlrAvaliacao;
                        const corretagem = venda * 0.06;

                        // Calculate 12 Month Base values for Details Section
                        const op12 = custoMensal * 12;
                        const invest12 = investTotalBasico + op12 + desocupacao + seguro + assessoria;
                        const bruto12 = venda - corretagem - invest12;
                        const imposto12 = bruto12 > 0 ? bruto12 * 0.15 : 0;

                        // GENERATE SCENARIOS (4, 8, 12, 16 Months)
                        const scenarios = [
                            { m: 4, label: 'Venda Rápida' },
                            { m: 8, label: 'Venda Média' },
                            { m: 12, label: 'Venda Longa' },
                            { m: 16, label: 'Venda Tardia' }
                        ];

                        let scenariosHTML = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">';

                        scenarios.forEach(s => {
                            const opCost = custoMensal * s.m;

                            // Calculate Total Invested for this scenario
                            // Formula: Base + Operational(Months) + Desocupacao + Seguro + Assessoria
                            const investTotal = investTotalBasico + opCost + desocupacao + seguro + assessoria;

                            // Determine Sales Value (Short vs Long Term)
                            let vendaCenario = venda;
                            if (s.m >= 12) {
                                const vendaLongo = num(data.valorVendaLongo);
                                if (vendaLongo > 0) {
                                    vendaCenario = vendaLongo;
                                }
                            }
                            // Recalculate brokerage/taxes based on the specific sales value
                            const corretagemCenario = vendaCenario * 0.06;

                            const bruto = vendaCenario - corretagemCenario - investTotal;
                            const imposto = bruto > 0 ? bruto * 0.15 : 0;
                            const liq = bruto - imposto;
                            const roi = investTotal > 0 ? (liq / investTotal) * 100 : 0;
                            const isPositive = liq > 0;
                            const color = isPositive ? '#34C759' : '#FF3B30';
                            const borderColor = isPositive ? 'rgba(52, 199, 89, 0.2)' : 'rgba(255, 59, 48, 0.2)';

                            // Generate Card HTML (Exact replica of Calculadora Visuals)
                            scenariosHTML += `
                                <div style="background: #fff; border-radius: 12px; padding: 20px; position: relative; overflow: hidden; border: 1px solid ${borderColor}; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                                    <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: ${color};"></div>
                                    
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                        <span style="font-size: 10px; font-weight: 700; text-transform: uppercase; color: #6b7280; letter-spacing: 0.5px;">
                                            ${s.label}
                                        </span>
                                        <span style="background: #f3f4f6; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600; color: #374151;">
                                            ${s.m} Meses
                                        </span>
                                    </div>

                                    <div style="margin-bottom: 16px;">
                                        <p style="font-size: 11px; color: #6b7280; margin-bottom: 2px;">Lucro Líquido</p>
                                        <h3 style="font-size: 24px; font-weight: 700; color: ${color}; letter-spacing: -0.5px; margin: 0;">
                                            ${fmt(liq)}
                                        </h3>
                                    </div>

                                    <div style="margin-bottom: 12px;">
                                        <p style="font-size: 10px; color: #6b7280; margin-bottom: 1px;">Total Investido</p>
                                        <p style="font-size: 14px; font-weight: 600; color: #111827; margin: 0;">
                                            ${fmt(investTotal)}
                                        </p>
                                    </div>

                                    <div style="margin-bottom: 16px;">
                                        <p style="font-size: 10px; color: #6b7280; margin-bottom: 1px;">Valor de Venda</p>
                                        <p style="font-size: 14px; font-weight: 600; color: #34C759; margin: 0;">
                                            ${fmt(vendaCenario)}
                                        </p>
                                    </div>

                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                        <div>
                                            <p style="font-size: 10px; color: #6b7280; margin-bottom: 1px;">ROI</p>
                                            <p style="font-size: 12px; font-weight: 700; color: ${color}; margin: 0;">
                                                ${roi.toFixed(2)}%
                                            </p>
                                        </div>
                                        <div style="text-align: right;">
                                            <p style="font-size: 10px; color: #6b7280; margin-bottom: 1px;">Custo/Mês</p>
                                            <p style="font-size: 12px; font-weight: 600; color: #111827; margin: 0;">
                                                ${fmt(custoMensal)}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });

                        scenariosHTML += '</div>';

                        // DETAILS SECTION (Replica of Modal)
                        const detailsHTML = `
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px dashed #e5e7eb;">
                                <h3 style="font-size: 16px; font-weight: 700; color: #111827; margin-bottom: 20px;">Detalhamento Financeiro</h3>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px;">
                                    <!-- Left Column -->
                                    <div>
                                        <!-- Custos de Aquisicao -->
                                        <div style="margin-bottom: 24px;">
                                            <h4 style="font-size: 11px; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-bottom: 12px; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px; letter-spacing: 0.5px;">
                                                Custos de Aquisição
                                            </h4>
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px;">
                                                <span style="color: #6b7280;">Valor de Arremate</span>
                                                <span style="font-weight: 600; color: #111827;">${fmt(vlrArremate)}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px;">
                                                <span style="color: #6b7280;">Assessoria</span>
                                                <span style="font-weight: 600; color: #111827;">${fmt(assessoria)}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px;">
                                                <span style="color: #6b7280;">Leiloeiro (5%)</span>
                                                <span style="font-weight: 600; color: #111827;">${fmt(leiloeiro)}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px;">
                                                <span style="color: #6b7280;">ITBI</span>
                                                <span style="font-weight: 600; color: #111827;">${fmt(itbi)}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px;">
                                                <span style="color: #6b7280;">Cartório / Registro</span>
                                                <span style="font-weight: 600; color: #111827;">${fmt(cartorio)}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px;">
                                                <span style="color: #6b7280;">Reforma</span>
                                                <span style="font-weight: 600; color: #111827;">${fmt(reforma)}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px;">
                                                <span style="color: #6b7280;">Débitos Pendentes</span>
                                                <span style="font-weight: 600; color: #111827;">${fmt(debitos)}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px;">
                                                <span style="color: #6b7280;">Desocupação</span>
                                                <span style="font-weight: 600; color: #111827;">${fmt(desocupacao)}</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Right Column -->
                                    <div>
                                        <!-- Custos de Venda -->
                                        <div style="margin-bottom: 24px;">
                                            <h4 style="font-size: 11px; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-bottom: 12px; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px; letter-spacing: 0.5px;">
                                                Custos de Venda
                                            </h4>
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px;">
                                                <span style="color: #6b7280;">Corretagem</span>
                                                <span style="font-weight: 600; color: #111827;">${fmt(corretagem)}</span>
                                            </div>
                                        </div>

                                        <!-- Valor de Venda -->
                                        <div style="margin-bottom: 24px;">
                                            <h4 style="font-size: 11px; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-bottom: 12px; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px; letter-spacing: 0.5px;">
                                                Valor de Venda
                                            </h4>
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px;">
                                                <span style="color: #6b7280;">Valor de Venda Estimado</span>
                                                <span style="font-weight: 700; color: #34C759; font-size: 14px;">${fmt(venda)}</span>
                                            </div>
                                        </div>

                                        <!-- Simulação Impostos (Ex: 12 Meses) -->
                                        <div style="margin-bottom: 12px;">
                                            <h4 style="font-size: 11px; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-bottom: 12px; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px; letter-spacing: 0.5px;">
                                                Impostos e Manutenção (Base 12 Meses)
                                            </h4>
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px;">
                                                <span style="color: #6b7280;">Imposto de Renda (15%)</span>
                                                <span style="font-weight: 600; color: #FF3B30;">${fmt(imposto12)}</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px;">
                                                <span style="color: #6b7280;">Manutenção (Cond./IPTU)</span>
                                                <span style="font-weight: 600; color: #111827;">${fmt(op12)}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;

                        document.getElementById('pdfViabilityContent').innerHTML = scenariosHTML + detailsHTML;
                    } catch (e) {
                        console.error("Erro Fatal:", e);
                        const container = document.getElementById('pdfViabilityContent');
                        if (container) {
                            container.innerHTML = `
                                 <div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded text-center">
                                     <p class="font-bold">Erro de Carregamento</p>
                                     <p class="text-xs font-mono">${e.message}</p>
                                 </div>
                             `;
                        }
                        alert("Erro no carregamento: " + e.message);
                    }
                }


                // ===== FUNÇÕES DE RASCUNHO =====
                const RASCUNHO_KEY = 'davinci_rascunho';

                const camposRascunho = [
                    'inputNome', 'inputEndereco', 'inputBem', 'inputLicitacao',
                    'inputApto', 'inputMetragem', 'inputQuartos', 'inputBanheiros',
                    'inputVaga', 'inputCondominio', 'inputInstagram', 'inputCreci',
                    'inputFooter', 'inputValorArremate', 'inputValorAvaliacao', 'inputValorVenda'
                ];


                function salvarRascunho() {
                    try {
                        const rascunho = {};

                        // Salvar valores dos campos de texto
                        camposRascunho.forEach(id => {
                            const elemento = document.getElementById(id);
                            if (elemento) {
                                rascunho[id] = elemento.value;
                            }
                        });

                        // Salvar seleção de cálculo
                        const selectCalculo = document.getElementById('selectCalculo');
                        if (selectCalculo) {
                            rascunho.selectCalculo = selectCalculo.value;
                        }

                        // Salvar seleção de empresa
                        const selectCompany = document.getElementById('selectSavedCompany');
                        if (selectCompany) {
                            rascunho.selectSavedCompany = selectCompany.value;
                        }

                        // Salvar no localStorage
                        localStorage.setItem(RASCUNHO_KEY, JSON.stringify(rascunho));

                        // Feedback visual
                        mostrarNotificacao('Rascunho salvo com sucesso!', 'success');
                    } catch (error) {
                        console.error('Erro ao salvar rascunho:', error);
                        mostrarNotificacao('Erro ao salvar rascunho', 'error');
                    }
                }

                function carregarRascunho() {
                    try {
                        const rascunhoSalvo = localStorage.getItem(RASCUNHO_KEY);

                        if (!rascunhoSalvo) {
                            mostrarNotificacao('Nenhum rascunho encontrado', 'info');
                            return;
                        }

                        const rascunho = JSON.parse(rascunhoSalvo);

                        // Restaurar valores dos campos
                        camposRascunho.forEach(id => {
                            if (rascunho[id] !== undefined) {
                                const elemento = document.getElementById(id);
                                if (elemento) {
                                    elemento.value = rascunho[id];
                                    // Disparar evento input para atualizar PDF
                                    elemento.dispatchEvent(new Event('input'));
                                }
                            }
                        });

                        // Restaurar seleção de cálculo
                        if (rascunho.selectCalculo) {
                            const selectCalculo = document.getElementById('selectCalculo');
                            if (selectCalculo) {
                                selectCalculo.value = rascunho.selectCalculo;
                                // Disparar evento change para carregar dados do cálculo
                                selectCalculo.dispatchEvent(new Event('change'));
                            }
                        }

                        // Restaurar seleção de empresa
                        if (rascunho.selectSavedCompany) {
                            const selectCompany = document.getElementById('selectSavedCompany');
                            if (selectCompany) {
                                selectCompany.value = rascunho.selectSavedCompany;
                                // Disparar evento change para carregar dados da empresa
                                selectCompany.dispatchEvent(new Event('change'));
                            }
                        }

                        mostrarNotificacao('Rascunho carregado com sucesso!', 'success');
                    } catch (error) {
                        console.error('Erro ao carregar rascunho:', error);
                        mostrarNotificacao('Erro ao carregar rascunho', 'error');
                    }
                }

                function limparRascunho() {
                    if (confirm('Tem certeza que deseja limpar o rascunho salvo? Esta ação não pode ser desfeita.')) {
                        try {
                            localStorage.removeItem(RASCUNHO_KEY);
                            mostrarNotificacao('Rascunho removido com sucesso!', 'success');
                        } catch (error) {
                            console.error('Erro ao limpar rascunho:', error);
                            mostrarNotificacao('Erro ao limpar rascunho', 'error');
                        }
                    }
                }

                function mostrarNotificacao(mensagem, tipo) {
                    // Remover notificações anteriores para evitar sobreposição
                    const existingCalls = document.querySelectorAll('.macos-notification');
                    existingCalls.forEach(el => el.remove());

                    // Criar elemento de notificação
                    const notif = document.createElement('div');
                    notif.className = 'macos-notification no-print';
                    notif.style.cssText = `
                        position: fixed;
                        top: 80px;
                        right: 20px;
                        padding: 16px 24px;
                        background: ${tipo === 'success' ? '#34C759' : tipo === 'error' ? '#FF3B30' : '#007AFF'};
                        color: white;
                        border-radius: 12px;
                        font-weight: 600;
                        font-size: 14px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        z-index: 99999;
                        opacity: 0;
                        transform: translateX(50px);
                        transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1);
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    `;

                    const icon = tipo === 'success' ? '<i class="fa-solid fa-check-circle"></i>' : tipo === 'error' ? '<i class="fa-solid fa-circle-exclamation"></i>' : '<i class="fa-solid fa-info-circle"></i>';
                    notif.innerHTML = `<span style="font-size: 18px;">${icon}</span> ${mensagem}`;

                    document.body.appendChild(notif);

                    // Animar entrada
                    requestAnimationFrame(() => {
                        notif.style.opacity = '1';
                        notif.style.transform = 'translateX(0)';
                    });

                    // Remover após 4 segundos (aumentado)
                    setTimeout(() => {
                        notif.style.opacity = '0';
                        notif.style.transform = 'translateX(50px)';
                        setTimeout(() => notif.remove(), 300);
                    }, 4000);
                }

                // Adicionar animações CSS
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes slideIn {
                        from {
                            transform: translateX(400px);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    @keyframes slideOut {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(400px);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(style);

                // Carregar rascunho automaticamente ao carregar a página (opcional)
                // Descomente a linha abaixo se quiser carregar automaticamente
                // window.addEventListener('DOMContentLoaded', carregarRascunho);



                // NEW APPROACH: Clean Window Print
                // This opens a popup with ONLY the content we want, ensuring no UI interference and native rendering.

                function generateDaVinciPDF() {
                    console.log("Starting PDF Generation...");

                    // 0. FORCE UPDATE FINANCIALS
                    // Ensure #pdf-content has fresh calculations for headers (Lance, Avaliacao)
                    if (typeof updateManualFinancialData === 'function') {
                        updateManualFinancialData();
                    }

                    // Helper: Title Case Transform
                    const toTitleCase = (val) => {
                        if (!val) return '';
                        return val.toLowerCase().split(' ').map(word => {
                            return (word.length > 2) ? word.charAt(0).toUpperCase() + word.slice(1) : word;
                        }).join(' ');
                    };

                    // 1. SYNC TEXT FIELDS
                    const sync = (srcId, destSelector, defaultText = '--', transform = null) => {
                        const src = document.getElementById(srcId);
                        const dest = document.querySelector('#pdf-content ' + destSelector);
                        if (src && dest) {
                            let val = src.value || defaultText;
                            if (transform) val = transform(val);
                            dest.innerText = val;
                        }
                    };

                    // Apply Title Case to Names
                    sync('inputNome', '#pdfNomeImovel', 'Nome do Imóvel', toTitleCase);

                    sync('inputLicitacao', '#pdfLicitacao', '--/--/----');
                    sync('inputBem', '#pdfBem', '00000.0000');

                    // Apply Title Case to Address
                    sync('inputEndereco', '#pdfEndereco', 'Endereço não informado', toTitleCase);

                    sync('inputMetragem', '#pdfMetragem', '-- m²');
                    sync('inputQuartos', '#pdfQuartos', '--');
                    sync('inputBanheiros', '#pdfBanheiros', '--');
                    sync('inputVaga', '#pdfVaga', '--');
                    sync('inputApto', '#pdfApto', '--');

                    // 1.1 SYNC COMPANY INFO (Fix for missing company details)
                    sync('inputFooter', '#pdfFooter', ''); // Footer small text

                    // Main Company Name (from Creci input, split by dash)
                    sync('inputCreci', '#pdfCreci', 'Nome da Empresa', (val) => {
                        return val.split('-')[0].trim() || 'Nome da Empresa';
                    });

                    // Instagram
                    sync('inputInstagram', '#pdfInstagram', '@instagram');

                    // Sync Text-based Company Name for the body text
                    const creciInput = document.getElementById('inputCreci');
                    const textTarget = document.querySelector('#pdf-content #pdfCompanyInText'); // This ID might not exist in template, but keeping safe logic
                    if (creciInput && textTarget) {
                        const companyName = creciInput.value.split('-')[0].trim();
                        textTarget.innerText = companyName || "Sua Empresa";
                    }

                    // 2. FORCE RE-CALCULATE FINANCIALS
                    // Updates the #pdf-content DOM directly with new values (Lance, Avaliacao)
                    if (typeof updateManualFinancialData === 'function') {
                        updateManualFinancialData();
                    }

                    // 3. SYNC FINANCIAL TABLE (Visual Preview -> Hidden Source)
                    const visibleCalc = document.querySelector('#pdf-preview-container #pdfViabilityContent');
                    const hiddenCalc = document.querySelector('#pdf-content #pdfViabilityContent');

                    if (visibleCalc && hiddenCalc && visibleCalc.innerHTML.trim() !== "") {
                        hiddenCalc.innerHTML = visibleCalc.innerHTML;
                    }

                    // 3. CAPTURE CONTENT
                    const pdfSource = document.getElementById('pdf-content');
                    if (!pdfSource) { alert("Erro fatal: Modelo PDF não encontrado."); return; }
                    const content = pdfSource.innerHTML; // Capture FRESH content

                    // 4. GET STYLES
                    const styles = Array.from(document.querySelectorAll('link[rel="stylesheet"], style'))
                        .map(style => style.outerHTML)
                        .join('');

                    // 5. OPEN PRINT WINDOW
                    // 5. IFRAME METHOD (Invisible Print)
                    // This triggers ONLY the system print dialog (the "detailed" one), skipping the popup window.
                    let iframe = document.getElementById('print-iframe');
                    if (!iframe) {
                        iframe = document.createElement('iframe');
                        iframe.id = 'print-iframe';
                        iframe.style.position = 'fixed';
                        iframe.style.left = '-10000px';
                        iframe.style.top = '0';
                        iframe.style.width = '1px';
                        iframe.style.height = '1px';
                        iframe.style.border = '0';
                        document.body.appendChild(iframe);
                    }

                    const doc = iframe.contentWindow.document;
                    doc.open();
                    doc.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <base href="${window.location.origin}/">
                            <title>Proposta - Fortal</title>
                            <meta charset="utf-8">
                            ${styles}
                            <style>
                                @page { size: A4 portrait; margin: 0; }
                                html, body { 
                                    margin: 0; 
                                    padding: 0; 
                                    width: 210mm; 
                                    background: white; 
                                    -webkit-print-color-adjust: exact; 
                                    print-color-adjust: exact; 
                                }
                                .pdf-sheet { 
                                    width: 210mm !important; 
                                    page-break-after: always !important; 
                                    overflow: hidden !important; 
                                    margin: 0 !important; 
                                }
                                .no-print { display: none !important; }
                            </style>
                        </head>
                        <body>
                            ${content}
                            <script>
                                window.onload = function() {
                                    const imgs = document.images;
                                    const promises = [];
                                    
                                    for (let i = 0; i < imgs.length; i++) {
                                        if (!imgs[i].complete) {
                                            promises.push(new Promise(resolve => {
                                                imgs[i].onload = resolve;
                                                imgs[i].onerror = resolve; // Print anyway on error
                                            }));
                                        }
                                    }

                                    Promise.all(promises).then(() => {
                                        // Small buffer for rendering
                                        setTimeout(() => {
                                            window.print();
                                            // Optional: Close after print (commented out to debug)
                                            // window.close();
                                        }, 500);
                                    });
                                };
                            <\/script>
                        </body>
                        </html>
                    `);
                    doc.close();
                }
                function handlePrint() {
                    const noPrintElements = document.querySelectorAll('.no-print, .macos-toolbar, .macos-sidebar, .page-container');
                    const pdfContent = document.getElementById('pdf-content');

                    // Force Hide
                    noPrintElements.forEach(el => {
                        el.classList.add('force-print-hidden');
                    });

                    // Force Show PDF Content
                    if (pdfContent) {
                        pdfContent.style.display = 'block';
                    }

                    // Print
                    setTimeout(() => {
                        window.print();

                        // Restore after print dialog opens/closes
                        setTimeout(() => {
                            noPrintElements.forEach(el => {
                                el.classList.remove('force-print-hidden');
                            });
                        }, 500); // Increased timeout significantly for Windows responsiveness
                    }, 500);
                }
            </script>

            <!-- Script de Tema Dark/Light -->
            <script>
                // Aplicar tema salvo no localStorage
                (function () {
                    const savedTheme = localStorage.getItem('theme') || 'dark';
                    if (savedTheme === 'dark') {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }

                    // Observar mudanças no localStorage (quando outro tab muda o tema)
                    window.addEventListener('storage', (e) => {
                        if (e.key === 'theme') {
                            if (e.newValue === 'dark') {
                                document.documentElement.classList.add('dark');
                            } else {
                                document.documentElement.classList.remove('dark');
                            }
                        }
                    });
                })();
            </script>
</body>

</html>