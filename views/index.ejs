<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <title>Fortal - Dashboard</title>
    <%- include('partials/head') %>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <style>
            /* Classes utilitárias baseadas nas variáveis CSS do tema para garantir consistência */
            .color-primary {
                color: var(--macos-text-primary);
            }

            .color-secondary {
                color: var(--macos-text-secondary);
            }

            .bg-card {
                background-color: var(--macos-glass-bg);
                border: 1px solid var(--macos-glass-border);
            }

            .bg-sidebar {
                background-color: var(--macos-bg-sidebar);
            }

            /* Ajustes específicos para cartões de KPI */
            .kpi-card {
                background-color: var(--macos-glass-bg);
                border: 1px solid var(--macos-glass-border);
                border-radius: var(--macos-radius-lg);
                padding: 20px;
                transition: all 0.2s ease;
            }

            .kpi-card:hover {
                background-color: var(--macos-bg-secondary);
                border-color: var(--macos-border);
                transform: translateY(-2px);
            }

            /* Modal Overlay Styles - Critical for preventing click blocking */
            .macos-modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 9999;
                display: flex;
                justify-content: center;
                align-items: center;
                opacity: 0;
                visibility: hidden;
                pointer-events: none;
                /* Ensure it doesn't block clicks when hidden */
                transition: opacity 0.3s ease, visibility 0.3s ease;
            }

            .macos-modal-overlay.is-visible {
                opacity: 1;
                visibility: visible;
                pointer-events: auto;
                /* Re-enable clicks when visible */
            }
        </style>
</head>

<body class="min-h-screen page-home">

    <%- include('partials/macos-toolbar', { title: 'Dashboard' , username: username, profile_pic_url: profile_pic_url })
        %>
        <%- include('partials/macos-sidebar', { user: user }) %>

            <main class="macos-main-content">
                <div class="animate-fade-in" style="padding-bottom: 40px; max-width: 1400px; margin: 0 auto;">

                    <!-- Header Section -->
                    <div class="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-4">
                        <div>
                            <h1 class="text-3xl font-bold mb-2" style="color: var(--macos-text-primary);">
                                Visão Geral
                            </h1>
                            <p style="color: var(--macos-text-secondary);">
                                Acompanhe o desempenho da sua carteira e novas oportunidades.
                            </p>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-sm font-medium px-3 py-1 rounded-full"
                                style="background-color: var(--macos-bg-tertiary); color: var(--macos-text-secondary);">
                                <%= new Date().toLocaleDateString('pt-BR', { month: 'long' , year: 'numeric' }) %>
                            </span>
                            <a href="/calculadora"
                                class="macos-btn-primary text-sm px-4 py-2 hover:opacity-90 border-none shadow-lg text-white"
                                style="background-color: var(--macos-accent); color: white;">
                                <i class="fa-solid fa-plus mr-2"></i> Nova Simulação
                            </a>
                        </div>
                    </div>

                    <!-- Widget: Minhas Minerações (Comissões) -->
                    <div id="mining-widget" class="kpi-card mb-8"
                        style="background: linear-gradient(135deg, var(--macos-bg-secondary), var(--macos-bg-tertiary)); border: 1px solid var(--macos-accent); display:none;">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-bold" style="color: var(--macos-text-primary);">
                                <i class="fa-solid fa-gem mr-2" style="color: #9b59b6;"></i> Mineração & Comissões
                            </h2>
                            <div class="flex gap-4 text-sm font-medium">
                                <div class="px-3 py-1 rounded-full bg-green-500/10 text-green-500">
                                    Recebido: <span id="valRecebido">R$ 0,00</span>
                                </div>
                                <div class="px-3 py-1 rounded-full bg-orange-500/10 text-orange-500">
                                    A Receber (Previsão): <span id="valReceber">R$ 0,00</span>
                                </div>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm" style="color: var(--macos-text-secondary);">
                                <thead>
                                    <tr style="border-bottom: 1px solid var(--macos-divider);">
                                        <th class="pb-2">Imóvel</th>
                                        <th class="pb-2">Arrematado Por</th>
                                        <th class="pb-2">Data</th>
                                        <th class="pb-2">Comissão</th>
                                        <th class="pb-2">Status</th>
                                        <th class="pb-2 text-right">Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="mining-list">
                                    <!-- JS vai preencher -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <% if (stats) { %>
                        <!-- KPI Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-6 mb-8">

                            <!-- KPI 1: VGV -->
                            <div class="kpi-card group relative overflow-hidden">
                                <div class="absolute right-0 top-0 p-4 opacity-10 transition-opacity">
                                    <i class="fa-solid fa-briefcase text-6xl text-yellow-500"></i>
                                </div>
                                <div class="relative z-10">
                                    <p class="text-xs font-bold uppercase tracking-wider mb-2"
                                        style="color: var(--macos-text-secondary);">VGV sob Gestão</p>
                                    <h3 class="text-2xl font-bold mb-1" style="color: var(--macos-text-primary);">
                                        <%= Number(stats.vgv_gestao || 0).toLocaleString('pt-BR', { style: 'currency' ,
                                            currency: 'BRL' }) %>
                                    </h3>
                                    <div class="flex items-center text-xs font-medium text-green-500">
                                        <i class="fa-solid fa-arrow-up mr-1"></i>
                                        <span>Ativo na Carteira</span>
                                    </div>
                                </div>
                            </div>

                            <div class="kpi-card group relative overflow-hidden cursor-pointer"
                                style="pointer-events: auto;" onclick="openCommissionDashboardModal()">
                                <div class="absolute right-0 top-0 p-4 opacity-10 transition-opacity">
                                    <i class="fa-solid fa-sack-dollar text-6xl text-green-500"></i>
                                </div>
                                <div class="relative z-10">
                                    <p class="text-xs font-bold uppercase tracking-wider mb-2"
                                        style="color: var(--macos-text-secondary);">Comissão Estimada</p>
                                    <h3 class="text-2xl font-bold mb-1" style="color: var(--macos-text-primary);">
                                        <%= Number(stats.comissao_prevista || 0).toLocaleString('pt-BR', {
                                            style: 'currency' , currency: 'BRL' }) %>
                                    </h3>
                                    <div class="flex items-center text-xs text-blue-400 group-hover:underline">
                                        <i class="fa-solid fa-eye mr-1"></i>
                                        <span>Clique para detalhar</span>
                                    </div>
                                </div>
                            </div>

                            <!-- KPI 3: Leads -->
                            <% if (false) { %>
                                <div class="kpi-card group relative overflow-hidden cursor-pointer"
                                    onclick="window.location.href='/leads'">
                                    <div class="absolute right-0 top-0 p-4 opacity-10 transition-opacity">
                                        <i class="fa-solid fa-fire text-6xl text-orange-500"></i>
                                    </div>
                                    <div class="relative z-10">
                                        <p class="text-xs font-bold uppercase tracking-wider mb-2"
                                            style="color: var(--macos-text-secondary);">Novos Leads</p>
                                        <h3 class="text-2xl font-bold mb-1" style="color: var(--macos-text-primary);">
                                            <%= stats.leads_waiting %>
                                        </h3>
                                        <% if (stats.leads_waiting> 0) { %>
                                            <div
                                                class="flex items-center text-xs text-orange-500 font-bold animate-pulse">
                                                <i class="fa-solid fa-circle-exclamation mr-1"></i>
                                                <span>Aguardando Ação</span>
                                            </div>
                                            <% } else { %>
                                                <div class="flex items-center text-xs text-green-500">
                                                    <i class="fa-solid fa-check mr-1"></i>
                                                    <span>Tudo em dia</span>
                                                </div>
                                                <% } %>
                                    </div>
                                </div>
                                <% } %>

                                    <!-- KPI 4: Imóveis -->
                                    <div class="kpi-card group relative overflow-hidden">
                                        <div class="absolute right-0 top-0 p-4 opacity-10 transition-opacity">
                                            <i class="fa-solid fa-building text-6xl text-blue-500"></i>
                                        </div>
                                        <div class="relative z-10">
                                            <p class="text-xs font-bold uppercase tracking-wider mb-2"
                                                style="color: var(--macos-text-secondary);">Total Imóveis</p>
                                            <h3 class="text-2xl font-bold mb-1"
                                                style="color: var(--macos-text-primary);">
                                                <%= stats.total_imoveis || 0 %>
                                            </h3>
                                            <div class="flex items-center text-xs text-blue-500">
                                                <span>Gestão Ativa</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- KPI 5: Blacklist (Novo) -->
                                    <div class="kpi-card group relative overflow-hidden"
                                        title="Leads duplicados (mesmo telefone) filtrados automaticamente da contagem principal.">
                                        <div class="absolute right-0 top-0 p-4 opacity-10 transition-opacity">
                                            <i class="fa-solid fa-user-shield text-6xl text-red-500"></i>
                                        </div>
                                        <div class="relative z-10">
                                            <p class="text-xs font-bold uppercase tracking-wider mb-2"
                                                style="color: var(--macos-text-secondary);">Blacklist / Duplicados</p>
                                            <h3 class="text-2xl font-bold mb-1"
                                                style="color: var(--macos-text-primary);">
                                                <%= stats.blacklist_count || 0 %>
                                            </h3>
                                            <div
                                                class="flex items-center text-xs text-red-500 font-medium whitespace-nowrap">
                                                <i class="fa-solid fa-filter mr-1"></i>
                                                <span>Retido: <%= Number(stats.blacklist_value ||
                                                        0).toLocaleString('pt-BR', { style: 'currency' , currency: 'BRL'
                                                        }) %></span>
                                            </div>
                                        </div>
                                    </div>
                        </div>
                        <% } %>

                            <!-- Middle Section: Chart & Actions -->
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                                <!-- Evolution Chart -->
                                <div class="lg:col-span-2 kpi-card">
                                    <div class="flex items-center justify-between mb-6">
                                        <h2 class="text-lg font-bold" style="color: var(--macos-text-primary);">Evolução
                                            do VGV</h2>
                                        <span class="text-xs" style="color: var(--macos-text-secondary);">Últimos 6
                                            meses</span>
                                    </div>
                                    <div class="w-full h-[300px]">
                                        <canvas id="performanceChart"></canvas>
                                    </div>
                                </div>

                                <!-- Quick Actions / Mini Feed -->
                                <div class="lg:col-span-1 flex flex-col gap-6">
                                    <!-- Quick Actions -->
                                    <div class="kpi-card">
                                        <h3 class="text-lg font-bold mb-4" style="color: var(--macos-text-primary);">
                                            Ações Rápidas</h3>
                                        <div class="space-y-3">
                                            <a href="/calculadora"
                                                class="flex items-center p-3 rounded-lg transition-colors cursor-pointer group hover:bg-opacity-50"
                                                style="background-color: var(--macos-bg-tertiary); border: 1px solid var(--macos-border);">
                                                <div
                                                    class="w-8 h-8 rounded bg-yellow-500 flex items-center justify-center text-gray-900 mr-3 group-hover:scale-110 transition-transform">
                                                    <i class="fa-solid fa-calculator"></i>
                                                </div>
                                                <span class="font-medium text-sm"
                                                    style="color: var(--macos-text-primary);">Simular Arremate</span>
                                            </a>
                                            <% if (false) { %>
                                                <a href="/leads"
                                                    class="flex items-center p-3 rounded-lg transition-colors cursor-pointer group hover:bg-opacity-50"
                                                    style="background-color: var(--macos-bg-tertiary); border: 1px solid var(--macos-border);">
                                                    <div
                                                        class="w-8 h-8 rounded bg-blue-500 flex items-center justify-center text-white mr-3 group-hover:scale-110 transition-transform">
                                                        <i class="fa-solid fa-users"></i>
                                                    </div>
                                                    <span class="font-medium text-sm"
                                                        style="color: var(--macos-text-primary);">Ver
                                                        Oportunidades</span>
                                                </a>
                                                <% } %>
                                                    <a href="/carteira"
                                                        class="flex items-center p-3 rounded-lg transition-colors cursor-pointer group hover:bg-opacity-50"
                                                        style="background-color: var(--macos-bg-tertiary); border: 1px solid var(--macos-border);">
                                                        <div
                                                            class="w-8 h-8 rounded bg-green-500 flex items-center justify-center text-white mr-3 group-hover:scale-110 transition-transform">
                                                            <i class="fa-solid fa-file-contract"></i>
                                                        </div>
                                                        <span class="font-medium text-sm"
                                                            style="color: var(--macos-text-primary);">Gerar
                                                            Proposta</span>
                                                    </a>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Properties List -->
                            <div class="kpi-card p-0 overflow-hidden">
                                <div class="p-6 border-b flex justify-between items-center"
                                    style="border-color: var(--macos-divider);">
                                    <h2 class="text-lg font-bold" style="color: var(--macos-text-primary);">Últimos
                                        Imóveis Adicionados</h2>
                                    <a href="/carteira" class="text-sm font-medium hover:underline"
                                        style="color: var(--macos-accent);">Ver todos</a>
                                </div>

                                <% if (recentProperties && recentProperties.length> 0) { %>
                                    <div class="divide-y" style="border-color: var(--macos-divider);">
                                        <% recentProperties.forEach(imovel=> { %>
                                            <div class="p-4 transition-colors flex items-center justify-between group cursor-pointer hover:bg-white/5"
                                                onclick="window.location.href='/carteira/<%= imovel.id %>'">
                                                <div class="flex items-center gap-4">
                                                    <div class="w-10 h-10 rounded-lg flex items-center justify-center"
                                                        style="background-color: var(--macos-bg-tertiary); color: var(--macos-text-secondary);">
                                                        <i class="fa-solid fa-house"></i>
                                                    </div>
                                                    <div>
                                                        <h4 class="text-sm font-bold transition-colors group-hover:text-blue-500"
                                                            style="color: var(--macos-text-primary);">
                                                            <%= imovel.descricao %>
                                                        </h4>
                                                        <p class="text-xs" style="color: var(--macos-text-secondary);">
                                                            <i class="fa-solid fa-location-dot mr-1"></i>
                                                            <%= imovel.endereco %>
                                                        </p>
                                                    </div>
                                                </div>
                                                <div class="text-right">
                                                    <p class="text-sm font-bold"
                                                        style="color: var(--macos-text-primary);">
                                                        <%= Number(imovel.total_investido || imovel.valor_compra ||
                                                            0).toLocaleString('pt-BR', { style: 'currency' ,
                                                            currency: 'BRL' }) %>
                                                    </p>
                                                    <span
                                                        class="inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase"
                                                        style="background-color: rgba(34, 197, 94, 0.2); color: #22c55e;">
                                                        <%= imovel.status || 'Ativo' %>
                                                    </span>
                                                </div>
                                            </div>
                                            <% }); %>
                                    </div>
                                    <% } else { %>
                                        <div class="p-8 text-center" style="color: var(--macos-text-secondary);">
                                            <i class="fa-solid fa-folder-open text-3xl mb-3"></i>
                                            <p class="text-sm">Nenhum imóvel recente encontrado.</p>
                                        </div>
                                        <% } %>
                            </div>

                </div>
            </main>

            <script src="/js/app.js"></script>

            <!-- Chart Script for Performance -->
            <script>
                document.addEventListener('DOMContentLoaded', async function () {
                    // --- Carregar Dados de Mineração ---
                    try {
                        const res = await fetch('/api/financeiro/minhas-mineracoes');
                        const data = await res.json();

                        if (data.rows && data.rows.length > 0) {
                            document.getElementById('mining-widget').style.display = 'block';

                            // Totais
                            const toCurrency = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                            document.getElementById('valRecebido').textContent = toCurrency(data.totalRecebido);
                            document.getElementById('valReceber').textContent = toCurrency(data.totalReceber);

                            const tbody = document.getElementById('mining-list');
                            tbody.innerHTML = '';

                            data.rows.forEach(row => {
                                const tr = document.createElement('tr');
                                tr.className = 'border-b border-[var(--macos-divider)] last:border-0 hover:bg-white/5';

                                const statusColor = row.status == 'pago' ? 'text-green-500' : 'text-orange-400';
                                const statusIcon = row.status == 'pago' ? '<i class="fa-solid fa-check-circle"></i>' : '<i class="fa-solid fa-clock"></i>';

                                tr.innerHTML = `
                                    <td class="py-2 font-medium">${row.imovel_desc}</td>
                                    <td class="py-2 text-xs">${row.vendedor || 'N/A'}</td>
                                    <td class="py-2 text-xs opacity-70">${row.data_fmt}</td>
                                    <td class="py-2 font-bold">${toCurrency(row.valor)}</td>
                                    <td class="py-2 text-xs ${statusColor}">${statusIcon} ${row.status.toUpperCase()}</td>
                                    <td class="py-2 text-right">
                                        ${row.status === 'pendente' ?
                                        `<button onclick="marcarPago(${row.id})" class="text-xs bg-green-500/10 text-green-500 px-2 py-1 rounded hover:bg-green-500 hover:text-white transition-colors">Confirmar Recebimento</button>`
                                        : ''}
                                    </td>
                                `;
                                tbody.appendChild(tr);
                            });
                        }
                    } catch (e) { console.error('Erro mineracao dashboard', e); }

                    const ctx = document.getElementById('performanceChart');
                    if (ctx) {
                        // Get colors from CSS variables
                        const style = getComputedStyle(document.body);
                        const colorPrimary = style.getPropertyValue('--macos-text-primary').trim();
                        const colorSecondary = style.getPropertyValue('--macos-text-secondary').trim();
                        const colorDivider = style.getPropertyValue('--macos-divider').trim();
                        const colorAccent = style.getPropertyValue('--macos-accent').trim();

                        const labels = ['Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                        const data = [0, 50000, 120000, 180000, 250000, <%= Number(stats ? (stats.vgv_gestao || 0) : 0) %>];

                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'VGV Acumulado',
                                    data: data,
                                    borderColor: colorAccent,
                                    backgroundColor: 'rgba(234, 179, 8, 0.1)',
                                    borderWidth: 3,
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 4,
                                    pointBackgroundColor: colorPrimary
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        grid: { color: colorDivider },
                                        ticks: {
                                            color: colorSecondary,
                                            callback: function (value) {
                                                return 'R$ ' + (value / 1000).toFixed(0) + 'k';
                                            }
                                        }
                                    },
                                    x: {
                                        grid: { display: false },
                                        ticks: { color: colorSecondary }
                                    }
                                }
                            }
                        });
                    }
                });

                async function marcarPago(id) {
                    if (!confirm('Confirma que recebeu o pagamento desta mineração?')) return;
                    try {
                        const res = await fetch(`/api/financeiro/confirmar-pagamento/${id}`, { method: 'POST' });
                        const d = await res.json();
                        if (d.success) window.location.reload();
                    } catch (e) { alert('Erro'); }
                }
            </script>

            <!-- SAFE DATA STORAGE -->
            <script>
                window.dashboardCommissionData = <% - JSON.stringify(commissionDetails || []) %>;
            </script>

            <!-- MODAL DASHBOARD COMISSÕES -->
            <div id="dashboardCommissionModal" class="macos-modal-overlay" style="z-index: 99999;">
                <div class="macos-window"
                    style="width: 500px; max-width: 90%; background: var(--macos-bg-secondary); border-radius: 16px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); display: flex; flex-direction: column; max-height: 85vh;">

                    <!-- Header -->
                    <div class="modal-header"
                        style="background: var(--macos-bg-base); padding: 20px 24px; border-bottom: 1px solid var(--macos-divider); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                        <div>
                            <h3 style="margin:0; font-size: 16px; font-weight: 700; color: var(--macos-text-primary);">
                                Detalhamento de Comissões</h3>
                            <p style="margin:0; font-size: 12px; color: var(--macos-text-secondary);">Breakdown
                                financeiro da carteira</p>
                        </div>
                        <button onclick="closeDashboardCommissionModal()"
                            style="border:none; background:var(--macos-bg-tertiary); width:28px; height:28px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; color: var(--macos-text-primary);">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>

                    <!-- Body (Scrollable) -->
                    <div style="padding: 24px; background: var(--macos-bg-base); overflow-y: auto; flex-grow: 1;">

                        <!-- Total Big Number -->
                        <div style="text-align: center; margin-bottom: 24px;">
                            <p
                                style="font-size: 12px; text-transform: uppercase; font-weight: 600; color: var(--macos-text-secondary); margin-bottom: 4px;">
                                Comissão Total Prevista</p>
                            <h2 style="font-size: 36px; font-weight: 800; color: #10b981; margin: 0;"
                                id="dashCommTotal">R$ 0,00</h2>
                        </div>

                        <!-- Stats Row -->
                        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                            <div
                                style="flex: 1; background: #FFF7ED; padding: 12px; border-radius: 12px; border: 1px solid rgba(249, 115, 22, 0.2);">
                                <p style="font-size: 11px; color: #C2410C; margin-bottom: 4px; font-weight: 600;">
                                    MINERAÇÃO</p>
                                <p style="font-size: 16px; font-weight: 700; color: #9A3412;" id="dashCommMiningTotal">
                                    R$ 0,00</p>
                            </div>
                            <div
                                style="flex: 1; background: #EFF6FF; padding: 12px; border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.2);">
                                <p style="font-size: 11px; color: #1D4ED8; margin-bottom: 4px; font-weight: 600;">
                                    CORRETAGEM</p>
                                <p style="font-size: 16px; font-weight: 700; color: #1E40AF;" id="dashCommSalesTotal">R$
                                    0,00</p>
                            </div>
                        </div>

                        <!-- List Header -->
                        <h4
                            style="font-size: 13px; font-weight: 600; color: var(--macos-text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                            Extrato Detalhado</h4>

                        <!-- The List -->
                        <div id="dashCommList" style="display: flex; flex-direction: column; gap: 8px;">
                            <!-- Items injected here via JS -->
                        </div>

                    </div>
                </div>
            </div>

            <!-- Script -->
            <script>
                function openCommissionDashboardModal() {
                    try {
                        // Get data from global variable
                        const data = window.dashboardCommissionData || [];

                        let total = 0;
                        let mining = 0;
                        let sales = 0;
                        const fmt = (v) => (v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                        const listEl = document.getElementById('dashCommList');
                        listEl.innerHTML = '';

                        if (data.length === 0) {
                            listEl.innerHTML = '<p style="text-align:center; color: var(--macos-text-secondary); font-size: 13px; padding: 20px;">Nenhuma comissão registrada.</p>';
                        }

                        data.forEach(item => {
                            const val = parseFloat(item.valor || 0);
                            total += val;

                            let iconClass = 'fa-coins';
                            let bgClass = '#F3F4F6';
                            let colorClass = '#6B7280';

                            if (item.tipo.includes('Mineração')) {
                                mining += val;
                                iconClass = 'fa-microscope';
                                bgClass = '#FFF7ED';
                                colorClass = '#F97316';
                            } else if (item.tipo.includes('Venda') || item.tipo.includes('Corretagem')) {
                                sales += val;
                                iconClass = 'fa-handshake';
                                bgClass = '#EFF6FF';
                                colorClass = '#3B82F6';
                            }

                            // Create Row
                            const row = document.createElement('div');
                            row.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--macos-bg-tertiary); border-radius: 10px; border: 1px solid var(--macos-divider);';

                            row.innerHTML = `
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <div style="width: 32px; height: 32px; background: ${bgClass}; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: ${colorClass}; flex-shrink: 0;">
                                <i class="fa-solid ${iconClass}" style="font-size: 14px;"></i>
                            </div>
                            <div style="overflow: hidden;">
                                <p style="font-size: 13px; font-weight: 600; color: var(--macos-text-primary); margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;">${item.descricao}</p>
                                <p style="font-size: 11px; color: var(--macos-text-secondary); margin: 0;">${item.tipo}</p>
                            </div>
                        </div>
                        <div style="text-align: right; flex-shrink: 0;">
                            <p style="font-size: 13px; font-weight: 700; color: var(--macos-text-primary); margin: 0;">${fmt(val)}</p>
                        </div>
                    `;
                            listEl.appendChild(row);
                        });

                        document.getElementById('dashCommTotal').innerText = fmt(total);
                        document.getElementById('dashCommMiningTotal').innerText = fmt(mining);
                        document.getElementById('dashCommSalesTotal').innerText = fmt(sales);

                        document.getElementById('dashboardCommissionModal').classList.add('is-visible');

                    } catch (e) {
                        console.error("Erro abrir modal comissao dashboard:", e);
                        // Fail silently or simplistic alert, but don't break the page
                    }
                }

                function closeDashboardCommissionModal() {
                    document.getElementById('dashboardCommissionModal').classList.remove('is-visible');
                }

                document.getElementById('dashboardCommissionModal').addEventListener('click', function (e) {
                    if (e.target === this) closeDashboardCommissionModal();
                });
            </script>
</body>

</html>