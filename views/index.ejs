<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <title>Fortal - Dashboard</title>
    <%- include('partials/head') %>
</head>

<body class="min-h-screen page-home">

    <%- include('partials/macos-toolbar', { title: 'Dashboard' , username: username, profile_pic_url: profile_pic_url })
        %>
        <%- include('partials/macos-sidebar', { user: user }) %>

            <main class="macos-main-content">
                <div class="animate-fade-in" style="padding-bottom: 40px; max-width: 1200px; margin: 0 auto;">

                    <!-- Welcome Header -->
                    <div class="mb-8">
                        <h1 class="text-3xl font-bold text-[var(--macos-text-primary)] mb-2">
                            Bem-vindo de volta, <%= username %>!
                        </h1>
                        <p class="text-[var(--macos-text-secondary)]">Aqui está o resumo da sua carteira de arremates.
                        </p>
                    </div>

                    <% if (stats) { %>
                        <!-- Stats Grid -->
                        <!-- Stats Grid (Advisor View) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <!-- VGV sob Gestão -->
                            <div
                                class="macos-card p-6 relative overflow-hidden group hover:scale-[1.02] transition-transform duration-300">
                                <div
                                    class="absolute top-4 right-4 w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center">
                                    <i class="fa-solid fa-sack-dollar text-blue-500 text-lg"></i>
                                </div>
                                <p
                                    class="text-sm font-semibold text-[var(--macos-text-secondary)] uppercase tracking-wider mb-2">
                                    VGV sob Gestão</p>
                                <h3 class="text-2xl font-bold text-[var(--macos-text-primary)]">
                                    <%= stats.vgv_gestao.toLocaleString('pt-BR', { style: 'currency' , currency: 'BRL'
                                        }) %>
                                </h3>
                                <div class="mt-4 flex items-center text-xs text-[var(--macos-text-tertiary)]">
                                    <i class="fa-solid fa-chart-line mr-1"></i>
                                    Volume Geral de Vendas
                                </div>
                            </div>

                            <!-- Comissão Prevista -->
                            <div
                                class="macos-card p-6 relative overflow-hidden group hover:scale-[1.02] transition-transform duration-300">
                                <div
                                    class="absolute top-4 right-4 w-10 h-10 rounded-full bg-green-500/10 flex items-center justify-center">
                                    <i class="fa-solid fa-hand-holding-dollar text-green-500 text-lg"></i>
                                </div>
                                <p
                                    class="text-sm font-semibold text-[var(--macos-text-secondary)] uppercase tracking-wider mb-2">
                                    Comissão Prevista</p>
                                <h3 class="text-2xl font-bold text-[var(--macos-text-primary)]">
                                    <%= stats.comissao_prevista.toLocaleString('pt-BR', { style: 'currency' ,
                                        currency: 'BRL' }) %>
                                </h3>
                                <div
                                    class="mt-4 flex items-center text-xs text-green-600 bg-green-500/10 px-2 py-1 rounded w-fit">
                                    <i class="fa-solid fa-check mr-1"></i> Base 6%
                                </div>
                            </div>

                            <!-- Clientes Ativos -->
                            <div
                                class="macos-card p-6 relative overflow-hidden group hover:scale-[1.02] transition-transform duration-300">
                                <div
                                    class="absolute top-4 right-4 w-10 h-10 rounded-full bg-purple-500/10 flex items-center justify-center">
                                    <i class="fa-solid fa-users text-purple-500 text-lg"></i>
                                </div>
                                <p
                                    class="text-sm font-semibold text-[var(--macos-text-secondary)] uppercase tracking-wider mb-2">
                                    Clientes Ativos</p>
                                <h3 class="text-2xl font-bold text-purple-500">
                                    <%= stats.clientes_ativos %>
                                </h3>
                                <p class="mt-4 text-xs text-[var(--macos-text-secondary)]">Carteira de Clientes</p>
                            </div>

                            <!-- Imóveis sob Gestão -->
                            <div
                                class="macos-card p-6 relative overflow-hidden group hover:scale-[1.02] transition-transform duration-300">
                                <div
                                    class="absolute top-4 right-4 w-10 h-10 rounded-full bg-orange-500/10 flex items-center justify-center">
                                    <i class="fa-solid fa-building-user text-orange-500 text-lg"></i>
                                </div>
                                <p
                                    class="text-sm font-semibold text-[var(--macos-text-secondary)] uppercase tracking-wider mb-2">
                                    Imóveis sob Gestão</p>
                                <h3 class="text-2xl font-bold text-[var(--macos-text-primary)]">
                                    <%= stats.total_imoveis %>
                                </h3>
                                <p class="mt-4 text-xs text-[var(--macos-text-secondary)]">Total de ativos gerenciados
                                </p>
                            </div>
                        </div>
                        <% } %>

                            <!-- Performance Chart Section -->
                            <% if (typeof growth !=='undefined' && growth) { %>
                                <div class="macos-card p-6 mb-8 group animate-fade-in delay-75">
                                    <div class="flex items-center justify-between mb-6">
                                        <div>
                                            <h2 class="text-xl font-semibold text-[var(--macos-text-primary)]">
                                                Performance do Assessor</h2>
                                            <p class="text-sm text-[var(--macos-text-secondary)]">Crescimento do
                                                Potencial de Lucro (Últimos 6 meses)</p>
                                        </div>
                                        <div
                                            class="flex items-center gap-2 text-xs font-medium text-green-500 bg-green-500/10 px-3 py-1.5 rounded-full ring-1 ring-green-500/20">
                                            <i class="fa-solid fa-chart-line"></i>
                                            <span>Análise de Tendência</span>
                                        </div>
                                    </div>

                                    <div class="relative w-full h-[300px]">
                                        <canvas id="growthChart"></canvas>
                                    </div>
                                </div>
                                <% } %>

                                    <!-- Content Split -->
                                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                                        <!-- Full Width: Recent Properties -->
                                        <div class="lg:col-span-3">
                                            <div class="flex items-center justify-between mb-4">
                                                <h2 class="text-xl font-semibold text-[var(--macos-text-primary)]">
                                                    Imóveis
                                                    Recentes (Carteira)</h2>
                                                <a href="/carteira"
                                                    class="text-sm text-[var(--macos-accent)] hover:opacity-80 font-medium">Ver
                                                    todos</a>
                                            </div>

                                            <div class="macos-card p-0 overflow-hidden min-h-[300px]">
                                                <% if (recentProperties && recentProperties.length> 0) { %>
                                                    <div class="divide-y divide-[var(--macos-divider)]">
                                                        <% recentProperties.forEach(imovel=> { %>
                                                            <div class="p-4 hover:bg-[var(--macos-bg-tertiary)] transition-colors flex items-center gap-4 cursor-pointer"
                                                                onclick="window.location.href='/carteira/<%= imovel.id %>'">
                                                                <div
                                                                    class="w-12 h-12 rounded-lg bg-[var(--macos-bg-secondary)] flex items-center justify-center flex-shrink-0">
                                                                    <i
                                                                        class="fa-solid fa-house text-[var(--macos-text-secondary)]"></i>
                                                                </div>
                                                                <div class="flex-1 min-w-0">
                                                                    <h4
                                                                        class="text-sm font-weight-600 text-[var(--macos-text-primary)] truncate">
                                                                        <%= imovel.descricao %>
                                                                    </h4>
                                                                    <p
                                                                        class="text-xs text-[var(--macos-text-secondary)] truncate">
                                                                        <i class="fa-solid fa-location-dot mr-1"></i>
                                                                        <%= imovel.endereco %>
                                                                    </p>
                                                                </div>
                                                                <div class="text-right">
                                                                    <p
                                                                        class="text-sm font-semibold text-[var(--macos-text-primary)]">
                                                                        <%= (imovel.total_investido ||
                                                                            imovel.valor_compra ||
                                                                            0).toLocaleString('pt-BR', {
                                                                            style: 'currency' , currency: 'BRL' }) %>
                                                                    </p>
                                                                    <span
                                                                        class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400">
                                                                        <%= imovel.status || 'Ativo' %>
                                                                    </span>
                                                                </div>
                                                                <i
                                                                    class="fa-solid fa-chevron-right text-xs text-[var(--macos-text-tertiary)]"></i>
                                                            </div>
                                                            <% }); %>
                                                    </div>
                                                    <% } else { %>
                                                        <div
                                                            class="flex flex-col items-center justify-center h-full py-12">
                                                            <div
                                                                class="w-16 h-16 bg-[var(--macos-bg-tertiary)] rounded-full flex items-center justify-center mb-4">
                                                                <i
                                                                    class="fa-solid fa-house text-[var(--macos-text-tertiary)] text-2xl"></i>
                                                            </div>
                                                            <h3
                                                                class="text-lg font-medium text-[var(--macos-text-primary)]">
                                                                Nenhum imóvel ainda</h3>
                                                            <p class="text-[var(--macos-text-secondary)] text-sm mb-4">
                                                                Comece
                                                                adicionando seu primeiro arremate.</p>
                                                            <a href="/calculadora" class="macos-btn-primary">
                                                                <i class="fa-solid fa-plus mr-2"></i> Criar Nova
                                                                Simulação
                                                            </a>
                                                        </div>
                                                        <% } %>
                                            </div>
                                        </div>

                                    </div>

                </div>
            </main>

            <script src="/js/app.js"></script>

            <!-- Chart.js for Performance Metrics -->
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    <% if (typeof growth !== 'undefined' && growth) { %>
                    const ctx = document.getElementById('growthChart').getContext('2d');

                        // Gradient fill for sleek look
                        const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                        gradient.addColorStop(0, 'rgba(16, 185, 129, 0.2)'); // Green-500 with opacity
                        gradient.addColorStop(1, 'rgba(16, 185, 129, 0.0)');

                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: <% - JSON.stringify(growth.labels) %>,
                                datasets: [{
                                    label: 'Potencial de Lucro (R$)',
                                    data: <% - JSON.stringify(growth.profitData) %>,
                                    borderColor: '#10b981', // green-500
                                    backgroundColor: gradient,
                                    borderWidth: 3,
                                    pointBackgroundColor: '#18181b', // dark bg color match
                                    pointBorderColor: '#10b981',
                                    pointBorderWidth: 2,
                                    pointRadius: 4,
                                    pointHoverRadius: 6,
                                    pointHoverBackgroundColor: '#10b981',
                                    pointHoverBorderColor: '#fff',
                                    fill: true,
                                    tension: 0.4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index',
                                },
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        backgroundColor: 'rgba(24, 24, 27, 0.9)', // zinc-900
                                        titleColor: '#fff',
                                        bodyColor: '#e4e4e7', // zinc-200
                                        padding: 12,
                                        borderColor: 'rgba(255,255,255,0.1)',
                                        borderWidth: 1,
                                        titleFont: { size: 13, family: "'Plus Jakarta Sans', sans-serif" },
                                        bodyFont: { size: 14, weight: 'bold', family: "'Plus Jakarta Sans', sans-serif" },
                                        callbacks: {
                                            label: function (context) {
                                                return 'Potencial: ' + context.parsed.y.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        grid: { color: 'rgba(255, 255, 255, 0.03)' },
                                        ticks: {
                                            color: '#71717a', // zinc-500
                                            font: { family: "'Plus Jakarta Sans', sans-serif", size: 11 },
                                            callback: function (value) {
                                                if (value >= 1000000) return 'R$ ' + (value / 1000000).toFixed(1) + 'M';
                                                if (value >= 1000) return 'R$ ' + (value / 1000).toFixed(0) + 'k';
                                                return value;
                                            }
                                        },
                                        border: { display: false }
                                    },
                                    x: {
                                        grid: { display: false },
                                        ticks: {
                                            color: '#a1a1aa', // zinc-400
                                            font: { family: "'Plus Jakarta Sans', sans-serif", size: 11, weight: '500' }
                                        },
                                        border: { display: false }
                                    }
                                }
                            }
                        });
                    <% } %>
                });
            </script>
</body>

</html>