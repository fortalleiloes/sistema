<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <%- include('partials/head') %>
        <title>Banco de Oportunidades - Fortal</title>
        <!-- Leaflet Maps CSS -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

        <style>
            :root {
                --map-height: 380px;
            }

            /* MODAL VISIBILITY CLASS */
            .macos-modal-overlay {
                display: none;
                opacity: 0;
                transition: opacity 0.2s ease-in-out;
            }

            .macos-modal-overlay.is-visible {
                display: flex !important;
                opacity: 1;
            }

            .macos-main-content {
                padding: 0 !important;
                height: 100vh;
                overflow-y: auto;
                overflow-x: hidden;
                /* Previne scroll lateral */
                /* Scroll na página toda */
                display: block;
                /* Remove flex column que travava */
                background: var(--macos-bg-base);
                position: relative;
                box-sizing: border-box;
            }

            .stack-layout {
                display: block;
                min-height: 100%;
            }

            /* PAINEL SUPERIOR: MAPA (NORMAL FLOW) */
            .map-header-container {
                height: var(--map-height);
                z-index: 10;
                padding: 16px 24px 0 24px;
                background: var(--macos-bg-base);
                border-bottom: 1px solid transparent;
                transition: box-shadow 0.2s;
            }

            .map-rounded-box {
                width: 100%;
                height: 100%;
                border-radius: 16px;
                overflow: hidden;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
                border: 1px solid var(--macos-divider);
                background: #e5e5e5;
            }

            #map-view {
                width: 100%;
                height: 100%;
            }

            /* PAINEL INFERIOR: LISTA (SEM SCROLL INTERNO) */
            .list-section {
                padding: 24px;
                overflow: visible;
                /* Expande com conteudo */
            }

            .list-header-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 16px;
                flex-shrink: 0;
                padding: 0 4px;
            }

            /* GRID DE CARDS */
            .cards-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
                /* Responsivo */
                gap: 20px;
                padding-bottom: 40px;
            }

            /* FILTER SELECT STYLING */
            .filter-container {
                position: relative;
                display: inline-block;
            }

            .macos-select-custom {
                appearance: none;
                background-color: var(--macos-bg-secondary);
                border: 1px solid var(--macos-divider);
                border-radius: 8px;
                padding: 8px 36px 8px 12px;
                font-size: 13px;
                font-weight: 500;
                color: var(--macos-text-primary);
                cursor: pointer;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
                transition: all 0.2s;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 8px center;
                background-size: 16px;
            }

            .macos-select-custom:hover,
            .macos-select-custom:focus {
                border-color: var(--macos-accent);
                box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
                outline: none;
            }

            /* PREMIUM CARD DESIGN */
            .opportunity-card {
                background: var(--macos-bg-secondary);
                border-radius: 16px;
                border: 1px solid var(--macos-divider);
                /* Borda sutil */
                overflow: hidden;
                transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
                cursor: pointer;
                display: flex;
                flex-direction: column;
                position: relative;
            }

            .opportunity-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08), 0 4px 8px rgba(0, 0, 0, 0.04);
                border-color: rgba(0, 0, 0, 0.05);
            }

            .card-image {
                height: 180px;
                background: var(--macos-bg-tertiary);
                position: relative;
            }

            .card-image img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform 0.5s ease;
            }

            .opportunity-card:hover .card-image img {
                transform: scale(1.05);
            }

            .card-image .placeholder {
                display: flex;
                align-items: center;
                justify-content: center;
                height: 100%;
                color: rgba(0, 0, 0, 0.2);
                font-size: 32px;
            }

            /* Floating Badges on Image */
            .card-overlay-badges {
                position: absolute;
                top: 12px;
                left: 12px;
                display: flex;
                gap: 6px;
                z-index: 2;
            }

            .badge-glass {
                background: rgba(255, 255, 255, 0.9);
                backdrop-filter: blur(4px);
                padding: 4px 8px;
                border-radius: 6px;
                font-size: 11px;
                font-weight: 700;
                color: var(--macos-text-primary);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                display: flex;
                align-items: center;
                gap: 4px;
            }

            .badge-glass.roi {
                color: #27ae60;
            }

            .badge-glass.loc {
                color: var(--macos-text-secondary);
                font-weight: 500;
            }

            /* Card Content */
            .card-body {
                padding: 16px;
                display: flex;
                flex-direction: column;
                flex: 1;
                z-index: 5;
                background: var(--macos-bg-secondary);
            }

            .card-title {
                font-size: 16px;
                font-weight: 700;
                color: var(--macos-text-primary);
                margin-bottom: 4px;
                line-height: 1.3;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .card-subtitle {
                font-size: 13px;
                color: var(--macos-text-secondary);
                margin-bottom: 16px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .card-metrics-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                padding: 12px;
                background: var(--macos-bg-tertiary);
                border-radius: 10px;
                margin-bottom: 16px;
            }

            .metric-mini {
                display: flex;
                flex-direction: column;
            }

            .metric-mini label {
                font-size: 10px;
                color: var(--macos-text-tertiary);
                text-transform: uppercase;
                font-weight: 600;
                margin-bottom: 2px;
            }

            .metric-mini span {
                font-size: 14px;
                font-weight: 700;
                color: var(--macos-text-primary);
            }

            .metric-mini span.green {
                color: #27ae60;
            }

            .btn-view-details {
                margin-top: auto;
                width: 100%;
                padding: 10px;
                border-radius: 8px;
                background: var(--macos-accent);
                color: white;
                font-size: 13px;
                font-weight: 600;
                text-align: center;
                border: none;
                cursor: pointer;
                opacity: 0.9;
                transition: all 0.2s;
            }

            .btn-view-details:hover {
                opacity: 1;
                transform: scale(1.02);
            }

            /* Delete Button - Floating Top Right */
            .btn-delete {
                position: absolute;
                top: 12px;
                right: 12px;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                background: white;
                color: #e74c3c;
                border: 1px solid rgba(0, 0, 0, 0.1);
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: 0.2s;
                cursor: pointer;
                z-index: 10;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            }

            .opportunity-card:hover .btn-delete {
                opacity: 1;
                transform: scale(1);
            }

            .btn-delete:hover {
                background: #e74c3c;
                color: white;
                border-color: #e74c3c;
            }

            /* CUSTOM FILE UPLOAD */
            .file-upload-box {
                border: 1px dashed var(--macos-divider);
                background: var(--macos-bg-tertiary);
                border-radius: 8px;
                padding: 16px;
                text-align: center;
                position: relative;
                cursor: pointer;
                transition: all 0.2s;
            }

            .file-upload-box:hover {
                border-color: var(--macos-accent);
                background: rgba(255, 255, 255, 0.5);
            }

            .file-upload-box input {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                opacity: 0;
                cursor: pointer;
            }

            .file-upload-icon {
                font-size: 20px;
                color: var(--macos-text-tertiary);
                margin-bottom: 8px;
            }

            .file-upload-box.has-file {
                border-style: solid;
                border-color: #2ecc71;
                background: rgba(46, 204, 113, 0.05);
            }

            /* AUTOCOMPLETE & MINI MAP */
            .suggestions-dropdown {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: var(--macos-bg-secondary);
                border: 1px solid var(--macos-divider);
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 1000;
                max-height: 200px;
                overflow-y: auto;
                display: none;
            }

            .suggestion-item {
                padding: 10px 12px;
                font-size: 13px;
                cursor: pointer;
                border-bottom: 1px solid var(--macos-divider);
                color: var(--macos-text-primary);
            }

            .suggestion-item:hover {
                background: var(--macos-accent);
                color: white;
            }

            .suggestion-item:last-child {
                border-bottom: none;
            }

            #miniMap {
                width: 100%;
                height: 220px;
                background: #eee;
                border-radius: 8px;

                .macos-modal-overlay {
                    position: fixed;
                    inset: 0;
                    background: rgba(0, 0, 0, 0.4);
                    backdrop-filter: blur(8px);
                    display: none;
                    justify-content: center;
                    align-items: center;
                    z-index: 99999;
                }

                .macos-modal-overlay.is-visible {
                    display: flex !important;
                }
        </style>
</head>

<body class="macos-theme">

    <!-- Dados brutos para JS -->
    <script id="opportunities-raw-data" type="application/json">
        <%- JSON.stringify(oportunidades || []) %>
    </script>

    <div class="macos-layout">
        <!-- Toolbar (Top) -->
        <%- include('partials/macos-toolbar', { title: 'Banco de Oportunidades' }) %>

            <!-- Sidebar Global (Nav) -> Deve ser filho direto de macos-layout -->
            <%- include('partials/macos-sidebar') %>

                <!-- Conteúdo Principal -->
                <main class="macos-main-content">

                    <div class="stack-layout">

                        <!-- 1. MAPA NO TOPO (FIXO) -->
                        <div class="map-header-container">
                            <div class="map-rounded-box">
                                <div id="map-view"></div>
                            </div>
                        </div>

                        <!-- 2. LISTA ABAIXO (SCROLL) -->
                        <div class="list-section">

                            <!-- Header da Lista -->
                            <div class="list-header-row">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <h2
                                        style="font-size: 20px; font-weight: 700; margin: 0; color: var(--macos-text-primary);">
                                        Oportunidades Disponíveis</h2>
                                    <span
                                        style="font-size: 13px; color: var(--macos-text-secondary); background:var(--macos-bg-tertiary); padding:2px 8px; border-radius:12px;">
                                        <%= oportunidades.length %> imóveis
                                    </span>
                                </div>

                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <!-- Filtro Customizado -->
                                    <div class="filter-container">
                                        <select id="listaFiltroEstado" class="macos-select-custom">
                                            <option value="">Todos os Estados</option>
                                        </select>
                                    </div>

                                    <button id="triggerAddOp" class="macos-btn-primary" type="button">
                                        <i class="fa-solid fa-plus mr-2"></i> Adicionar Imóvel
                                    </button>
                                </div>
                            </div>

                            <!-- Grid de Cards -->
                            <div class="cards-grid" id="listaCards">
                                <% if (oportunidades.length===0) { %>
                                    <div
                                        style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: var(--macos-text-secondary);">
                                        <i class="fa-regular fa-map"
                                            style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                                        <h3>Nenhuma oportunidade encontrada</h3>
                                        <p>Comece adicionando imóveis ao banco de dados.</p>
                                    </div>
                                    <% } else { %>
                                        <% oportunidades.forEach(op=> { %>
                                            <div class="opportunity-card" id="card-<%= op.id %>"
                                                onclick="focusOnMap(<%= op.latitude %>, <%= op.longitude %>, '<%= op.id %>')"
                                                onmouseenter="highlightPin('<%= op.id %>')"
                                                onmouseleave="unhighlightPin('<%= op.id %>')">

                                                <button class="btn-delete"
                                                    onclick="deleteOpportunity('<%= op.id %>', event)" title="Excluir">
                                                    <i class="fa-solid fa-trash"></i>
                                                </button>

                                                <div class="card-image">
                                                    <% if(op.foto_capa) { %>
                                                        <img src="<%= op.foto_capa %>" alt="<%= op.titulo %>">
                                                        <% } else { %>
                                                            <div class="placeholder"><i class="fa-solid fa-house"></i>
                                                            </div>
                                                            <% } %>

                                                                <!-- Badges Flutuantes -->
                                                                <div class="card-overlay-badges">
                                                                    <% if (op.roi_estimado) { %>
                                                                        <div class="badge-glass roi">
                                                                            <i class="fa-solid fa-chart-line"></i> ROI
                                                                            <%= (op.roi_estimado).toFixed(0) %>%
                                                                        </div>
                                                                        <% } %>
                                                                            <div class="badge-glass loc">
                                                                                <i class="fa-solid fa-location-dot"></i>
                                                                                <%= op.estado %>
                                                                            </div>
                                                                </div>
                                                </div>

                                                <div class="card-body">
                                                    <div class="card-title" title="<%= op.titulo %>">
                                                        <%= op.titulo %>
                                                    </div>
                                                    <div class="card-subtitle"><i class="fa-solid fa-map-pin mr-1"></i>
                                                        <%= op.cidade %>
                                                    </div>

                                                    <div class="card-metrics-grid">
                                                        <div class="metric-mini">
                                                            <label>Valor Venda</label>
                                                            <span>
                                                                <%= (op.valor_venda || 0).toLocaleString('pt-BR',
                                                                    {style: 'currency' , currency: 'BRL' ,
                                                                    maximumFractionDigits:0}) %>
                                                            </span>
                                                        </div>
                                                        <div class="metric-mini">
                                                            <label>Lucro Est.</label>
                                                            <span class="green">
                                                                <%= (op.lucro_estimado || 0).toLocaleString('pt-BR',
                                                                    {style: 'currency' , currency: 'BRL' ,
                                                                    maximumFractionDigits:0}) %>
                                                            </span>
                                                        </div>
                                                    </div>

                                                    <button type="button" class="btn-view-details"
                                                        onclick="event.preventDefault(); event.stopPropagation(); openDetails('<%= op.id %>')">
                                                        Ver Detalhes do Imóvel
                                                    </button>
                                                </div>
                                            </div>
                                            <% }) %>
                                                <% } %>
                            </div>

                        </div>
                    </div>
                </main>
    </div>

    <!-- MODAIS (Mantidos funcionais) -->

    <!-- Modal Add (Simplificado Visualmente) -->
    <!-- Modal Add (Premium Design) -->
    <div id="addModal" class="macos-modal-overlay" style="z-index: 99999;">
        <div class="macos-window"
            style="width: 550px; max-width: 95%; height: auto; max-height: 90vh; display: flex; flex-direction: column; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3);">

            <!-- Header -->
            <div class="modal-header"
                style="background: var(--macos-bg-secondary); padding: 20px 24px; border-bottom: 1px solid var(--macos-divider); display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="margin:0; font-size: 18px; font-weight: 700; color: var(--macos-text-primary);">Nova
                        Oportunidade</h3>
                    <p style="margin:0; font-size: 12px; color: var(--macos-text-secondary);">Preencha os dados do
                        imóvel</p>
                </div>
                <button onclick="closeAddModal()"
                    style="border:none; background:var(--macos-bg-tertiary); width:32px; height:32px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; color: var(--macos-text-primary); transition: background 0.2s;">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <!-- Body -->
            <form id="addForm" onsubmit="submitDetails(event)"
                style="padding: 24px; overflow-y: auto; flex: 1; background: var(--macos-bg-base);">

                <!-- Import Callout -->
                <!-- Import Callout (Clean) -->
                <div
                    style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; padding: 12px 16px; background: var(--macos-bg-tertiary); border-radius: 12px; border: 1px solid var(--macos-divider);">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div
                            style="width: 28px; height: 28px; background: #f59e0b; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white;">
                            <i class="fa-solid fa-bolt" style="font-size: 14px;"></i>
                        </div>
                        <div>
                            <div style="font-size: 13px; font-weight: 600; color: var(--macos-text-primary);">Importar
                                Dados</div>
                            <div style="font-size: 11px; color: var(--macos-text-secondary);">Preencher com calculadora
                            </div>
                        </div>
                    </div>
                    <select id="selCalculo" class="macos-input" onchange="importarCalculo(this.value)"
                        style="width: 200px; background: var(--macos-bg-base); border-color: var(--macos-divider); font-size: 12px;">
                        <option value="">Selecionar...</option>
                    </select>
                </div>

                <!-- Fields -->
                <div class="macos-form-group" style="margin-bottom: 20px;">
                    <label class="macos-form-label">Título do Anúncio</label>
                    <input type="text" name="titulo" id="inpTitulo" class="macos-input" required
                        placeholder="Ex: Apartamento no Meireles" style="font-weight: 500;">
                </div>

                <div class="macos-form-group" style="margin-bottom: 20px; position: relative;">
                    <label class="macos-form-label">Localização (Busca Inteligente)</label>
                    <div style="position: relative;">
                        <input type="text" id="inpBuscaEnd" class="macos-input"
                            placeholder="Digite rua, número, cidade..." autocomplete="off"
                            oninput="handleAddressInput(this.value)">

                        <!-- Dropdown Sugestões -->
                        <div id="addressSuggestions" class="suggestions-dropdown"></div>
                    </div>

                    <!-- Mini Mapa de Confirmação -->
                    <div id="miniMap"></div>
                    <div id="mapHelpText"
                        style="font-size: 11px; color: var(--macos-text-secondary); margin-top: 6px; text-align: center; display:none;">
                        <i class="fa-solid fa-arrows-up-down-left-right"></i> Arraste o pino para ajustar a localização
                        exata.
                    </div>

                    <input type="hidden" name="latitude" id="inpLat">
                    <input type="hidden" name="longitude" id="inpLng">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 100px; gap: 16px; margin-bottom: 24px;">
                    <div class="macos-form-group">
                        <label class="macos-form-label">Cidade</label>
                        <input type="text" name="cidade" id="inpCidade" class="macos-input" required>
                    </div>
                    <div class="macos-form-group">
                        <label class="macos-form-label">UF</label>
                        <select name="estado" id="inpUF" class="macos-input" required style="text-align:center;">
                            <option value="" disabled selected>UF</option>
                            <option value="AC">AC</option>
                            <option value="AL">AL</option>
                            <option value="AP">AP</option>
                            <option value="AM">AM</option>
                            <option value="BA">BA</option>
                            <option value="CE">CE</option>
                            <option value="DF">DF</option>
                            <option value="ES">ES</option>
                            <option value="GO">GO</option>
                            <option value="MA">MA</option>
                            <option value="MT">MT</option>
                            <option value="MS">MS</option>
                            <option value="MG">MG</option>
                            <option value="PA">PA</option>
                            <option value="PB">PB</option>
                            <option value="PR">PR</option>
                            <option value="PE">PE</option>
                            <option value="PI">PI</option>
                            <option value="RJ">RJ</option>
                            <option value="RN">RN</option>
                            <option value="RS">RS</option>
                            <option value="RO">RO</option>
                            <option value="RR">RR</option>
                            <option value="SC">SC</option>
                            <option value="SP">SP</option>
                            <option value="SE">SE</option>
                            <option value="TO">TO</option>
                        </select>
                    </div>
                </div>

                <div class="macos-divider" style="margin-bottom: 24px;"></div>

                <!-- Uploads -->
                <label class="macos-form-label" style="margin-bottom:12px;">Arquivos e Imagens</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                    <div class="file-upload-box">
                        <input type="file" name="foto_upload" accept="image/*" onchange="updFile(this, 'Capa')">
                        <div
                            style="width:40px; height:40px; background:var(--macos-bg-tertiary); border-radius:50%; display:flex; align-items:center; justify-content:center; margin: 0 auto 8px auto;">
                            <i class="fa-regular fa-image" style="color:var(--macos-accent);"></i>
                        </div>
                        <div class="file-text" style="font-weight:600; font-size:13px;">Foto de Capa</div>
                        <div style="font-size:11px; color:var(--macos-text-tertiary);">JPG ou PNG</div>
                    </div>
                    <div class="file-upload-box">
                        <input type="file" name="pdf_proposta" accept="application/pdf"
                            onchange="updFile(this, 'Estudo')" required>
                        <div
                            style="width:40px; height:40px; background:var(--macos-bg-tertiary); border-radius:50%; display:flex; align-items:center; justify-content:center; margin: 0 auto 8px auto;">
                            <i class="fa-solid fa-file-pdf text-red-500"></i>
                        </div>
                        <div class="file-text" style="font-weight:600; font-size:13px;">PDF do Estudo</div>
                        <div style="font-size:11px; color:var(--macos-text-secondary);">Obrigatório</div>
                    </div>
                    <div class="file-upload-box">
                        <input type="file" name="pdf_analise_juridica" accept="application/pdf"
                            onchange="updFile(this, 'Jurídico')" required>
                        <div
                            style="width:40px; height:40px; background:var(--macos-bg-tertiary); border-radius:50%; display:flex; align-items:center; justify-content:center; margin: 0 auto 8px auto;">
                            <i class="fa-solid fa-scale-balanced text-blue-500"></i>
                        </div>
                        <div class="file-text" style="font-weight:600; font-size:13px;">Análise Jurídica</div>
                        <div style="font-size:11px; color:var(--macos-text-secondary);">Obrigatório</div>
                    </div>
                </div>

                <!-- Hidden Financials -->
                <input type="hidden" name="valor_arremate" id="invArremate">
                <input type="hidden" name="valor_venda" id="invVenda">
                <input type="hidden" name="lucro_estimado" id="invLucro">
                <input type="hidden" name="roi_estimado" id="invRoi">
                <input type="hidden" name="calculo_origem_id" id="invCalcId">

                <div style="margin-top: 32px; display:flex; justify-content:flex-end; gap:12px;">
                    <button type="button" class="macos-btn-secondary" onclick="closeAddModal()">Cancelar</button>
                    <button type="submit" class="macos-btn-primary" style="padding: 8px 24px;">Salvar Imóvel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detalhes -->
    <!-- Modal Detalhes (Premium Dashboard) -->
    <!-- Modal Detalhes (Premium Dashboard) -->
    <div id="detailsModal" class="macos-modal-overlay" style="z-index: 99999;">
        <div class="macos-window" id="detailsWindow"
            style="width: 800px; max-width: 95%; max-height: 90vh; overflow-y:auto; border-radius: 16px; box-shadow: 0 30px 60px rgba(0,0,0,0.3);">

            <!-- Hero Header -->
            <div style="position: relative; height: 200px; background: var(--macos-bg-tertiary);">
                <img id="detImg" src="" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.9;">
                <div
                    style="position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);">
                </div>

                <button onclick="closeDetailsModal()"
                    style="position:absolute; top:16px; right:16px; background:rgba(255,255,255,0.2); backdrop-filter:blur(4px); border:none; width:36px; height:36px; border-radius:50%; color:white; font-size:20px; cursor:pointer;">&times;</button>
                <div style="position: absolute; bottom: 20px; left: 24px; color: white;">
                    <div
                        style="background: var(--macos-accent); display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; margin-bottom: 8px;">
                        OPORTUNIDADE</div>
                    <h2 id="detTitle" style="margin:0; font-size: 28px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);"></h2>
                    <p id="detLoc"
                        style="margin:4px 0 0 0; font-size: 15px; opacity: 0.9; display:flex; align-items:center; gap:6px;">
                        <i class="fa-solid fa-location-dot"></i> <span></span>
                    </p>
                </div>
            </div>

            <div style="padding: 24px; background: var(--macos-bg-base);">

                <!-- Metrics Row -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 32px;">
                    <!-- Widget Lucro -->
                    <div
                        style="background: var(--macos-bg-secondary); padding: 16px; border-radius: 12px; border: 1px solid var(--macos-divider); position: relative; overflow: hidden;">
                        <div
                            style="position: absolute; top: -10px; right: -10px; width: 60px; height: 60px; background: rgba(39, 174, 96, 0.1); border-radius: 50%;">
                        </div>
                        <i class="fa-solid fa-sack-dollar"
                            style="color: #27ae60; font-size: 24px; margin-bottom: 12px; position:relative;"></i>
                        <p
                            style="font-size: 11px; text-transform: uppercase; color: var(--macos-text-secondary); font-weight: 600; margin:0;">
                            Lucro Estimado</p>
                        <p id="detLucro"
                            style="font-size: 22px; font-weight: 700; color: var(--macos-text-primary); margin:4px 0 0 0;">
                        </p>
                    </div>

                    <!-- Widget ROI -->
                    <div
                        style="background: var(--macos-bg-secondary); padding: 16px; border-radius: 12px; border: 1px solid var(--macos-divider);">
                        <i class="fa-solid fa-chart-line"
                            style="color: var(--macos-accent); font-size: 24px; margin-bottom: 12px;"></i>
                        <p
                            style="font-size: 11px; text-transform: uppercase; color: var(--macos-text-secondary); font-weight: 600; margin:0;">
                            Retorno (ROI)</p>
                        <p id="detRoi"
                            style="font-size: 22px; font-weight: 700; color: var(--macos-text-primary); margin:4px 0 0 0;">
                        </p>
                    </div>

                    <!-- Widget Venda -->
                    <div
                        style="background: var(--macos-bg-secondary); padding: 16px; border-radius: 12px; border: 1px solid var(--macos-divider);">
                        <i class="fa-solid fa-tag" style="color: #e67e22; font-size: 24px; margin-bottom: 12px;"></i>
                        <p
                            style="font-size: 11px; text-transform: uppercase; color: var(--macos-text-secondary); font-weight: 600; margin:0;">
                            Valor de Venda</p>
                        <p id="detVenda"
                            style="font-size: 22px; font-weight: 700; color: var(--macos-text-primary); margin:4px 0 0 0;">
                        </p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">
                    <div>
                        <h4 style="margin:0 0 16px 0; color:var(--macos-text-primary);">Documentação & Estudo</h4>
                        <div
                            style="background: var(--macos-bg-tertiary); border-radius: 8px; padding: 20px; text-align: center; border: 1px dashed var(--macos-divider); display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <a id="lnkProp" href="#" target="_blank" class="macos-btn-secondary"
                                style="display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%;">
                                <i class="fa-solid fa-file-pdf text-red-500"></i> Ver Estudo
                            </a>
                            <a id="lnkAnalise" href="#" target="_blank" class="macos-btn-secondary"
                                style="display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%;">
                                <i class="fa-solid fa-scale-balanced text-blue-500"></i> Ver Jurídico
                            </a>
                        </div>
                        <p
                            style="margin:8px 0 0 0; font-size: 11px; color: var(--macos-text-secondary); text-align: center;">
                            Documentos
                            anexados à oportunidade.</p>
                    </div>

                    <div>
                        <h4 style="margin:0 0 16px 0; color:var(--macos-text-primary);">Detalhes Financeiros</h4>
                        <div
                            style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px;">
                            <span style="color:var(--macos-text-secondary);">Lance Mínimo</span>
                            <span id="detLance" style="font-weight: 600; color:var(--macos-text-primary);"></span>
                        </div>

                        <div class="macos-divider" style="margin: 12px 0;"></div>

                        <!-- Botão Adicionar à Carteira -->
                        <button id="btnArrematar" class="macos-btn-primary"
                            style="width: 100%; background: var(--macos-accent); color: white; border: none;">
                            <i class="fa-solid fa-folder-plus mr-2" style="margin-right: 8px;"></i> Adicionar à Carteira
                        </button>
                        <p
                            style="font-size: 10px; color: var(--macos-text-secondary); margin-top: 8px; text-align: center;">
                            Selecione um cliente para vincular e iniciar o processo.
                        </p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        // --- DADOS ---
        let opportunities = [];
        try {
            opportunities = JSON.parse(document.getElementById('opportunities-raw-data').textContent);
        } catch (e) { console.error(e); }

        // --- MAPA ---
        let map, markersMap = new Map();

        function initMap() {
            // Se já inicializou, sai
            if (map) return;

            // Limites do Brasil (South West, North East)
            const brazilBounds = [
                [-35, -75], // SW (RS/Acre border approx)
                [6, -32]    // NE (Amapá/Noronha approx)
            ];

            // Cria o mapa restrito ao Brasil
            map = L.map('map-view', {
                zoomControl: false,
                scrollWheelZoom: true,  // Permite zoom com scroll/pinça
                touchZoom: true,        // Permite gestos de toque
                bounceAtZoomLimits: true,
                minZoom: 4,
                maxBounds: brazilBounds,
                maxBoundsViscosity: 0.8 // Um pouco mais elástico
            }).setView([-14.2, -51.9], 4);

            L.control.zoom({ position: 'bottomright' }).addTo(map);

            // Tiles Clean
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OSM &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            // Pins
            const bounds = [];
            opportunities.forEach(op => {
                if (op.latitude && op.longitude) {
                    const icon = L.divIcon({
                        className: 'custom-pin',
                        html: `<div id="pin-${op.id}" style="
                            width: 14px; height: 14px; 
                            background: var(--macos-accent); 
                            border: 2px solid white; 
                            border-radius: 50%; 
                            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                            transition: transform 0.2s;
                        "></div>`,
                        iconSize: [14, 14],
                        iconAnchor: [7, 7]
                    });

                    const marker = L.marker([op.latitude, op.longitude], { icon: icon }).addTo(map);

                    // Click Pin -> Scroll Lista
                    marker.on('click', () => {
                        const card = document.getElementById(`card-${op.id}`);
                        if (card) {
                            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            // Highlight visual
                            card.style.borderColor = 'var(--macos-accent)';
                            setTimeout(() => card.style.borderColor = '', 2000);
                        }
                    });

                    markersMap.set(op.id.toString(), marker);
                    bounds.push([op.latitude, op.longitude]);
                }
            });

            // --- BRAZIL BORDER (Linha Forte) ---
            fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries/BRA.geo.json')
                .then(r => r.json())
                .then(data => {
                    L.geoJSON(data, {
                        style: {
                            color: '#1a1a1a',      // Cor escura/forte
                            weight: 3,             // Espessura da linha
                            opacity: 0.8,          // Opacidade alta
                            fillColor: 'transparent',
                            fillOpacity: 0
                        }
                    }).addTo(map);
                })
                .catch(e => console.warn('Falha ao carregar fronteiras:', e));

            // Ajustar Zoom
            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50], maxZoom: 15 });
            }
        }

        // --- INTERAÇÕES ---
        window.focusOnMap = function (lat, lng, id) {
            if (!lat || !lng) return;
            map.flyTo([lat, lng], 15, { duration: 1.5 });
        }

        window.highlightPin = function (id) {
            const el = document.getElementById(`pin-${id}`);
            if (el) {
                el.style.transform = 'scale(1.8)';
                el.style.background = '#e74c3c';
                el.style.zIndex = 999;
            }
        }

        window.unhighlightPin = function (id) {
            const el = document.getElementById(`pin-${id}`);
            if (el) {
                el.style.transform = 'scale(1)';
                el.style.background = 'var(--macos-accent)';
                el.style.zIndex = 'auto';
            }
        }

        // --- MODAL LOGIC (ROBUST) ---
        // (Listener removido em favor de inline onclick para maior robustez)

        // Fechar com ESC
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.macos-modal-overlay').forEach(el => el.style.display = 'none');
            }
        });

        // --- FUNCÕES DE MODAL E FORM ---
        // (Reimplementação simplificada das funções essenciais)

        // --- NEW MODAL LOGIC (CLEAN) ---
        const modalAdd = document.getElementById('addModal');
        const btnAdd = document.getElementById('triggerAddOp');

        if (btnAdd && modalAdd) {
            btnAdd.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();

                // 1. Mostrar Modal imediatamente (CSS Class)
                modalAdd.classList.add('is-visible');

                // 2. Carregar dados em background (sem afetar UI)
                loadSavedCalculations();
            });
        }

        window.closeAddModal = function () {
            if (modalAdd) modalAdd.classList.remove('is-visible');
        }

        async function loadSavedCalculations() {
            try {
                const res = await fetch('/api/saved-calculations');
                const data = await res.json();
                const sel = document.getElementById('selCalculo');
                if (!sel) return;
                sel.innerHTML = '<option value="">Selecione para preencher...</option>';
                data.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name;
                    opt.dataset.json = c.data;
                    sel.appendChild(opt);
                });
            } catch (e) { console.log('Erro carregando calculos', e); }
        }

        function importarCalculo(id) {
            if (!id) return;
            const opt = document.querySelector(`#selCalculo option[value="${id}"]`);
            if (!opt) return;
            const data = JSON.parse(opt.dataset.json);

            document.getElementById('inpTitulo').value = opt.textContent;
            document.getElementById('invArremate').value = data.valorArremate || 0;
            document.getElementById('invVenda').value = data.valorVenda || 0;

            // Estimar Lucro simples
            const lucro = (data.valorVenda || 0) - (data.valorArremate || 0); // Simplificado
            document.getElementById('invLucro').value = lucro;

            // Tentar extrair cidade (heuristica)
            // ...
        }

        // --- ENDEREÇO & AUTOCOMPLETE ---
        let miniMap = null;
        let miniMarker = null;
        let debounceTimer = null;

        function handleAddressInput(query) {
            clearTimeout(debounceTimer);
            const dropdown = document.getElementById('addressSuggestions');

            if (query.length < 3) {
                dropdown.style.display = 'none';
                return;
            }

            debounceTimer = setTimeout(async () => {
                dropdown.innerHTML = '<div class="suggestion-item">Buscando...</div>';
                dropdown.style.display = 'block';

                try {
                    // Limita busca ao Brasil para melhor relevância
                    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=br&limit=5&addressdetails=1`;
                    const res = await fetch(url);
                    const data = await res.json();

                    dropdown.innerHTML = '';

                    if (data.length === 0) {
                        dropdown.innerHTML = '<div class="suggestion-item">Nenhum endereço encontrado.</div>';
                        return;
                    }

                    data.forEach(place => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        // Monta string amigável
                        const addr = place.address || {};
                        const display = `${addr.road || ''}, ${addr.house_number || ''} - ${addr.suburb || ''}, ${addr.city || addr.town || addr.municipality || ''} - ${addr.state || ''}`;
                        div.textContent = display.replace(/^, /, '').replace(/, ,/g, ','); // Limpeza basica

                        div.onclick = () => selectAddress(place);
                        dropdown.appendChild(div);
                    });
                } catch (e) {
                    console.error(e);
                    dropdown.style.display = 'none';
                }
            }, 600); // 600ms debounce
        }

        function selectAddress(place) {
            const dropdown = document.getElementById('addressSuggestions');
            dropdown.style.display = 'none';
            document.getElementById('inpBuscaEnd').value = place.display_name;

            // Preenche campos
            const addr = place.address || {};
            if (addr.city || addr.town || addr.municipality) {
                document.getElementById('inpCidade').value = addr.city || addr.town || addr.municipality;
            }
            // Tenta pegar UF (Nominatim retorna nome extenso as vezes, ideal seria mapping mas vamos simplificar)
            // O user pode corrigir manualmente

            // Set Lat/Lng
            updateLocation(place.lat, place.lon);
        }

        function updateLocation(lat, lng) {
            document.getElementById('inpLat').value = lat;
            document.getElementById('inpLng').value = lng;
            document.getElementById('miniMap').style.display = 'block';
            document.getElementById('mapHelpText').style.display = 'block';

            if (!miniMap) {
                miniMap = L.map('miniMap').setView([lat, lng], 16);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: 'OSM'
                }).addTo(miniMap);
            } else {
                miniMap.invalidateSize();
                miniMap.setView([lat, lng], 16);
            }

            if (miniMarker) miniMap.removeLayer(miniMarker);

            // Marcador arrastável
            miniMarker = L.marker([lat, lng], { draggable: true }).addTo(miniMap);

            miniMarker.on('dragend', function (e) {
                const pos = e.target.getLatLng();
                document.getElementById('inpLat').value = pos.lat;
                document.getElementById('inpLng').value = pos.lng;
            });
        }

        // Hide dropdown on click outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('addressSuggestions');
            const input = document.getElementById('inpBuscaEnd');
            if (e.target !== dropdown && e.target !== input) {
                dropdown.style.display = 'none';
            }
        });

        async function submitDetails(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            try {
                const res = await fetch('/oportunidades', { method: 'POST', body: formData });
                if (res.ok) window.location.reload();
                else alert('Erro ao salvar');
            } catch (err) { alert('Erro'); }
        }

        function updFile(inp, label) {
            if (inp.files[0]) inp.parentElement.classList.add('has-file');
        }

        // --- DELETE ---
        async function deleteOpportunity(id, e) {
            e.stopPropagation();
            if (!confirm('Apagar?')) return;
            await fetch(`/oportunidades/${id}`, { method: 'DELETE' });
            window.location.reload();
        }

        // --- OPEN DETAILS ---
        function openDetails(id) {
            const op = opportunities.find(o => o.id == id);
            if (!op) return;

            document.getElementById('detTitle').textContent = op.titulo;
            document.getElementById('detLoc').textContent = `${op.cidade} - ${op.estado}`;
            document.getElementById('detLucro').textContent = (op.lucro_estimado || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('detRoi').textContent = 'ROI: ' + (op.roi_estimado || 0).toFixed(0) + '%';

            document.getElementById('detVenda').textContent = (op.valor_venda || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            document.getElementById('detLance').textContent = (op.valor_arremate || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            const imgEl = document.getElementById('detImg');
            if (op.foto_capa) { imgEl.src = op.foto_capa; imgEl.style.display = 'block'; }
            else imgEl.style.display = 'none';

            const btnP = document.getElementById('lnkProp');
            // Reset state
            btnP.classList.remove('disabled');
            btnP.href = '#';

            if (op.pdf_proposta) {
                btnP.href = op.pdf_proposta;
                btnP.style.display = 'flex';
                btnP.innerHTML = '<i class="fa-solid fa-file-pdf text-red-500"></i> Ver Estudo de Viabilidade';
            } else {
                // Show disabled state instead of hiding
                btnP.style.display = 'flex';
                btnP.removeAttribute('href');
                btnP.innerHTML = '<i class="fa-solid fa-file-pdf" style="color:#999;"></i> Estudo Indisponível';
                btnP.style.opacity = '0.5';
                btnP.style.cursor = 'not-allowed';
            }

            const btnA = document.getElementById('lnkAnalise');
            // Reset state
            btnA.style.opacity = '1';
            btnA.style.cursor = 'pointer';
            btnA.href = '#';

            if (op.pdf_analise_juridica) {
                btnA.href = op.pdf_analise_juridica;
                btnA.style.display = 'flex';
                btnA.innerHTML = '<i class="fa-solid fa-scale-balanced text-blue-500"></i> Ver Análise Jurídica';
            } else {
                // Show disabled state instead of hiding
                btnA.style.display = 'flex';
                btnA.removeAttribute('href');
                btnA.innerHTML = '<i class="fa-solid fa-scale-balanced" style="color:#999;"></i> Análise Indisponível';
                btnA.style.opacity = '0.5';
                btnA.style.cursor = 'not-allowed';
            }

            // Configurar botão Arrematar
            const btnArrematar = document.getElementById('btnArrematar');
            btnArrematar.onclick = function () {
                // Open new Client Selection Modal
                openClientModal(op.id);
            };

            // Use setTimeout to skip current event loop cycle
            showDetailsModal();
        }

        // OPEN DETAILS LOGIC
        window.closeDetailsModal = function () {
            const m = document.getElementById('detailsModal');
            if (m) {
                m.classList.remove('is-visible');
                // Force remove style to avoid conflicts
                m.style.removeProperty('display');
                console.log('Details Modal Closed cleanly via Class');
            }
        };

        // Explicit Overlay Click Listener
        const dModal = document.getElementById('detailsModal');
        const dWindow = document.getElementById('detailsWindow');
        if (dModal && dWindow) {
            dModal.addEventListener('click', function (e) {
                if (e.target === dModal) {
                    closeDetailsModal();
                }
            });
            dWindow.addEventListener('click', function (e) { e.stopPropagation(); });
        }

        // Helper to Open
        window.showDetailsModal = function () {
            // Use setTimeout to skip current event loop cycle
            setTimeout(() => {
                const m = document.getElementById('detailsModal');
                if (m) {
                    m.classList.add('is-visible');
                }
            }, 10);
        }

        document.addEventListener('DOMContentLoaded', initMap);

    </script>
    <!-- CLIENT SELECTION MODAL -->
    <div id="clientSelectModal" class="macos-modal-overlay" style="z-index: 100000;">
        <div class="macos-window"
            style="width: 400px; max-width: 90%; background: var(--macos-bg-secondary); border-radius: 12px; padding: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.4);">
            <h3 style="margin-top:0; color: var(--macos-text-primary);">Selecionar Cliente</h3>
            <p style="font-size: 13px; color: var(--macos-text-secondary); margin-bottom: 16px;">
                Escolha para qual cliente você deseja adicionar este imóvel.
            </p>

            <select id="selClienteArremate" class="macos-input" style="width: 100%; margin-bottom: 20px;">
                <option value="">Carregando clientes...</option>
            </select>

            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button class="macos-btn-secondary" onclick="closeClientModal()">Cancelar</button>
                <button class="macos-btn-primary" onclick="confirmClientSelection()">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        // Global var to store current OP ID for client selection
        let currentOpIdForClient = null;

        function openClientModal(opId) {
            currentOpIdForClient = opId;
            const modal = document.getElementById('clientSelectModal');
            const select = document.getElementById('selClienteArremate');

            modal.classList.add('is-visible'); // Use same class logic
            modal.style.display = 'flex'; // Ensure flex rendering

            // Load Clients
            fetch('/api/clientes') // We need an endpoint ensuring json return
                .then(r => r.json())
                .then(data => {
                    select.innerHTML = '<option value="">Selecione um cliente...</option>';
                    if (data.clientes && data.clientes.length) {
                        data.clientes.forEach(c => {
                            const opt = document.createElement('option');
                            opt.value = c.id;
                            opt.textContent = c.nome;
                            select.appendChild(opt);
                        });
                    } else {
                        select.innerHTML = '<option value="">Nenhum cliente encontrado</option>';
                    }
                })
                .catch(e => {
                    console.error(e);
                    select.innerHTML = '<option value="">Erro ao carregar</option>';
                });
        }

        function closeClientModal() {
            const modal = document.getElementById('clientSelectModal');
            modal.classList.remove('is-visible');
            setTimeout(() => { modal.style.display = 'none'; }, 200);
            currentOpIdForClient = null;
        }

        async function confirmClientSelection() {
            const clientId = document.getElementById('selClienteArremate').value;
            if (!clientId) return alert('Selecione um cliente.');
            if (!currentOpIdForClient) return;

            try {
                // Send client_id in body
                const res = await fetch(`/api/oportunidades/${currentOpIdForClient}/arrematar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cliente_id: clientId })
                });
                const data = await res.json();

                if (data.success) {
                    alert(data.message);
                    closeClientModal();
                    window.location.reload();
                } else {
                    alert('Erro: ' + (data.error || 'Desconhecido'));
                }
            } catch (e) {
                console.error(e);
                alert('Erro de conexão.');
            }
        }
    </script>

    <script>
        // ... Existing scripts ...
    </script>
</body>

</html>