<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <title>Análise de Documentos</title>
    <%- include('partials/head') %>
        <style>
            .dropzone-area {
                border: 2px dashed var(--macos-divider);
                border-radius: 12px;
                padding: 32px;
                text-align: center;
                transition: all 0.2s;
                background: var(--macos-bg-tertiary);
                cursor: pointer;
                position: relative;
            }

            .dropzone-area:hover,
            .dropzone-area.dragover {
                border-color: var(--macos-accent);
                background: rgba(0, 122, 255, 0.05);
            }

            .dropzone-icon {
                font-size: 32px;
                color: var(--macos-text-secondary);
                margin-bottom: 12px;
            }

            .file-info {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px;
                background: var(--macos-bg-secondary);
                border: 1px solid var(--macos-divider);
                border-radius: 8px;
                margin-top: 12px;
            }

            .loading-overlay {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(255, 255, 255, 0.8);
                backdrop-filter: blur(4px);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 50;
                border-radius: 12px;
            }

            /* --- PREMIUM DOCUMENT TYPOGRAPHY V2 --- */
            .analysis-container {
                background: white;
                /* Clean white paper look */
                border: none;
                border-radius: 8px;
                padding: 60px;
                /* Generous padding like a real doc */
                box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
                max-width: 900px;
                margin: 0 auto;
                font-family: 'Inter', system-ui, -apple-system, sans-serif;
            }

            .markdown-content {
                color: #1f2937;
                /* Gray-900 */
                line-height: 1.6;
                font-size: 16px;
            }

            /* Main Title H1 */
            .markdown-content h1 {
                font-size: 28px;
                font-weight: 800;
                color: #111827;
                margin-top: 0;
                margin-bottom: 32px;
                padding-bottom: 16px;
                border-bottom: 2px solid #FFD60A;
                /* Brand Color Line */
                text-transform: uppercase;
                letter-spacing: -0.02em;
            }

            /* Section H2 */
            .markdown-content h2 {
                font-size: 20px;
                font-weight: 700;
                color: #111827;
                margin-top: 40px;
                margin-bottom: 20px;
                display: flex;
                align-items: center;
                gap: 10px;
                background: #f9fafb;
                padding: 12px 16px;
                border-left: 4px solid #FFD60A;
                border-radius: 4px;
            }

            .markdown-content h3 {
                font-size: 16px;
                font-weight: 600;
                color: #374151;
                margin-top: 24px;
                margin-bottom: 12px;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            /* Text Elements */
            /* Text Elements */
            .markdown-content p {
                margin-bottom: 24px;
                /* Increased from 16px */
                color: #4b5563;
                /* Gray-600 */
                text-align: left;
                line-height: 1.8;
                /* Increased from 1.7 */
            }

            .markdown-content ul,
            .markdown-content ol {
                margin-bottom: 32px;
                /* Increased from 24px */
                padding-left: 20px;
            }

            .markdown-content li {
                margin-bottom: 14px;
                /* Increased from 8px */
                padding-left: 8px;
                color: #4b5563;
                line-height: 1.7;
            }

            .markdown-content li::marker {
                color: #FFD60A;
                font-weight: bold;
            }

            /* TABLES - CRITICAL FIX */
            .table-wrapper {
                overflow-x: auto;
                margin: 24px 0;
                border-radius: 8px;
                border: 1px solid #e5e7eb;
            }

            .markdown-content table {
                width: 100%;
                border-collapse: collapse;
                /* Better than separate for dense data */
                font-size: 14px;
                min-width: 600px;
                /* Ensure it doesn't squish too much */
            }

            .markdown-content th {
                background-color: #f3f4f6;
                color: #111827;
                font-weight: 700;
                text-align: left;
                padding: 12px 16px;
                border-bottom: 2px solid #e5e7eb;
                text-transform: uppercase;
                font-size: 12px;
                letter-spacing: 0.05em;
            }

            .markdown-content td {
                padding: 14px 16px;
                border-bottom: 1px solid #f3f4f6;
                color: #374151;
                vertical-align: top;
            }

            .markdown-content tr:last-child td {
                border-bottom: none;
            }

            .markdown-content tr:hover td {
                background-color: #f9fafb;
            }

            /* Highlighting & Alerts */
            .markdown-content strong {
                color: #111827;
                font-weight: 700;
                background: linear-gradient(120deg, rgba(255, 214, 10, 0.3) 0%, rgba(255, 214, 10, 0.3) 100%);
                background-repeat: no-repeat;
                background-size: 100% 40%;
                background-position: 0 88%;
            }

            .markdown-content blockquote {
                background: #fffbeb;
                /* Amber-50 */
                border-left: 4px solid #f59e0b;
                /* Amber-500 */
                color: #92400e;
                padding: 16px;
                margin: 24px 0;
                border-radius: 0 8px 8px 0;
                font-style: italic;
            }

            /* Dark Mode Support (Basic) */
            html.dark .analysis-container {
                background: #1f2937;
                border-color: #374151;
            }

            html.dark .markdown-content {
                color: #d1d5db;
            }

            html.dark .markdown-content h1,
            html.dark .markdown-content h2,
            html.dark .markdown-content strong {
                color: white;
            }

            html.dark .markdown-content h2 {
                background: #374151;
            }

            html.dark .markdown-content th {
                background: #374151;
                color: white;
                border-color: #4b5563;
            }

            html.dark .markdown-content td {
                border-color: #374151;
                color: #d1d5db;
            }

            html.dark .markdown-content tr:hover td {
                background: #374151;
            }
        </style>
</head>

<body class="min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
    <%- include('partials/macos-toolbar', { title: 'Análise de Documentos' }) %>
        <%- include('partials/macos-sidebar', { user: user }) %>

            <main class="macos-main-content">
                <div class="page-container" style="max-width: 1100px; margin: 0 auto; padding: 24px;">

                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h1 class="text-2xl font-bold dark:text-white">Análise Jurídica com IA</h1>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">Envie o Edital e a Matrícula para gerar
                                um parecer executivo simplificado.</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <!-- Edital Upload -->
                        <div class="analysis-card relative">
                            <h3 class="font-semibold mb-4 dark:text-white flex items-center gap-2">
                                <i class="fa-regular fa-file-pdf text-red-500"></i> 1. Edital do Leilão
                            </h3>
                            <div class="dropzone-area" id="dropzone-edital"
                                onclick="document.getElementById('file-edital').click()">
                                <i class="fa-solid fa-cloud-arrow-up dropzone-icon"></i>
                                <p class="text-sm text-gray-600 dark:text-gray-300">Clique ou arraste o Edital</p>
                                <input type="file" id="file-edital" class="hidden" accept=".pdf"
                                    onchange="handleFileSelect('edital', this)">
                            </div>
                            <div id="preview-edital" class="hidden"></div>
                        </div>

                        <!-- Matricula Upload -->
                        <div class="analysis-card relative">
                            <h3 class="font-semibold mb-4 dark:text-white flex items-center gap-2">
                                <i class="fa-regular fa-file-lines text-blue-500"></i> 2. Matrícula do Imóvel
                            </h3>
                            <div class="dropzone-area" id="dropzone-matricula"
                                onclick="document.getElementById('file-matricula').click()">
                                <i class="fa-solid fa-cloud-arrow-up dropzone-icon"></i>
                                <p class="text-sm text-gray-600 dark:text-gray-300">Clique ou arraste a Matrícula</p>
                                <input type="file" id="file-matricula" class="hidden" accept=".pdf"
                                    onchange="handleFileSelect('matricula', this)">
                            </div>
                            <div id="preview-matricula" class="hidden"></div>
                        </div>
                    </div>

                    <!-- Action Button -->
                    <div class="flex justify-center mb-10">
                        <button onclick="startAnalysis()" id="btn-analyze"
                            class="macos-btn-primary px-10 py-4 text-lg font-semibold flex items-center gap-3 opacity-50 cursor-not-allowed shadow-none transform transition-all duration-200"
                            disabled>
                            <i class="fa-solid fa-wand-magic-sparkles"></i>
                            Gerar Análise com IA
                        </button>
                    </div>

                    <!-- Results Section -->
                    <!-- Results Section -->
                    <div id="result-section" class="hidden animate-fade-in relative min-h-[200px]">

                        <!-- Header with Actions -->
                        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <h2 class="text-xl font-bold dark:text-white flex items-center gap-2">
                                <i class="fa-solid fa-scale-balanced text-blue-500"></i>
                                Parecer Jurídico
                            </h2>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="downloadPDF()"
                                    class="macos-btn-primary text-sm flex items-center gap-2">
                                    <i class="fa-solid fa-file-arrow-down"></i> Baixar PDF
                                </button>
                                <button onclick="window.print()"
                                    class="macos-btn-secondary text-sm flex items-center gap-2">
                                    <i class="fa-solid fa-print"></i> Imprimir
                                </button>
                                <button onclick="copyAnalysis()"
                                    class="macos-btn-secondary text-sm flex items-center gap-2">
                                    <i class="fa-regular fa-copy"></i> Copiar
                                </button>
                            </div>
                        </div>

                        <!-- Rendered Content Container -->
                        <div id="analysis-content" class="w-full analysis-container">
                            <!-- JS will inject markdown here -->
                        </div>

                        <!-- Loading Overlay -->
                        <div id="loading-overlay" class="loading-overlay hidden">
                            <div class="animate-spin rounded-full h-14 w-14 border-b-2 border-blue-600 mb-6"></div>
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Analisando Documentos...
                            </h3>
                            <p class="text-gray-500 dark:text-gray-400">A IA está lendo o Edital e a Matrícula para
                                identificar riscos.</p>
                        </div>
                    </div>

                </div>
            </main>

            <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
            <script>
                async function downloadPDF() {
                    const element = document.getElementById('analysis-content');
                    const btn = document.querySelector('button[onclick="downloadPDF()"]');
                    const originalText = btn.innerHTML;

                    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Gerando...';
                    btn.disabled = true;

                    const opt = {
                        margin: [15, 15, 15, 15], // top, left, bottom, right
                        filename: 'Parecer_Juridico_Imovel.pdf',
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                    };

                    try {
                        await html2pdf().set(opt).from(element).save();
                    } catch (err) {
                        console.error("Erro ao gerar PDF:", err);
                        alert("Erro ao gerar PDF.");
                    } finally {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                }

                const files = {
                    edital: null,
                    matricula: null
                };

                function handleFileSelect(type, input) {
                    if (input.files && input.files[0]) {
                        const file = input.files[0];
                        files[type] = file;

                        // Update UI
                        const dropzone = document.getElementById(`dropzone-${type}`);
                        const preview = document.getElementById(`preview-${type}`);

                        dropzone.classList.add('hidden');
                        preview.classList.remove('hidden');
                        preview.innerHTML = `
                    <div class="file-info animate-scale-in">
                        <i class="fa-solid fa-check-circle text-green-500 text-xl"></i>
                        <div class="flex-grow min-w-0">
                            <p class="font-medium truncate text-sm dark:text-white">${file.name}</p>
                            <p class="text-xs text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                        </div>
                        <button onclick="resetFile('${type}')" class="text-gray-400 hover:text-red-500 p-2">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                `;

                        checkForm();
                    }
                }

                function resetFile(type) {
                    files[type] = null;
                    document.getElementById(`file-${type}`).value = '';
                    document.getElementById(`dropzone-${type}`).classList.remove('hidden');
                    document.getElementById(`preview-${type}`).classList.add('hidden');
                    checkForm();
                }

                function checkForm() {
                    const btn = document.getElementById('btn-analyze');
                    if (files.edital && files.matricula) {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed', 'shadow-none');
                        btn.classList.add('shadow-xl', 'hover:scale-105');
                    } else {
                        btn.disabled = true;
                        btn.classList.add('opacity-50', 'cursor-not-allowed', 'shadow-none');
                        btn.classList.remove('shadow-xl', 'hover:scale-105');
                    }
                }

                async function startAnalysis() {
                    if (!files.edital || !files.matricula) return;

                    const resultSection = document.getElementById('result-section');
                    const loadingOverlay = document.getElementById('loading-overlay');
                    const analysisContent = document.getElementById('analysis-content');
                    const btn = document.getElementById('btn-analyze');

                    // Show loading state
                    resultSection.classList.remove('hidden');
                    loadingOverlay.classList.remove('hidden');
                    analysisContent.innerHTML = '';
                    btn.disabled = true;
                    btn.classList.add('opacity-50');

                    resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

                    const formData = new FormData();
                    formData.append('edital', files.edital);
                    formData.append('matricula', files.matricula);

                    try {
                        const response = await fetch('/api/analise-documentos/process', {
                            method: 'POST',
                            body: formData
                        });

                        const data = await response.json();

                        if (!response.ok) throw new Error(data.error || 'Erro na análise');

                        const markdownText = data.analysis || data.output || data.text || "Análise concluída, mas nenhum texto foi retornado.";

                        // Enhanced Rendering: Wrap tables in div
                        const dirtyHtml = marked.parse(markdownText);

                        // Parse HTML string to DOM to manipulate
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(dirtyHtml, 'text/html');

                        // Wrap tables
                        doc.querySelectorAll('table').forEach(table => {
                            const wrapper = document.createElement('div');
                            wrapper.className = 'table-wrapper';
                            table.parentNode.insertBefore(wrapper, table);
                            wrapper.appendChild(table);
                        });

                        analysisContent.innerHTML = doc.body.innerHTML;

                    } catch (error) {
                        console.error(error);
                        analysisContent.innerHTML = `
                            <div class="p-6 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 rounded-xl flex items-center gap-4">
                                <i class="fa-solid fa-triangle-exclamation text-2xl"></i>
                                <div>
                                    <h3 class="font-bold text-lg">Erro na Análise</h3>
                                    <p>${error.message}</p>
                                </div>
                            </div>
                        `;
                    } finally {
                        loadingOverlay.classList.add('hidden');
                        btn.disabled = false;
                        btn.classList.remove('opacity-50');
                    }
                }

                function copyAnalysis() {
                    const content = document.getElementById('analysis-content').innerText;
                    navigator.clipboard.writeText(content).then(() => {
                        alert('Análise copiada!');
                    });
                }
            </script>
</body>

</html>